begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|snapshot
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|DataInput
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|DataOutput
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileNotFoundException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Comparator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ExecutionException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ExecutorService
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Executors
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Future
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|function
operator|.
name|BiConsumer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FSDataInputStream
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FSDataOutputStream
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FileChecksum
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FileStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FileSystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|permission
operator|.
name|FsPermission
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|HBaseConfiguration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|HConstants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|TableName
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|RegionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|io
operator|.
name|FileLink
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|io
operator|.
name|HFileLink
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|io
operator|.
name|WALLink
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|io
operator|.
name|hadoopbackport
operator|.
name|ThrottledInputStream
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|mapreduce
operator|.
name|TableMapReduceUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|mob
operator|.
name|MobUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|util
operator|.
name|AbstractHBaseTool
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|util
operator|.
name|FSUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|util
operator|.
name|HFileArchiveUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|util
operator|.
name|Pair
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|BytesWritable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|IOUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|NullWritable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|Writable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapreduce
operator|.
name|InputFormat
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapreduce
operator|.
name|InputSplit
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapreduce
operator|.
name|Job
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapreduce
operator|.
name|JobContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapreduce
operator|.
name|Mapper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapreduce
operator|.
name|RecordReader
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapreduce
operator|.
name|TaskAttemptContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapreduce
operator|.
name|lib
operator|.
name|output
operator|.
name|NullOutputFormat
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapreduce
operator|.
name|security
operator|.
name|TokenCache
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|StringUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|Tool
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|yetus
operator|.
name|audience
operator|.
name|InterfaceAudience
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hbase
operator|.
name|thirdparty
operator|.
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|cli
operator|.
name|CommandLine
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hbase
operator|.
name|thirdparty
operator|.
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|cli
operator|.
name|Option
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|SnapshotProtos
operator|.
name|SnapshotDescription
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|SnapshotProtos
operator|.
name|SnapshotFileInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|SnapshotProtos
operator|.
name|SnapshotRegionManifest
import|;
end_import

begin_comment
comment|/**  * Export the specified snapshot to a given FileSystem.  *  * The .snapshot/name folder is copied to the destination cluster  * and then all the hfiles/wals are copied using a Map-Reduce Job in the .archive/ location.  * When everything is done, the second cluster can restore the snapshot.  */
end_comment

begin_class
annotation|@
name|InterfaceAudience
operator|.
name|Public
specifier|public
class|class
name|ExportSnapshot
extends|extends
name|AbstractHBaseTool
implements|implements
name|Tool
block|{
specifier|public
specifier|static
specifier|final
name|String
name|NAME
init|=
literal|"exportsnapshot"
decl_stmt|;
comment|/** Configuration prefix for overrides for the source filesystem */
specifier|public
specifier|static
specifier|final
name|String
name|CONF_SOURCE_PREFIX
init|=
name|NAME
operator|+
literal|".from."
decl_stmt|;
comment|/** Configuration prefix for overrides for the destination filesystem */
specifier|public
specifier|static
specifier|final
name|String
name|CONF_DEST_PREFIX
init|=
name|NAME
operator|+
literal|".to."
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|Logger
name|LOG
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|ExportSnapshot
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|MR_NUM_MAPS
init|=
literal|"mapreduce.job.maps"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|CONF_NUM_SPLITS
init|=
literal|"snapshot.export.format.splits"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|CONF_SNAPSHOT_NAME
init|=
literal|"snapshot.export.format.snapshot.name"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|CONF_SNAPSHOT_DIR
init|=
literal|"snapshot.export.format.snapshot.dir"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|CONF_FILES_USER
init|=
literal|"snapshot.export.files.attributes.user"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|CONF_FILES_GROUP
init|=
literal|"snapshot.export.files.attributes.group"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|CONF_FILES_MODE
init|=
literal|"snapshot.export.files.attributes.mode"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|CONF_CHECKSUM_VERIFY
init|=
literal|"snapshot.export.checksum.verify"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|CONF_OUTPUT_ROOT
init|=
literal|"snapshot.export.output.root"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|CONF_INPUT_ROOT
init|=
literal|"snapshot.export.input.root"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|CONF_BUFFER_SIZE
init|=
literal|"snapshot.export.buffer.size"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|CONF_MAP_GROUP
init|=
literal|"snapshot.export.default.map.group"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|CONF_BANDWIDTH_MB
init|=
literal|"snapshot.export.map.bandwidth.mb"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|CONF_MR_JOB_NAME
init|=
literal|"mapreduce.job.name"
decl_stmt|;
specifier|protected
specifier|static
specifier|final
name|String
name|CONF_SKIP_TMP
init|=
literal|"snapshot.export.skip.tmp"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|CONF_COPY_MANIFEST_THREADS
init|=
literal|"snapshot.export.copy.references.threads"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|int
name|DEFAULT_COPY_MANIFEST_THREADS
init|=
name|Runtime
operator|.
name|getRuntime
argument_list|()
operator|.
name|availableProcessors
argument_list|()
decl_stmt|;
specifier|static
class|class
name|Testing
block|{
specifier|static
specifier|final
name|String
name|CONF_TEST_FAILURE
init|=
literal|"test.snapshot.export.failure"
decl_stmt|;
specifier|static
specifier|final
name|String
name|CONF_TEST_FAILURE_COUNT
init|=
literal|"test.snapshot.export.failure.count"
decl_stmt|;
name|int
name|failuresCountToInject
init|=
literal|0
decl_stmt|;
name|int
name|injectedFailureCount
init|=
literal|0
decl_stmt|;
block|}
comment|// Command line options and defaults.
specifier|static
specifier|final
class|class
name|Options
block|{
specifier|static
specifier|final
name|Option
name|SNAPSHOT
init|=
operator|new
name|Option
argument_list|(
literal|null
argument_list|,
literal|"snapshot"
argument_list|,
literal|true
argument_list|,
literal|"Snapshot to restore."
argument_list|)
decl_stmt|;
specifier|static
specifier|final
name|Option
name|TARGET_NAME
init|=
operator|new
name|Option
argument_list|(
literal|null
argument_list|,
literal|"target"
argument_list|,
literal|true
argument_list|,
literal|"Target name for the snapshot."
argument_list|)
decl_stmt|;
specifier|static
specifier|final
name|Option
name|COPY_TO
init|=
operator|new
name|Option
argument_list|(
literal|null
argument_list|,
literal|"copy-to"
argument_list|,
literal|true
argument_list|,
literal|"Remote "
operator|+
literal|"destination hdfs://"
argument_list|)
decl_stmt|;
specifier|static
specifier|final
name|Option
name|COPY_FROM
init|=
operator|new
name|Option
argument_list|(
literal|null
argument_list|,
literal|"copy-from"
argument_list|,
literal|true
argument_list|,
literal|"Input folder hdfs:// (default hbase.rootdir)"
argument_list|)
decl_stmt|;
specifier|static
specifier|final
name|Option
name|NO_CHECKSUM_VERIFY
init|=
operator|new
name|Option
argument_list|(
literal|null
argument_list|,
literal|"no-checksum-verify"
argument_list|,
literal|false
argument_list|,
literal|"Do not verify checksum, use name+length only."
argument_list|)
decl_stmt|;
specifier|static
specifier|final
name|Option
name|NO_TARGET_VERIFY
init|=
operator|new
name|Option
argument_list|(
literal|null
argument_list|,
literal|"no-target-verify"
argument_list|,
literal|false
argument_list|,
literal|"Do not verify the integrity of the exported snapshot."
argument_list|)
decl_stmt|;
specifier|static
specifier|final
name|Option
name|OVERWRITE
init|=
operator|new
name|Option
argument_list|(
literal|null
argument_list|,
literal|"overwrite"
argument_list|,
literal|false
argument_list|,
literal|"Rewrite the snapshot manifest if already exists."
argument_list|)
decl_stmt|;
specifier|static
specifier|final
name|Option
name|CHUSER
init|=
operator|new
name|Option
argument_list|(
literal|null
argument_list|,
literal|"chuser"
argument_list|,
literal|true
argument_list|,
literal|"Change the owner of the files to the specified one."
argument_list|)
decl_stmt|;
specifier|static
specifier|final
name|Option
name|CHGROUP
init|=
operator|new
name|Option
argument_list|(
literal|null
argument_list|,
literal|"chgroup"
argument_list|,
literal|true
argument_list|,
literal|"Change the group of the files to the specified one."
argument_list|)
decl_stmt|;
specifier|static
specifier|final
name|Option
name|CHMOD
init|=
operator|new
name|Option
argument_list|(
literal|null
argument_list|,
literal|"chmod"
argument_list|,
literal|true
argument_list|,
literal|"Change the permission of the files to the specified one."
argument_list|)
decl_stmt|;
specifier|static
specifier|final
name|Option
name|MAPPERS
init|=
operator|new
name|Option
argument_list|(
literal|null
argument_list|,
literal|"mappers"
argument_list|,
literal|true
argument_list|,
literal|"Number of mappers to use during the copy (mapreduce.job.maps)."
argument_list|)
decl_stmt|;
specifier|static
specifier|final
name|Option
name|BANDWIDTH
init|=
operator|new
name|Option
argument_list|(
literal|null
argument_list|,
literal|"bandwidth"
argument_list|,
literal|true
argument_list|,
literal|"Limit bandwidth to this value in MB/second."
argument_list|)
decl_stmt|;
block|}
comment|// Export Map-Reduce Counters, to keep track of the progress
specifier|public
enum|enum
name|Counter
block|{
name|MISSING_FILES
block|,
name|FILES_COPIED
block|,
name|FILES_SKIPPED
block|,
name|COPY_FAILED
block|,
name|BYTES_EXPECTED
block|,
name|BYTES_SKIPPED
block|,
name|BYTES_COPIED
block|}
specifier|private
specifier|static
class|class
name|ExportMapper
extends|extends
name|Mapper
argument_list|<
name|BytesWritable
argument_list|,
name|NullWritable
argument_list|,
name|NullWritable
argument_list|,
name|NullWritable
argument_list|>
block|{
specifier|private
specifier|static
specifier|final
name|Logger
name|LOG
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|ExportMapper
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|final
specifier|static
name|int
name|REPORT_SIZE
init|=
literal|1
operator|*
literal|1024
operator|*
literal|1024
decl_stmt|;
specifier|final
specifier|static
name|int
name|BUFFER_SIZE
init|=
literal|64
operator|*
literal|1024
decl_stmt|;
specifier|private
name|boolean
name|verifyChecksum
decl_stmt|;
specifier|private
name|String
name|filesGroup
decl_stmt|;
specifier|private
name|String
name|filesUser
decl_stmt|;
specifier|private
name|short
name|filesMode
decl_stmt|;
specifier|private
name|int
name|bufferSize
decl_stmt|;
specifier|private
name|FileSystem
name|outputFs
decl_stmt|;
specifier|private
name|Path
name|outputArchive
decl_stmt|;
specifier|private
name|Path
name|outputRoot
decl_stmt|;
specifier|private
name|FileSystem
name|inputFs
decl_stmt|;
specifier|private
name|Path
name|inputArchive
decl_stmt|;
specifier|private
name|Path
name|inputRoot
decl_stmt|;
specifier|private
specifier|static
name|Testing
name|testing
init|=
operator|new
name|Testing
argument_list|()
decl_stmt|;
annotation|@
name|Override
specifier|public
name|void
name|setup
parameter_list|(
name|Context
name|context
parameter_list|)
throws|throws
name|IOException
block|{
name|Configuration
name|conf
init|=
name|context
operator|.
name|getConfiguration
argument_list|()
decl_stmt|;
name|Configuration
name|srcConf
init|=
name|HBaseConfiguration
operator|.
name|createClusterConf
argument_list|(
name|conf
argument_list|,
literal|null
argument_list|,
name|CONF_SOURCE_PREFIX
argument_list|)
decl_stmt|;
name|Configuration
name|destConf
init|=
name|HBaseConfiguration
operator|.
name|createClusterConf
argument_list|(
name|conf
argument_list|,
literal|null
argument_list|,
name|CONF_DEST_PREFIX
argument_list|)
decl_stmt|;
name|verifyChecksum
operator|=
name|conf
operator|.
name|getBoolean
argument_list|(
name|CONF_CHECKSUM_VERIFY
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|filesGroup
operator|=
name|conf
operator|.
name|get
argument_list|(
name|CONF_FILES_GROUP
argument_list|)
expr_stmt|;
name|filesUser
operator|=
name|conf
operator|.
name|get
argument_list|(
name|CONF_FILES_USER
argument_list|)
expr_stmt|;
name|filesMode
operator|=
operator|(
name|short
operator|)
name|conf
operator|.
name|getInt
argument_list|(
name|CONF_FILES_MODE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|outputRoot
operator|=
operator|new
name|Path
argument_list|(
name|conf
operator|.
name|get
argument_list|(
name|CONF_OUTPUT_ROOT
argument_list|)
argument_list|)
expr_stmt|;
name|inputRoot
operator|=
operator|new
name|Path
argument_list|(
name|conf
operator|.
name|get
argument_list|(
name|CONF_INPUT_ROOT
argument_list|)
argument_list|)
expr_stmt|;
name|inputArchive
operator|=
operator|new
name|Path
argument_list|(
name|inputRoot
argument_list|,
name|HConstants
operator|.
name|HFILE_ARCHIVE_DIRECTORY
argument_list|)
expr_stmt|;
name|outputArchive
operator|=
operator|new
name|Path
argument_list|(
name|outputRoot
argument_list|,
name|HConstants
operator|.
name|HFILE_ARCHIVE_DIRECTORY
argument_list|)
expr_stmt|;
try|try
block|{
name|srcConf
operator|.
name|setBoolean
argument_list|(
literal|"fs."
operator|+
name|inputRoot
operator|.
name|toUri
argument_list|()
operator|.
name|getScheme
argument_list|()
operator|+
literal|".impl.disable.cache"
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|inputFs
operator|=
name|FileSystem
operator|.
name|get
argument_list|(
name|inputRoot
operator|.
name|toUri
argument_list|()
argument_list|,
name|srcConf
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Could not get the input FileSystem with root="
operator|+
name|inputRoot
argument_list|,
name|e
argument_list|)
throw|;
block|}
try|try
block|{
name|destConf
operator|.
name|setBoolean
argument_list|(
literal|"fs."
operator|+
name|outputRoot
operator|.
name|toUri
argument_list|()
operator|.
name|getScheme
argument_list|()
operator|+
literal|".impl.disable.cache"
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|outputFs
operator|=
name|FileSystem
operator|.
name|get
argument_list|(
name|outputRoot
operator|.
name|toUri
argument_list|()
argument_list|,
name|destConf
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Could not get the output FileSystem with root="
operator|+
name|outputRoot
argument_list|,
name|e
argument_list|)
throw|;
block|}
comment|// Use the default block size of the outputFs if bigger
name|int
name|defaultBlockSize
init|=
name|Math
operator|.
name|max
argument_list|(
operator|(
name|int
operator|)
name|outputFs
operator|.
name|getDefaultBlockSize
argument_list|(
name|outputRoot
argument_list|)
argument_list|,
name|BUFFER_SIZE
argument_list|)
decl_stmt|;
name|bufferSize
operator|=
name|conf
operator|.
name|getInt
argument_list|(
name|CONF_BUFFER_SIZE
argument_list|,
name|defaultBlockSize
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Using bufferSize="
operator|+
name|StringUtils
operator|.
name|humanReadableInt
argument_list|(
name|bufferSize
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|Counter
name|c
range|:
name|Counter
operator|.
name|values
argument_list|()
control|)
block|{
name|context
operator|.
name|getCounter
argument_list|(
name|c
argument_list|)
operator|.
name|increment
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|context
operator|.
name|getConfiguration
argument_list|()
operator|.
name|getBoolean
argument_list|(
name|Testing
operator|.
name|CONF_TEST_FAILURE
argument_list|,
literal|false
argument_list|)
condition|)
block|{
name|testing
operator|.
name|failuresCountToInject
operator|=
name|conf
operator|.
name|getInt
argument_list|(
name|Testing
operator|.
name|CONF_TEST_FAILURE_COUNT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|// Get number of times we have already injected failure based on attempt number of this
comment|// task.
name|testing
operator|.
name|injectedFailureCount
operator|=
name|context
operator|.
name|getTaskAttemptID
argument_list|()
operator|.
name|getId
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Override
specifier|protected
name|void
name|cleanup
parameter_list|(
name|Context
name|context
parameter_list|)
block|{
name|IOUtils
operator|.
name|closeStream
argument_list|(
name|inputFs
argument_list|)
expr_stmt|;
name|IOUtils
operator|.
name|closeStream
argument_list|(
name|outputFs
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|map
parameter_list|(
name|BytesWritable
name|key
parameter_list|,
name|NullWritable
name|value
parameter_list|,
name|Context
name|context
parameter_list|)
throws|throws
name|InterruptedException
throws|,
name|IOException
block|{
name|SnapshotFileInfo
name|inputInfo
init|=
name|SnapshotFileInfo
operator|.
name|parseFrom
argument_list|(
name|key
operator|.
name|copyBytes
argument_list|()
argument_list|)
decl_stmt|;
name|Path
name|outputPath
init|=
name|getOutputPath
argument_list|(
name|inputInfo
argument_list|)
decl_stmt|;
name|copyFile
argument_list|(
name|context
argument_list|,
name|inputInfo
argument_list|,
name|outputPath
argument_list|)
expr_stmt|;
block|}
comment|/**      * Returns the location where the inputPath will be copied.      */
specifier|private
name|Path
name|getOutputPath
parameter_list|(
specifier|final
name|SnapshotFileInfo
name|inputInfo
parameter_list|)
throws|throws
name|IOException
block|{
name|Path
name|path
init|=
literal|null
decl_stmt|;
switch|switch
condition|(
name|inputInfo
operator|.
name|getType
argument_list|()
condition|)
block|{
case|case
name|HFILE
case|:
name|Path
name|inputPath
init|=
operator|new
name|Path
argument_list|(
name|inputInfo
operator|.
name|getHfile
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|family
init|=
name|inputPath
operator|.
name|getParent
argument_list|()
operator|.
name|getName
argument_list|()
decl_stmt|;
name|TableName
name|table
init|=
name|HFileLink
operator|.
name|getReferencedTableName
argument_list|(
name|inputPath
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|region
init|=
name|HFileLink
operator|.
name|getReferencedRegionName
argument_list|(
name|inputPath
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|hfile
init|=
name|HFileLink
operator|.
name|getReferencedHFileName
argument_list|(
name|inputPath
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
name|path
operator|=
operator|new
name|Path
argument_list|(
name|FSUtils
operator|.
name|getTableDir
argument_list|(
operator|new
name|Path
argument_list|(
literal|"./"
argument_list|)
argument_list|,
name|table
argument_list|)
argument_list|,
operator|new
name|Path
argument_list|(
name|region
argument_list|,
operator|new
name|Path
argument_list|(
name|family
argument_list|,
name|hfile
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|WAL
case|:
name|LOG
operator|.
name|warn
argument_list|(
literal|"snapshot does not keeps WALs: "
operator|+
name|inputInfo
argument_list|)
expr_stmt|;
break|break;
default|default:
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Invalid File Type: "
operator|+
name|inputInfo
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
throw|;
block|}
return|return
operator|new
name|Path
argument_list|(
name|outputArchive
argument_list|,
name|path
argument_list|)
return|;
block|}
comment|/**      * Used by TestExportSnapshot to test for retries when failures happen.      * Failure is injected in {@link #copyFile(Context, SnapshotFileInfo, Path)}.      */
specifier|private
name|void
name|injectTestFailure
parameter_list|(
specifier|final
name|Context
name|context
parameter_list|,
specifier|final
name|SnapshotFileInfo
name|inputInfo
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
operator|!
name|context
operator|.
name|getConfiguration
argument_list|()
operator|.
name|getBoolean
argument_list|(
name|Testing
operator|.
name|CONF_TEST_FAILURE
argument_list|,
literal|false
argument_list|)
condition|)
return|return;
if|if
condition|(
name|testing
operator|.
name|injectedFailureCount
operator|>=
name|testing
operator|.
name|failuresCountToInject
condition|)
return|return;
name|testing
operator|.
name|injectedFailureCount
operator|++
expr_stmt|;
name|context
operator|.
name|getCounter
argument_list|(
name|Counter
operator|.
name|COPY_FAILED
argument_list|)
operator|.
name|increment
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Injecting failure. Count: "
operator|+
name|testing
operator|.
name|injectedFailureCount
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"TEST FAILURE (%d of max %d): Unable to copy input=%s"
argument_list|,
name|testing
operator|.
name|injectedFailureCount
argument_list|,
name|testing
operator|.
name|failuresCountToInject
argument_list|,
name|inputInfo
argument_list|)
argument_list|)
throw|;
block|}
specifier|private
name|void
name|copyFile
parameter_list|(
specifier|final
name|Context
name|context
parameter_list|,
specifier|final
name|SnapshotFileInfo
name|inputInfo
parameter_list|,
specifier|final
name|Path
name|outputPath
parameter_list|)
throws|throws
name|IOException
block|{
comment|// Get the file information
name|FileStatus
name|inputStat
init|=
name|getSourceFileStatus
argument_list|(
name|context
argument_list|,
name|inputInfo
argument_list|)
decl_stmt|;
comment|// Verify if the output file exists and is the same that we want to copy
if|if
condition|(
name|outputFs
operator|.
name|exists
argument_list|(
name|outputPath
argument_list|)
condition|)
block|{
name|FileStatus
name|outputStat
init|=
name|outputFs
operator|.
name|getFileStatus
argument_list|(
name|outputPath
argument_list|)
decl_stmt|;
if|if
condition|(
name|outputStat
operator|!=
literal|null
operator|&&
name|sameFile
argument_list|(
name|inputStat
argument_list|,
name|outputStat
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Skip copy "
operator|+
name|inputStat
operator|.
name|getPath
argument_list|()
operator|+
literal|" to "
operator|+
name|outputPath
operator|+
literal|", same file."
argument_list|)
expr_stmt|;
name|context
operator|.
name|getCounter
argument_list|(
name|Counter
operator|.
name|FILES_SKIPPED
argument_list|)
operator|.
name|increment
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|context
operator|.
name|getCounter
argument_list|(
name|Counter
operator|.
name|BYTES_SKIPPED
argument_list|)
operator|.
name|increment
argument_list|(
name|inputStat
operator|.
name|getLen
argument_list|()
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|InputStream
name|in
init|=
name|openSourceFile
argument_list|(
name|context
argument_list|,
name|inputInfo
argument_list|)
decl_stmt|;
name|int
name|bandwidthMB
init|=
name|context
operator|.
name|getConfiguration
argument_list|()
operator|.
name|getInt
argument_list|(
name|CONF_BANDWIDTH_MB
argument_list|,
literal|100
argument_list|)
decl_stmt|;
if|if
condition|(
name|Integer
operator|.
name|MAX_VALUE
operator|!=
name|bandwidthMB
condition|)
block|{
name|in
operator|=
operator|new
name|ThrottledInputStream
argument_list|(
operator|new
name|BufferedInputStream
argument_list|(
name|in
argument_list|)
argument_list|,
name|bandwidthMB
operator|*
literal|1024
operator|*
literal|1024L
argument_list|)
expr_stmt|;
block|}
try|try
block|{
name|context
operator|.
name|getCounter
argument_list|(
name|Counter
operator|.
name|BYTES_EXPECTED
argument_list|)
operator|.
name|increment
argument_list|(
name|inputStat
operator|.
name|getLen
argument_list|()
argument_list|)
expr_stmt|;
comment|// Ensure that the output folder is there and copy the file
name|createOutputPath
argument_list|(
name|outputPath
operator|.
name|getParent
argument_list|()
argument_list|)
expr_stmt|;
name|FSDataOutputStream
name|out
init|=
name|outputFs
operator|.
name|create
argument_list|(
name|outputPath
argument_list|,
literal|true
argument_list|)
decl_stmt|;
try|try
block|{
name|copyData
argument_list|(
name|context
argument_list|,
name|inputStat
operator|.
name|getPath
argument_list|()
argument_list|,
name|in
argument_list|,
name|outputPath
argument_list|,
name|out
argument_list|,
name|inputStat
operator|.
name|getLen
argument_list|()
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|out
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
comment|// Try to Preserve attributes
if|if
condition|(
operator|!
name|preserveAttributes
argument_list|(
name|outputPath
argument_list|,
name|inputStat
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"You may have to run manually chown on: "
operator|+
name|outputPath
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
name|in
operator|.
name|close
argument_list|()
expr_stmt|;
name|injectTestFailure
argument_list|(
name|context
argument_list|,
name|inputInfo
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**      * Create the output folder and optionally set ownership.      */
specifier|private
name|void
name|createOutputPath
parameter_list|(
specifier|final
name|Path
name|path
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|filesUser
operator|==
literal|null
operator|&&
name|filesGroup
operator|==
literal|null
condition|)
block|{
name|outputFs
operator|.
name|mkdirs
argument_list|(
name|path
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|Path
name|parent
init|=
name|path
operator|.
name|getParent
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|outputFs
operator|.
name|exists
argument_list|(
name|parent
argument_list|)
operator|&&
operator|!
name|parent
operator|.
name|isRoot
argument_list|()
condition|)
block|{
name|createOutputPath
argument_list|(
name|parent
argument_list|)
expr_stmt|;
block|}
name|outputFs
operator|.
name|mkdirs
argument_list|(
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|filesUser
operator|!=
literal|null
operator|||
name|filesGroup
operator|!=
literal|null
condition|)
block|{
comment|// override the owner when non-null user/group is specified
name|outputFs
operator|.
name|setOwner
argument_list|(
name|path
argument_list|,
name|filesUser
argument_list|,
name|filesGroup
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|filesMode
operator|>
literal|0
condition|)
block|{
name|outputFs
operator|.
name|setPermission
argument_list|(
name|path
argument_list|,
operator|new
name|FsPermission
argument_list|(
name|filesMode
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**      * Try to Preserve the files attribute selected by the user copying them from the source file      * This is only required when you are exporting as a different user than "hbase" or on a system      * that doesn't have the "hbase" user.      *      * This is not considered a blocking failure since the user can force a chmod with the user      * that knows is available on the system.      */
specifier|private
name|boolean
name|preserveAttributes
parameter_list|(
specifier|final
name|Path
name|path
parameter_list|,
specifier|final
name|FileStatus
name|refStat
parameter_list|)
block|{
name|FileStatus
name|stat
decl_stmt|;
try|try
block|{
name|stat
operator|=
name|outputFs
operator|.
name|getFileStatus
argument_list|(
name|path
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Unable to get the status for file="
operator|+
name|path
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
try|try
block|{
if|if
condition|(
name|filesMode
operator|>
literal|0
operator|&&
name|stat
operator|.
name|getPermission
argument_list|()
operator|.
name|toShort
argument_list|()
operator|!=
name|filesMode
condition|)
block|{
name|outputFs
operator|.
name|setPermission
argument_list|(
name|path
argument_list|,
operator|new
name|FsPermission
argument_list|(
name|filesMode
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|refStat
operator|!=
literal|null
operator|&&
operator|!
name|stat
operator|.
name|getPermission
argument_list|()
operator|.
name|equals
argument_list|(
name|refStat
operator|.
name|getPermission
argument_list|()
argument_list|)
condition|)
block|{
name|outputFs
operator|.
name|setPermission
argument_list|(
name|path
argument_list|,
name|refStat
operator|.
name|getPermission
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Unable to set the permission for file="
operator|+
name|stat
operator|.
name|getPath
argument_list|()
operator|+
literal|": "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
name|boolean
name|hasRefStat
init|=
operator|(
name|refStat
operator|!=
literal|null
operator|)
decl_stmt|;
name|String
name|user
init|=
name|stringIsNotEmpty
argument_list|(
name|filesUser
argument_list|)
operator|||
operator|!
name|hasRefStat
condition|?
name|filesUser
else|:
name|refStat
operator|.
name|getOwner
argument_list|()
decl_stmt|;
name|String
name|group
init|=
name|stringIsNotEmpty
argument_list|(
name|filesGroup
argument_list|)
operator|||
operator|!
name|hasRefStat
condition|?
name|filesGroup
else|:
name|refStat
operator|.
name|getGroup
argument_list|()
decl_stmt|;
if|if
condition|(
name|stringIsNotEmpty
argument_list|(
name|user
argument_list|)
operator|||
name|stringIsNotEmpty
argument_list|(
name|group
argument_list|)
condition|)
block|{
try|try
block|{
if|if
condition|(
operator|!
operator|(
name|user
operator|.
name|equals
argument_list|(
name|stat
operator|.
name|getOwner
argument_list|()
argument_list|)
operator|&&
name|group
operator|.
name|equals
argument_list|(
name|stat
operator|.
name|getGroup
argument_list|()
argument_list|)
operator|)
condition|)
block|{
name|outputFs
operator|.
name|setOwner
argument_list|(
name|path
argument_list|,
name|user
argument_list|,
name|group
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Unable to set the owner/group for file="
operator|+
name|stat
operator|.
name|getPath
argument_list|()
operator|+
literal|": "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|warn
argument_list|(
literal|"The user/group may not exist on the destination cluster: user="
operator|+
name|user
operator|+
literal|" group="
operator|+
name|group
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
block|}
return|return
literal|true
return|;
block|}
specifier|private
name|boolean
name|stringIsNotEmpty
parameter_list|(
specifier|final
name|String
name|str
parameter_list|)
block|{
return|return
name|str
operator|!=
literal|null
operator|&&
name|str
operator|.
name|length
argument_list|()
operator|>
literal|0
return|;
block|}
specifier|private
name|void
name|copyData
parameter_list|(
specifier|final
name|Context
name|context
parameter_list|,
specifier|final
name|Path
name|inputPath
parameter_list|,
specifier|final
name|InputStream
name|in
parameter_list|,
specifier|final
name|Path
name|outputPath
parameter_list|,
specifier|final
name|FSDataOutputStream
name|out
parameter_list|,
specifier|final
name|long
name|inputFileSize
parameter_list|)
throws|throws
name|IOException
block|{
specifier|final
name|String
name|statusMessage
init|=
literal|"copied %s/"
operator|+
name|StringUtils
operator|.
name|humanReadableInt
argument_list|(
name|inputFileSize
argument_list|)
operator|+
literal|" (%.1f%%)"
decl_stmt|;
try|try
block|{
name|byte
index|[]
name|buffer
init|=
operator|new
name|byte
index|[
name|bufferSize
index|]
decl_stmt|;
name|long
name|totalBytesWritten
init|=
literal|0
decl_stmt|;
name|int
name|reportBytes
init|=
literal|0
decl_stmt|;
name|int
name|bytesRead
decl_stmt|;
name|long
name|stime
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
while|while
condition|(
operator|(
name|bytesRead
operator|=
name|in
operator|.
name|read
argument_list|(
name|buffer
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|out
operator|.
name|write
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|,
name|bytesRead
argument_list|)
expr_stmt|;
name|totalBytesWritten
operator|+=
name|bytesRead
expr_stmt|;
name|reportBytes
operator|+=
name|bytesRead
expr_stmt|;
if|if
condition|(
name|reportBytes
operator|>=
name|REPORT_SIZE
condition|)
block|{
name|context
operator|.
name|getCounter
argument_list|(
name|Counter
operator|.
name|BYTES_COPIED
argument_list|)
operator|.
name|increment
argument_list|(
name|reportBytes
argument_list|)
expr_stmt|;
name|context
operator|.
name|setStatus
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|statusMessage
argument_list|,
name|StringUtils
operator|.
name|humanReadableInt
argument_list|(
name|totalBytesWritten
argument_list|)
argument_list|,
operator|(
name|totalBytesWritten
operator|/
operator|(
name|float
operator|)
name|inputFileSize
operator|)
operator|*
literal|100.0f
argument_list|)
operator|+
literal|" from "
operator|+
name|inputPath
operator|+
literal|" to "
operator|+
name|outputPath
argument_list|)
expr_stmt|;
name|reportBytes
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|long
name|etime
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|context
operator|.
name|getCounter
argument_list|(
name|Counter
operator|.
name|BYTES_COPIED
argument_list|)
operator|.
name|increment
argument_list|(
name|reportBytes
argument_list|)
expr_stmt|;
name|context
operator|.
name|setStatus
argument_list|(
name|String
operator|.
name|format
argument_list|(
name|statusMessage
argument_list|,
name|StringUtils
operator|.
name|humanReadableInt
argument_list|(
name|totalBytesWritten
argument_list|)
argument_list|,
operator|(
name|totalBytesWritten
operator|/
operator|(
name|float
operator|)
name|inputFileSize
operator|)
operator|*
literal|100.0f
argument_list|)
operator|+
literal|" from "
operator|+
name|inputPath
operator|+
literal|" to "
operator|+
name|outputPath
argument_list|)
expr_stmt|;
comment|// Verify that the written size match
if|if
condition|(
name|totalBytesWritten
operator|!=
name|inputFileSize
condition|)
block|{
name|String
name|msg
init|=
literal|"number of bytes copied not matching copied="
operator|+
name|totalBytesWritten
operator|+
literal|" expected="
operator|+
name|inputFileSize
operator|+
literal|" for file="
operator|+
name|inputPath
decl_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
name|msg
argument_list|)
throw|;
block|}
name|LOG
operator|.
name|info
argument_list|(
literal|"copy completed for input="
operator|+
name|inputPath
operator|+
literal|" output="
operator|+
name|outputPath
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"size="
operator|+
name|totalBytesWritten
operator|+
literal|" ("
operator|+
name|StringUtils
operator|.
name|humanReadableInt
argument_list|(
name|totalBytesWritten
argument_list|)
operator|+
literal|")"
operator|+
literal|" time="
operator|+
name|StringUtils
operator|.
name|formatTimeDiff
argument_list|(
name|etime
argument_list|,
name|stime
argument_list|)
operator|+
name|String
operator|.
name|format
argument_list|(
literal|" %.3fM/sec"
argument_list|,
operator|(
name|totalBytesWritten
operator|/
operator|(
operator|(
name|etime
operator|-
name|stime
operator|)
operator|/
literal|1000.0
operator|)
operator|)
operator|/
literal|1048576.0
argument_list|)
argument_list|)
expr_stmt|;
name|context
operator|.
name|getCounter
argument_list|(
name|Counter
operator|.
name|FILES_COPIED
argument_list|)
operator|.
name|increment
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Error copying "
operator|+
name|inputPath
operator|+
literal|" to "
operator|+
name|outputPath
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|context
operator|.
name|getCounter
argument_list|(
name|Counter
operator|.
name|COPY_FAILED
argument_list|)
operator|.
name|increment
argument_list|(
literal|1
argument_list|)
expr_stmt|;
throw|throw
name|e
throw|;
block|}
block|}
comment|/**      * Try to open the "source" file.      * Throws an IOException if the communication with the inputFs fail or      * if the file is not found.      */
specifier|private
name|FSDataInputStream
name|openSourceFile
parameter_list|(
name|Context
name|context
parameter_list|,
specifier|final
name|SnapshotFileInfo
name|fileInfo
parameter_list|)
throws|throws
name|IOException
block|{
try|try
block|{
name|Configuration
name|conf
init|=
name|context
operator|.
name|getConfiguration
argument_list|()
decl_stmt|;
name|FileLink
name|link
init|=
literal|null
decl_stmt|;
switch|switch
condition|(
name|fileInfo
operator|.
name|getType
argument_list|()
condition|)
block|{
case|case
name|HFILE
case|:
name|Path
name|inputPath
init|=
operator|new
name|Path
argument_list|(
name|fileInfo
operator|.
name|getHfile
argument_list|()
argument_list|)
decl_stmt|;
name|link
operator|=
name|getFileLink
argument_list|(
name|inputPath
argument_list|,
name|conf
argument_list|)
expr_stmt|;
break|break;
case|case
name|WAL
case|:
name|String
name|serverName
init|=
name|fileInfo
operator|.
name|getWalServer
argument_list|()
decl_stmt|;
name|String
name|logName
init|=
name|fileInfo
operator|.
name|getWalName
argument_list|()
decl_stmt|;
name|link
operator|=
operator|new
name|WALLink
argument_list|(
name|inputRoot
argument_list|,
name|serverName
argument_list|,
name|logName
argument_list|)
expr_stmt|;
break|break;
default|default:
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Invalid File Type: "
operator|+
name|fileInfo
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
throw|;
block|}
return|return
name|link
operator|.
name|open
argument_list|(
name|inputFs
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|context
operator|.
name|getCounter
argument_list|(
name|Counter
operator|.
name|MISSING_FILES
argument_list|)
operator|.
name|increment
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|error
argument_list|(
literal|"Unable to open source file="
operator|+
name|fileInfo
operator|.
name|toString
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
name|e
throw|;
block|}
block|}
specifier|private
name|FileStatus
name|getSourceFileStatus
parameter_list|(
name|Context
name|context
parameter_list|,
specifier|final
name|SnapshotFileInfo
name|fileInfo
parameter_list|)
throws|throws
name|IOException
block|{
try|try
block|{
name|Configuration
name|conf
init|=
name|context
operator|.
name|getConfiguration
argument_list|()
decl_stmt|;
name|FileLink
name|link
init|=
literal|null
decl_stmt|;
switch|switch
condition|(
name|fileInfo
operator|.
name|getType
argument_list|()
condition|)
block|{
case|case
name|HFILE
case|:
name|Path
name|inputPath
init|=
operator|new
name|Path
argument_list|(
name|fileInfo
operator|.
name|getHfile
argument_list|()
argument_list|)
decl_stmt|;
name|link
operator|=
name|getFileLink
argument_list|(
name|inputPath
argument_list|,
name|conf
argument_list|)
expr_stmt|;
break|break;
case|case
name|WAL
case|:
name|link
operator|=
operator|new
name|WALLink
argument_list|(
name|inputRoot
argument_list|,
name|fileInfo
operator|.
name|getWalServer
argument_list|()
argument_list|,
name|fileInfo
operator|.
name|getWalName
argument_list|()
argument_list|)
expr_stmt|;
break|break;
default|default:
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Invalid File Type: "
operator|+
name|fileInfo
operator|.
name|getType
argument_list|()
operator|.
name|toString
argument_list|()
argument_list|)
throw|;
block|}
return|return
name|link
operator|.
name|getFileStatus
argument_list|(
name|inputFs
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|FileNotFoundException
name|e
parameter_list|)
block|{
name|context
operator|.
name|getCounter
argument_list|(
name|Counter
operator|.
name|MISSING_FILES
argument_list|)
operator|.
name|increment
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|error
argument_list|(
literal|"Unable to get the status for source file="
operator|+
name|fileInfo
operator|.
name|toString
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
name|e
throw|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Unable to get the status for source file="
operator|+
name|fileInfo
operator|.
name|toString
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
throw|throw
name|e
throw|;
block|}
block|}
specifier|private
name|FileLink
name|getFileLink
parameter_list|(
name|Path
name|path
parameter_list|,
name|Configuration
name|conf
parameter_list|)
throws|throws
name|IOException
block|{
name|String
name|regionName
init|=
name|HFileLink
operator|.
name|getReferencedRegionName
argument_list|(
name|path
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
name|TableName
name|tableName
init|=
name|HFileLink
operator|.
name|getReferencedTableName
argument_list|(
name|path
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|MobUtils
operator|.
name|getMobRegionInfo
argument_list|(
name|tableName
argument_list|)
operator|.
name|getEncodedName
argument_list|()
operator|.
name|equals
argument_list|(
name|regionName
argument_list|)
condition|)
block|{
return|return
name|HFileLink
operator|.
name|buildFromHFileLinkPattern
argument_list|(
name|MobUtils
operator|.
name|getQualifiedMobRootDir
argument_list|(
name|conf
argument_list|)
argument_list|,
name|HFileArchiveUtil
operator|.
name|getArchivePath
argument_list|(
name|conf
argument_list|)
argument_list|,
name|path
argument_list|)
return|;
block|}
return|return
name|HFileLink
operator|.
name|buildFromHFileLinkPattern
argument_list|(
name|inputRoot
argument_list|,
name|inputArchive
argument_list|,
name|path
argument_list|)
return|;
block|}
specifier|private
name|FileChecksum
name|getFileChecksum
parameter_list|(
specifier|final
name|FileSystem
name|fs
parameter_list|,
specifier|final
name|Path
name|path
parameter_list|)
block|{
try|try
block|{
return|return
name|fs
operator|.
name|getFileChecksum
argument_list|(
name|path
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Unable to get checksum for file="
operator|+
name|path
argument_list|,
name|e
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
block|}
comment|/**      * Check if the two files are equal by looking at the file length,      * and at the checksum (if user has specified the verifyChecksum flag).      */
specifier|private
name|boolean
name|sameFile
parameter_list|(
specifier|final
name|FileStatus
name|inputStat
parameter_list|,
specifier|final
name|FileStatus
name|outputStat
parameter_list|)
block|{
comment|// Not matching length
if|if
condition|(
name|inputStat
operator|.
name|getLen
argument_list|()
operator|!=
name|outputStat
operator|.
name|getLen
argument_list|()
condition|)
return|return
literal|false
return|;
comment|// Mark files as equals, since user asked for no checksum verification
if|if
condition|(
operator|!
name|verifyChecksum
condition|)
return|return
literal|true
return|;
comment|// If checksums are not available, files are not the same.
name|FileChecksum
name|inChecksum
init|=
name|getFileChecksum
argument_list|(
name|inputFs
argument_list|,
name|inputStat
operator|.
name|getPath
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|inChecksum
operator|==
literal|null
condition|)
return|return
literal|false
return|;
name|FileChecksum
name|outChecksum
init|=
name|getFileChecksum
argument_list|(
name|outputFs
argument_list|,
name|outputStat
operator|.
name|getPath
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|outChecksum
operator|==
literal|null
condition|)
return|return
literal|false
return|;
return|return
name|inChecksum
operator|.
name|equals
argument_list|(
name|outChecksum
argument_list|)
return|;
block|}
block|}
comment|// ==========================================================================
comment|//  Input Format
comment|// ==========================================================================
comment|/**    * Extract the list of files (HFiles/WALs) to copy using Map-Reduce.    * @return list of files referenced by the snapshot (pair of path and size)    */
specifier|private
specifier|static
name|List
argument_list|<
name|Pair
argument_list|<
name|SnapshotFileInfo
argument_list|,
name|Long
argument_list|>
argument_list|>
name|getSnapshotFiles
parameter_list|(
specifier|final
name|Configuration
name|conf
parameter_list|,
specifier|final
name|FileSystem
name|fs
parameter_list|,
specifier|final
name|Path
name|snapshotDir
parameter_list|)
throws|throws
name|IOException
block|{
name|SnapshotDescription
name|snapshotDesc
init|=
name|SnapshotDescriptionUtils
operator|.
name|readSnapshotInfo
argument_list|(
name|fs
argument_list|,
name|snapshotDir
argument_list|)
decl_stmt|;
specifier|final
name|List
argument_list|<
name|Pair
argument_list|<
name|SnapshotFileInfo
argument_list|,
name|Long
argument_list|>
argument_list|>
name|files
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
specifier|final
name|TableName
name|table
init|=
name|TableName
operator|.
name|valueOf
argument_list|(
name|snapshotDesc
operator|.
name|getTable
argument_list|()
argument_list|)
decl_stmt|;
comment|// Get snapshot files
name|LOG
operator|.
name|info
argument_list|(
literal|"Loading Snapshot '"
operator|+
name|snapshotDesc
operator|.
name|getName
argument_list|()
operator|+
literal|"' hfile list"
argument_list|)
expr_stmt|;
name|SnapshotReferenceUtil
operator|.
name|visitReferencedFiles
argument_list|(
name|conf
argument_list|,
name|fs
argument_list|,
name|snapshotDir
argument_list|,
name|snapshotDesc
argument_list|,
operator|new
name|SnapshotReferenceUtil
operator|.
name|SnapshotVisitor
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|storeFile
parameter_list|(
specifier|final
name|RegionInfo
name|regionInfo
parameter_list|,
specifier|final
name|String
name|family
parameter_list|,
specifier|final
name|SnapshotRegionManifest
operator|.
name|StoreFile
name|storeFile
parameter_list|)
throws|throws
name|IOException
block|{
comment|// for storeFile.hasReference() case, copied as part of the manifest
if|if
condition|(
operator|!
name|storeFile
operator|.
name|hasReference
argument_list|()
condition|)
block|{
name|String
name|region
init|=
name|regionInfo
operator|.
name|getEncodedName
argument_list|()
decl_stmt|;
name|String
name|hfile
init|=
name|storeFile
operator|.
name|getName
argument_list|()
decl_stmt|;
name|Path
name|path
init|=
name|HFileLink
operator|.
name|createPath
argument_list|(
name|table
argument_list|,
name|region
argument_list|,
name|family
argument_list|,
name|hfile
argument_list|)
decl_stmt|;
name|SnapshotFileInfo
name|fileInfo
init|=
name|SnapshotFileInfo
operator|.
name|newBuilder
argument_list|()
operator|.
name|setType
argument_list|(
name|SnapshotFileInfo
operator|.
name|Type
operator|.
name|HFILE
argument_list|)
operator|.
name|setHfile
argument_list|(
name|path
operator|.
name|toString
argument_list|()
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|long
name|size
decl_stmt|;
if|if
condition|(
name|storeFile
operator|.
name|hasFileSize
argument_list|()
condition|)
block|{
name|size
operator|=
name|storeFile
operator|.
name|getFileSize
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|size
operator|=
name|HFileLink
operator|.
name|buildFromHFileLinkPattern
argument_list|(
name|conf
argument_list|,
name|path
argument_list|)
operator|.
name|getFileStatus
argument_list|(
name|fs
argument_list|)
operator|.
name|getLen
argument_list|()
expr_stmt|;
block|}
name|files
operator|.
name|add
argument_list|(
operator|new
name|Pair
argument_list|<>
argument_list|(
name|fileInfo
argument_list|,
name|size
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
argument_list|)
expr_stmt|;
return|return
name|files
return|;
block|}
comment|/**    * Given a list of file paths and sizes, create around ngroups in as balanced a way as possible.    * The groups created will have similar amounts of bytes.    *<p>    * The algorithm used is pretty straightforward; the file list is sorted by size,    * and then each group fetch the bigger file available, iterating through groups    * alternating the direction.    */
specifier|static
name|List
argument_list|<
name|List
argument_list|<
name|Pair
argument_list|<
name|SnapshotFileInfo
argument_list|,
name|Long
argument_list|>
argument_list|>
argument_list|>
name|getBalancedSplits
parameter_list|(
specifier|final
name|List
argument_list|<
name|Pair
argument_list|<
name|SnapshotFileInfo
argument_list|,
name|Long
argument_list|>
argument_list|>
name|files
parameter_list|,
specifier|final
name|int
name|ngroups
parameter_list|)
block|{
comment|// Sort files by size, from small to big
name|Collections
operator|.
name|sort
argument_list|(
name|files
argument_list|,
operator|new
name|Comparator
argument_list|<
name|Pair
argument_list|<
name|SnapshotFileInfo
argument_list|,
name|Long
argument_list|>
argument_list|>
argument_list|()
block|{
specifier|public
name|int
name|compare
parameter_list|(
name|Pair
argument_list|<
name|SnapshotFileInfo
argument_list|,
name|Long
argument_list|>
name|a
parameter_list|,
name|Pair
argument_list|<
name|SnapshotFileInfo
argument_list|,
name|Long
argument_list|>
name|b
parameter_list|)
block|{
name|long
name|r
init|=
name|a
operator|.
name|getSecond
argument_list|()
operator|-
name|b
operator|.
name|getSecond
argument_list|()
decl_stmt|;
return|return
operator|(
name|r
operator|<
literal|0
operator|)
condition|?
operator|-
literal|1
else|:
operator|(
operator|(
name|r
operator|>
literal|0
operator|)
condition|?
literal|1
else|:
literal|0
operator|)
return|;
block|}
block|}
argument_list|)
expr_stmt|;
comment|// create balanced groups
name|List
argument_list|<
name|List
argument_list|<
name|Pair
argument_list|<
name|SnapshotFileInfo
argument_list|,
name|Long
argument_list|>
argument_list|>
argument_list|>
name|fileGroups
init|=
operator|new
name|LinkedList
argument_list|<>
argument_list|()
decl_stmt|;
name|long
index|[]
name|sizeGroups
init|=
operator|new
name|long
index|[
name|ngroups
index|]
decl_stmt|;
name|int
name|hi
init|=
name|files
operator|.
name|size
argument_list|()
operator|-
literal|1
decl_stmt|;
name|int
name|lo
init|=
literal|0
decl_stmt|;
name|List
argument_list|<
name|Pair
argument_list|<
name|SnapshotFileInfo
argument_list|,
name|Long
argument_list|>
argument_list|>
name|group
decl_stmt|;
name|int
name|dir
init|=
literal|1
decl_stmt|;
name|int
name|g
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|hi
operator|>=
name|lo
condition|)
block|{
if|if
condition|(
name|g
operator|==
name|fileGroups
operator|.
name|size
argument_list|()
condition|)
block|{
name|group
operator|=
operator|new
name|LinkedList
argument_list|<>
argument_list|()
expr_stmt|;
name|fileGroups
operator|.
name|add
argument_list|(
name|group
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|group
operator|=
name|fileGroups
operator|.
name|get
argument_list|(
name|g
argument_list|)
expr_stmt|;
block|}
name|Pair
argument_list|<
name|SnapshotFileInfo
argument_list|,
name|Long
argument_list|>
name|fileInfo
init|=
name|files
operator|.
name|get
argument_list|(
name|hi
operator|--
argument_list|)
decl_stmt|;
comment|// add the hi one
name|sizeGroups
index|[
name|g
index|]
operator|+=
name|fileInfo
operator|.
name|getSecond
argument_list|()
expr_stmt|;
name|group
operator|.
name|add
argument_list|(
name|fileInfo
argument_list|)
expr_stmt|;
comment|// change direction when at the end or the beginning
name|g
operator|+=
name|dir
expr_stmt|;
if|if
condition|(
name|g
operator|==
name|ngroups
condition|)
block|{
name|dir
operator|=
operator|-
literal|1
expr_stmt|;
name|g
operator|=
name|ngroups
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|g
operator|<
literal|0
condition|)
block|{
name|dir
operator|=
literal|1
expr_stmt|;
name|g
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|sizeGroups
operator|.
name|length
condition|;
operator|++
name|i
control|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"export split="
operator|+
name|i
operator|+
literal|" size="
operator|+
name|StringUtils
operator|.
name|humanReadableInt
argument_list|(
name|sizeGroups
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|fileGroups
return|;
block|}
specifier|private
specifier|static
class|class
name|ExportSnapshotInputFormat
extends|extends
name|InputFormat
argument_list|<
name|BytesWritable
argument_list|,
name|NullWritable
argument_list|>
block|{
annotation|@
name|Override
specifier|public
name|RecordReader
argument_list|<
name|BytesWritable
argument_list|,
name|NullWritable
argument_list|>
name|createRecordReader
parameter_list|(
name|InputSplit
name|split
parameter_list|,
name|TaskAttemptContext
name|tac
parameter_list|)
throws|throws
name|IOException
throws|,
name|InterruptedException
block|{
return|return
operator|new
name|ExportSnapshotRecordReader
argument_list|(
operator|(
operator|(
name|ExportSnapshotInputSplit
operator|)
name|split
operator|)
operator|.
name|getSplitKeys
argument_list|()
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|List
argument_list|<
name|InputSplit
argument_list|>
name|getSplits
parameter_list|(
name|JobContext
name|context
parameter_list|)
throws|throws
name|IOException
throws|,
name|InterruptedException
block|{
name|Configuration
name|conf
init|=
name|context
operator|.
name|getConfiguration
argument_list|()
decl_stmt|;
name|Path
name|snapshotDir
init|=
operator|new
name|Path
argument_list|(
name|conf
operator|.
name|get
argument_list|(
name|CONF_SNAPSHOT_DIR
argument_list|)
argument_list|)
decl_stmt|;
name|FileSystem
name|fs
init|=
name|FileSystem
operator|.
name|get
argument_list|(
name|snapshotDir
operator|.
name|toUri
argument_list|()
argument_list|,
name|conf
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|Pair
argument_list|<
name|SnapshotFileInfo
argument_list|,
name|Long
argument_list|>
argument_list|>
name|snapshotFiles
init|=
name|getSnapshotFiles
argument_list|(
name|conf
argument_list|,
name|fs
argument_list|,
name|snapshotDir
argument_list|)
decl_stmt|;
name|int
name|mappers
init|=
name|conf
operator|.
name|getInt
argument_list|(
name|CONF_NUM_SPLITS
argument_list|,
literal|0
argument_list|)
decl_stmt|;
if|if
condition|(
name|mappers
operator|==
literal|0
operator|&&
name|snapshotFiles
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|mappers
operator|=
literal|1
operator|+
operator|(
name|snapshotFiles
operator|.
name|size
argument_list|()
operator|/
name|conf
operator|.
name|getInt
argument_list|(
name|CONF_MAP_GROUP
argument_list|,
literal|10
argument_list|)
operator|)
expr_stmt|;
name|mappers
operator|=
name|Math
operator|.
name|min
argument_list|(
name|mappers
argument_list|,
name|snapshotFiles
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setInt
argument_list|(
name|CONF_NUM_SPLITS
argument_list|,
name|mappers
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setInt
argument_list|(
name|MR_NUM_MAPS
argument_list|,
name|mappers
argument_list|)
expr_stmt|;
block|}
name|List
argument_list|<
name|List
argument_list|<
name|Pair
argument_list|<
name|SnapshotFileInfo
argument_list|,
name|Long
argument_list|>
argument_list|>
argument_list|>
name|groups
init|=
name|getBalancedSplits
argument_list|(
name|snapshotFiles
argument_list|,
name|mappers
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|InputSplit
argument_list|>
name|splits
init|=
operator|new
name|ArrayList
argument_list|(
name|groups
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|List
argument_list|<
name|Pair
argument_list|<
name|SnapshotFileInfo
argument_list|,
name|Long
argument_list|>
argument_list|>
name|files
range|:
name|groups
control|)
block|{
name|splits
operator|.
name|add
argument_list|(
operator|new
name|ExportSnapshotInputSplit
argument_list|(
name|files
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|splits
return|;
block|}
specifier|private
specifier|static
class|class
name|ExportSnapshotInputSplit
extends|extends
name|InputSplit
implements|implements
name|Writable
block|{
specifier|private
name|List
argument_list|<
name|Pair
argument_list|<
name|BytesWritable
argument_list|,
name|Long
argument_list|>
argument_list|>
name|files
decl_stmt|;
specifier|private
name|long
name|length
decl_stmt|;
specifier|public
name|ExportSnapshotInputSplit
parameter_list|()
block|{
name|this
operator|.
name|files
operator|=
literal|null
expr_stmt|;
block|}
specifier|public
name|ExportSnapshotInputSplit
parameter_list|(
specifier|final
name|List
argument_list|<
name|Pair
argument_list|<
name|SnapshotFileInfo
argument_list|,
name|Long
argument_list|>
argument_list|>
name|snapshotFiles
parameter_list|)
block|{
name|this
operator|.
name|files
operator|=
operator|new
name|ArrayList
argument_list|(
name|snapshotFiles
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|Pair
argument_list|<
name|SnapshotFileInfo
argument_list|,
name|Long
argument_list|>
name|fileInfo
range|:
name|snapshotFiles
control|)
block|{
name|this
operator|.
name|files
operator|.
name|add
argument_list|(
operator|new
name|Pair
argument_list|<>
argument_list|(
operator|new
name|BytesWritable
argument_list|(
name|fileInfo
operator|.
name|getFirst
argument_list|()
operator|.
name|toByteArray
argument_list|()
argument_list|)
argument_list|,
name|fileInfo
operator|.
name|getSecond
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|this
operator|.
name|length
operator|+=
name|fileInfo
operator|.
name|getSecond
argument_list|()
expr_stmt|;
block|}
block|}
specifier|private
name|List
argument_list|<
name|Pair
argument_list|<
name|BytesWritable
argument_list|,
name|Long
argument_list|>
argument_list|>
name|getSplitKeys
parameter_list|()
block|{
return|return
name|files
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getLength
parameter_list|()
throws|throws
name|IOException
throws|,
name|InterruptedException
block|{
return|return
name|length
return|;
block|}
annotation|@
name|Override
specifier|public
name|String
index|[]
name|getLocations
parameter_list|()
throws|throws
name|IOException
throws|,
name|InterruptedException
block|{
return|return
operator|new
name|String
index|[]
block|{}
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|readFields
parameter_list|(
name|DataInput
name|in
parameter_list|)
throws|throws
name|IOException
block|{
name|int
name|count
init|=
name|in
operator|.
name|readInt
argument_list|()
decl_stmt|;
name|files
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|count
argument_list|)
expr_stmt|;
name|length
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
operator|++
name|i
control|)
block|{
name|BytesWritable
name|fileInfo
init|=
operator|new
name|BytesWritable
argument_list|()
decl_stmt|;
name|fileInfo
operator|.
name|readFields
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|long
name|size
init|=
name|in
operator|.
name|readLong
argument_list|()
decl_stmt|;
name|files
operator|.
name|add
argument_list|(
operator|new
name|Pair
argument_list|<>
argument_list|(
name|fileInfo
argument_list|,
name|size
argument_list|)
argument_list|)
expr_stmt|;
name|length
operator|+=
name|size
expr_stmt|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|write
parameter_list|(
name|DataOutput
name|out
parameter_list|)
throws|throws
name|IOException
block|{
name|out
operator|.
name|writeInt
argument_list|(
name|files
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
specifier|final
name|Pair
argument_list|<
name|BytesWritable
argument_list|,
name|Long
argument_list|>
name|fileInfo
range|:
name|files
control|)
block|{
name|fileInfo
operator|.
name|getFirst
argument_list|()
operator|.
name|write
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|out
operator|.
name|writeLong
argument_list|(
name|fileInfo
operator|.
name|getSecond
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|private
specifier|static
class|class
name|ExportSnapshotRecordReader
extends|extends
name|RecordReader
argument_list|<
name|BytesWritable
argument_list|,
name|NullWritable
argument_list|>
block|{
specifier|private
specifier|final
name|List
argument_list|<
name|Pair
argument_list|<
name|BytesWritable
argument_list|,
name|Long
argument_list|>
argument_list|>
name|files
decl_stmt|;
specifier|private
name|long
name|totalSize
init|=
literal|0
decl_stmt|;
specifier|private
name|long
name|procSize
init|=
literal|0
decl_stmt|;
specifier|private
name|int
name|index
init|=
operator|-
literal|1
decl_stmt|;
name|ExportSnapshotRecordReader
parameter_list|(
specifier|final
name|List
argument_list|<
name|Pair
argument_list|<
name|BytesWritable
argument_list|,
name|Long
argument_list|>
argument_list|>
name|files
parameter_list|)
block|{
name|this
operator|.
name|files
operator|=
name|files
expr_stmt|;
for|for
control|(
name|Pair
argument_list|<
name|BytesWritable
argument_list|,
name|Long
argument_list|>
name|fileInfo
range|:
name|files
control|)
block|{
name|totalSize
operator|+=
name|fileInfo
operator|.
name|getSecond
argument_list|()
expr_stmt|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|close
parameter_list|()
block|{ }
annotation|@
name|Override
specifier|public
name|BytesWritable
name|getCurrentKey
parameter_list|()
block|{
return|return
name|files
operator|.
name|get
argument_list|(
name|index
argument_list|)
operator|.
name|getFirst
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|NullWritable
name|getCurrentValue
parameter_list|()
block|{
return|return
name|NullWritable
operator|.
name|get
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|float
name|getProgress
parameter_list|()
block|{
return|return
operator|(
name|float
operator|)
name|procSize
operator|/
name|totalSize
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|initialize
parameter_list|(
name|InputSplit
name|split
parameter_list|,
name|TaskAttemptContext
name|tac
parameter_list|)
block|{ }
annotation|@
name|Override
specifier|public
name|boolean
name|nextKeyValue
parameter_list|()
block|{
if|if
condition|(
name|index
operator|>=
literal|0
condition|)
block|{
name|procSize
operator|+=
name|files
operator|.
name|get
argument_list|(
name|index
argument_list|)
operator|.
name|getSecond
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
operator|++
name|index
operator|<
name|files
operator|.
name|size
argument_list|()
operator|)
return|;
block|}
block|}
block|}
comment|// ==========================================================================
comment|//  Tool
comment|// ==========================================================================
comment|/**    * Run Map-Reduce Job to perform the files copy.    */
specifier|private
name|void
name|runCopyJob
parameter_list|(
specifier|final
name|Path
name|inputRoot
parameter_list|,
specifier|final
name|Path
name|outputRoot
parameter_list|,
specifier|final
name|String
name|snapshotName
parameter_list|,
specifier|final
name|Path
name|snapshotDir
parameter_list|,
specifier|final
name|boolean
name|verifyChecksum
parameter_list|,
specifier|final
name|String
name|filesUser
parameter_list|,
specifier|final
name|String
name|filesGroup
parameter_list|,
specifier|final
name|int
name|filesMode
parameter_list|,
specifier|final
name|int
name|mappers
parameter_list|,
specifier|final
name|int
name|bandwidthMB
parameter_list|)
throws|throws
name|IOException
throws|,
name|InterruptedException
throws|,
name|ClassNotFoundException
block|{
name|Configuration
name|conf
init|=
name|getConf
argument_list|()
decl_stmt|;
if|if
condition|(
name|filesGroup
operator|!=
literal|null
condition|)
name|conf
operator|.
name|set
argument_list|(
name|CONF_FILES_GROUP
argument_list|,
name|filesGroup
argument_list|)
expr_stmt|;
if|if
condition|(
name|filesUser
operator|!=
literal|null
condition|)
name|conf
operator|.
name|set
argument_list|(
name|CONF_FILES_USER
argument_list|,
name|filesUser
argument_list|)
expr_stmt|;
if|if
condition|(
name|mappers
operator|>
literal|0
condition|)
block|{
name|conf
operator|.
name|setInt
argument_list|(
name|CONF_NUM_SPLITS
argument_list|,
name|mappers
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setInt
argument_list|(
name|MR_NUM_MAPS
argument_list|,
name|mappers
argument_list|)
expr_stmt|;
block|}
name|conf
operator|.
name|setInt
argument_list|(
name|CONF_FILES_MODE
argument_list|,
name|filesMode
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setBoolean
argument_list|(
name|CONF_CHECKSUM_VERIFY
argument_list|,
name|verifyChecksum
argument_list|)
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|CONF_OUTPUT_ROOT
argument_list|,
name|outputRoot
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|CONF_INPUT_ROOT
argument_list|,
name|inputRoot
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|conf
operator|.
name|setInt
argument_list|(
name|CONF_BANDWIDTH_MB
argument_list|,
name|bandwidthMB
argument_list|)
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|CONF_SNAPSHOT_NAME
argument_list|,
name|snapshotName
argument_list|)
expr_stmt|;
name|conf
operator|.
name|set
argument_list|(
name|CONF_SNAPSHOT_DIR
argument_list|,
name|snapshotDir
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|jobname
init|=
name|conf
operator|.
name|get
argument_list|(
name|CONF_MR_JOB_NAME
argument_list|,
literal|"ExportSnapshot-"
operator|+
name|snapshotName
argument_list|)
decl_stmt|;
name|Job
name|job
init|=
operator|new
name|Job
argument_list|(
name|conf
argument_list|)
decl_stmt|;
name|job
operator|.
name|setJobName
argument_list|(
name|jobname
argument_list|)
expr_stmt|;
name|job
operator|.
name|setJarByClass
argument_list|(
name|ExportSnapshot
operator|.
name|class
argument_list|)
expr_stmt|;
name|TableMapReduceUtil
operator|.
name|addDependencyJars
argument_list|(
name|job
argument_list|)
expr_stmt|;
name|job
operator|.
name|setMapperClass
argument_list|(
name|ExportMapper
operator|.
name|class
argument_list|)
expr_stmt|;
name|job
operator|.
name|setInputFormatClass
argument_list|(
name|ExportSnapshotInputFormat
operator|.
name|class
argument_list|)
expr_stmt|;
name|job
operator|.
name|setOutputFormatClass
argument_list|(
name|NullOutputFormat
operator|.
name|class
argument_list|)
expr_stmt|;
name|job
operator|.
name|setMapSpeculativeExecution
argument_list|(
literal|false
argument_list|)
expr_stmt|;
name|job
operator|.
name|setNumReduceTasks
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// Acquire the delegation Tokens
name|Configuration
name|srcConf
init|=
name|HBaseConfiguration
operator|.
name|createClusterConf
argument_list|(
name|conf
argument_list|,
literal|null
argument_list|,
name|CONF_SOURCE_PREFIX
argument_list|)
decl_stmt|;
name|TokenCache
operator|.
name|obtainTokensForNamenodes
argument_list|(
name|job
operator|.
name|getCredentials
argument_list|()
argument_list|,
operator|new
name|Path
index|[]
block|{
name|inputRoot
block|}
argument_list|,
name|srcConf
argument_list|)
expr_stmt|;
name|Configuration
name|destConf
init|=
name|HBaseConfiguration
operator|.
name|createClusterConf
argument_list|(
name|conf
argument_list|,
literal|null
argument_list|,
name|CONF_DEST_PREFIX
argument_list|)
decl_stmt|;
name|TokenCache
operator|.
name|obtainTokensForNamenodes
argument_list|(
name|job
operator|.
name|getCredentials
argument_list|()
argument_list|,
operator|new
name|Path
index|[]
block|{
name|outputRoot
block|}
argument_list|,
name|destConf
argument_list|)
expr_stmt|;
comment|// Run the MR Job
if|if
condition|(
operator|!
name|job
operator|.
name|waitForCompletion
argument_list|(
literal|true
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|ExportSnapshotException
argument_list|(
name|job
operator|.
name|getStatus
argument_list|()
operator|.
name|getFailureInfo
argument_list|()
argument_list|)
throw|;
block|}
block|}
specifier|private
name|void
name|verifySnapshot
parameter_list|(
specifier|final
name|Configuration
name|baseConf
parameter_list|,
specifier|final
name|FileSystem
name|fs
parameter_list|,
specifier|final
name|Path
name|rootDir
parameter_list|,
specifier|final
name|Path
name|snapshotDir
parameter_list|)
throws|throws
name|IOException
block|{
comment|// Update the conf with the current root dir, since may be a different cluster
name|Configuration
name|conf
init|=
operator|new
name|Configuration
argument_list|(
name|baseConf
argument_list|)
decl_stmt|;
name|FSUtils
operator|.
name|setRootDir
argument_list|(
name|conf
argument_list|,
name|rootDir
argument_list|)
expr_stmt|;
name|FSUtils
operator|.
name|setFsDefault
argument_list|(
name|conf
argument_list|,
name|FSUtils
operator|.
name|getRootDir
argument_list|(
name|conf
argument_list|)
argument_list|)
expr_stmt|;
name|SnapshotDescription
name|snapshotDesc
init|=
name|SnapshotDescriptionUtils
operator|.
name|readSnapshotInfo
argument_list|(
name|fs
argument_list|,
name|snapshotDir
argument_list|)
decl_stmt|;
name|SnapshotReferenceUtil
operator|.
name|verifySnapshot
argument_list|(
name|conf
argument_list|,
name|fs
argument_list|,
name|snapshotDir
argument_list|,
name|snapshotDesc
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|setConfigParallel
parameter_list|(
name|FileSystem
name|outputFs
parameter_list|,
name|List
argument_list|<
name|Path
argument_list|>
name|traversedPath
parameter_list|,
name|BiConsumer
argument_list|<
name|FileSystem
argument_list|,
name|Path
argument_list|>
name|task
parameter_list|,
name|Configuration
name|conf
parameter_list|)
throws|throws
name|IOException
block|{
name|ExecutorService
name|pool
init|=
name|Executors
operator|.
name|newFixedThreadPool
argument_list|(
name|conf
operator|.
name|getInt
argument_list|(
name|CONF_COPY_MANIFEST_THREADS
argument_list|,
name|DEFAULT_COPY_MANIFEST_THREADS
argument_list|)
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|Future
argument_list|<
name|Void
argument_list|>
argument_list|>
name|futures
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|Path
name|dstPath
range|:
name|traversedPath
control|)
block|{
name|Future
argument_list|<
name|Void
argument_list|>
name|future
init|=
operator|(
name|Future
argument_list|<
name|Void
argument_list|>
operator|)
name|pool
operator|.
name|submit
argument_list|(
parameter_list|()
lambda|->
name|task
operator|.
name|accept
argument_list|(
name|outputFs
argument_list|,
name|dstPath
argument_list|)
argument_list|)
decl_stmt|;
name|futures
operator|.
name|add
argument_list|(
name|future
argument_list|)
expr_stmt|;
block|}
try|try
block|{
for|for
control|(
name|Future
argument_list|<
name|Void
argument_list|>
name|future
range|:
name|futures
control|)
block|{
name|future
operator|.
name|get
argument_list|()
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|InterruptedException
decl||
name|ExecutionException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
name|pool
operator|.
name|shutdownNow
argument_list|()
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|setOwnerParallel
parameter_list|(
name|FileSystem
name|outputFs
parameter_list|,
name|String
name|filesUser
parameter_list|,
name|String
name|filesGroup
parameter_list|,
name|Configuration
name|conf
parameter_list|,
name|List
argument_list|<
name|Path
argument_list|>
name|traversedPath
parameter_list|)
throws|throws
name|IOException
block|{
name|setConfigParallel
argument_list|(
name|outputFs
argument_list|,
name|traversedPath
argument_list|,
parameter_list|(
name|fs
parameter_list|,
name|path
parameter_list|)
lambda|->
block|{
try|try
block|{
name|fs
operator|.
name|setOwner
argument_list|(
name|path
argument_list|,
name|filesUser
argument_list|,
name|filesGroup
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
literal|"set owner for file "
operator|+
name|path
operator|+
literal|" to "
operator|+
name|filesUser
operator|+
literal|":"
operator|+
name|filesGroup
operator|+
literal|" failed"
argument_list|)
throw|;
block|}
block|}
argument_list|,
name|conf
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|setPermissionParallel
parameter_list|(
specifier|final
name|FileSystem
name|outputFs
parameter_list|,
specifier|final
name|short
name|filesMode
parameter_list|,
specifier|final
name|List
argument_list|<
name|Path
argument_list|>
name|traversedPath
parameter_list|,
specifier|final
name|Configuration
name|conf
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|filesMode
operator|<=
literal|0
condition|)
block|{
return|return;
block|}
name|FsPermission
name|perm
init|=
operator|new
name|FsPermission
argument_list|(
name|filesMode
argument_list|)
decl_stmt|;
name|setConfigParallel
argument_list|(
name|outputFs
argument_list|,
name|traversedPath
argument_list|,
parameter_list|(
name|fs
parameter_list|,
name|path
parameter_list|)
lambda|->
block|{
try|try
block|{
name|fs
operator|.
name|setPermission
argument_list|(
name|path
argument_list|,
name|perm
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
literal|"set permission for file "
operator|+
name|path
operator|+
literal|" to "
operator|+
name|filesMode
operator|+
literal|" failed"
argument_list|)
throw|;
block|}
block|}
argument_list|,
name|conf
argument_list|)
expr_stmt|;
block|}
specifier|private
name|boolean
name|verifyTarget
init|=
literal|true
decl_stmt|;
specifier|private
name|boolean
name|verifyChecksum
init|=
literal|true
decl_stmt|;
specifier|private
name|String
name|snapshotName
init|=
literal|null
decl_stmt|;
specifier|private
name|String
name|targetName
init|=
literal|null
decl_stmt|;
specifier|private
name|boolean
name|overwrite
init|=
literal|false
decl_stmt|;
specifier|private
name|String
name|filesGroup
init|=
literal|null
decl_stmt|;
specifier|private
name|String
name|filesUser
init|=
literal|null
decl_stmt|;
specifier|private
name|Path
name|outputRoot
init|=
literal|null
decl_stmt|;
specifier|private
name|Path
name|inputRoot
init|=
literal|null
decl_stmt|;
specifier|private
name|int
name|bandwidthMB
init|=
name|Integer
operator|.
name|MAX_VALUE
decl_stmt|;
specifier|private
name|int
name|filesMode
init|=
literal|0
decl_stmt|;
specifier|private
name|int
name|mappers
init|=
literal|0
decl_stmt|;
annotation|@
name|Override
specifier|protected
name|void
name|processOptions
parameter_list|(
name|CommandLine
name|cmd
parameter_list|)
block|{
name|snapshotName
operator|=
name|cmd
operator|.
name|getOptionValue
argument_list|(
name|Options
operator|.
name|SNAPSHOT
operator|.
name|getLongOpt
argument_list|()
argument_list|,
name|snapshotName
argument_list|)
expr_stmt|;
name|targetName
operator|=
name|cmd
operator|.
name|getOptionValue
argument_list|(
name|Options
operator|.
name|TARGET_NAME
operator|.
name|getLongOpt
argument_list|()
argument_list|,
name|targetName
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|.
name|hasOption
argument_list|(
name|Options
operator|.
name|COPY_TO
operator|.
name|getLongOpt
argument_list|()
argument_list|)
condition|)
block|{
name|outputRoot
operator|=
operator|new
name|Path
argument_list|(
name|cmd
operator|.
name|getOptionValue
argument_list|(
name|Options
operator|.
name|COPY_TO
operator|.
name|getLongOpt
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cmd
operator|.
name|hasOption
argument_list|(
name|Options
operator|.
name|COPY_FROM
operator|.
name|getLongOpt
argument_list|()
argument_list|)
condition|)
block|{
name|inputRoot
operator|=
operator|new
name|Path
argument_list|(
name|cmd
operator|.
name|getOptionValue
argument_list|(
name|Options
operator|.
name|COPY_FROM
operator|.
name|getLongOpt
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|mappers
operator|=
name|getOptionAsInt
argument_list|(
name|cmd
argument_list|,
name|Options
operator|.
name|MAPPERS
operator|.
name|getLongOpt
argument_list|()
argument_list|,
name|mappers
argument_list|)
expr_stmt|;
name|filesUser
operator|=
name|cmd
operator|.
name|getOptionValue
argument_list|(
name|Options
operator|.
name|CHUSER
operator|.
name|getLongOpt
argument_list|()
argument_list|,
name|filesUser
argument_list|)
expr_stmt|;
name|filesGroup
operator|=
name|cmd
operator|.
name|getOptionValue
argument_list|(
name|Options
operator|.
name|CHGROUP
operator|.
name|getLongOpt
argument_list|()
argument_list|,
name|filesGroup
argument_list|)
expr_stmt|;
name|filesMode
operator|=
name|getOptionAsInt
argument_list|(
name|cmd
argument_list|,
name|Options
operator|.
name|CHMOD
operator|.
name|getLongOpt
argument_list|()
argument_list|,
name|filesMode
argument_list|)
expr_stmt|;
name|bandwidthMB
operator|=
name|getOptionAsInt
argument_list|(
name|cmd
argument_list|,
name|Options
operator|.
name|BANDWIDTH
operator|.
name|getLongOpt
argument_list|()
argument_list|,
name|bandwidthMB
argument_list|)
expr_stmt|;
name|overwrite
operator|=
name|cmd
operator|.
name|hasOption
argument_list|(
name|Options
operator|.
name|OVERWRITE
operator|.
name|getLongOpt
argument_list|()
argument_list|)
expr_stmt|;
comment|// And verifyChecksum and verifyTarget with values read from old args in processOldArgs(...).
name|verifyChecksum
operator|=
operator|!
name|cmd
operator|.
name|hasOption
argument_list|(
name|Options
operator|.
name|NO_CHECKSUM_VERIFY
operator|.
name|getLongOpt
argument_list|()
argument_list|)
expr_stmt|;
name|verifyTarget
operator|=
operator|!
name|cmd
operator|.
name|hasOption
argument_list|(
name|Options
operator|.
name|NO_TARGET_VERIFY
operator|.
name|getLongOpt
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/**    * Execute the export snapshot by copying the snapshot metadata, hfiles and wals.    * @return 0 on success, and != 0 upon failure.    */
annotation|@
name|Override
specifier|public
name|int
name|doWork
parameter_list|()
throws|throws
name|IOException
block|{
name|Configuration
name|conf
init|=
name|getConf
argument_list|()
decl_stmt|;
comment|// Check user options
if|if
condition|(
name|snapshotName
operator|==
literal|null
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Snapshot name not provided."
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|error
argument_list|(
literal|"Use -h or --help for usage instructions."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|outputRoot
operator|==
literal|null
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Destination file-system (--"
operator|+
name|Options
operator|.
name|COPY_TO
operator|.
name|getLongOpt
argument_list|()
operator|+
literal|") not provided."
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|error
argument_list|(
literal|"Use -h or --help for usage instructions."
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|targetName
operator|==
literal|null
condition|)
block|{
name|targetName
operator|=
name|snapshotName
expr_stmt|;
block|}
if|if
condition|(
name|inputRoot
operator|==
literal|null
condition|)
block|{
name|inputRoot
operator|=
name|FSUtils
operator|.
name|getRootDir
argument_list|(
name|conf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|FSUtils
operator|.
name|setRootDir
argument_list|(
name|conf
argument_list|,
name|inputRoot
argument_list|)
expr_stmt|;
block|}
name|Configuration
name|srcConf
init|=
name|HBaseConfiguration
operator|.
name|createClusterConf
argument_list|(
name|conf
argument_list|,
literal|null
argument_list|,
name|CONF_SOURCE_PREFIX
argument_list|)
decl_stmt|;
name|srcConf
operator|.
name|setBoolean
argument_list|(
literal|"fs."
operator|+
name|inputRoot
operator|.
name|toUri
argument_list|()
operator|.
name|getScheme
argument_list|()
operator|+
literal|".impl.disable.cache"
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|FileSystem
name|inputFs
init|=
name|FileSystem
operator|.
name|get
argument_list|(
name|inputRoot
operator|.
name|toUri
argument_list|()
argument_list|,
name|srcConf
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"inputFs="
operator|+
name|inputFs
operator|.
name|getUri
argument_list|()
operator|.
name|toString
argument_list|()
operator|+
literal|" inputRoot="
operator|+
name|inputRoot
argument_list|)
expr_stmt|;
name|Configuration
name|destConf
init|=
name|HBaseConfiguration
operator|.
name|createClusterConf
argument_list|(
name|conf
argument_list|,
literal|null
argument_list|,
name|CONF_DEST_PREFIX
argument_list|)
decl_stmt|;
name|destConf
operator|.
name|setBoolean
argument_list|(
literal|"fs."
operator|+
name|outputRoot
operator|.
name|toUri
argument_list|()
operator|.
name|getScheme
argument_list|()
operator|+
literal|".impl.disable.cache"
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|FileSystem
name|outputFs
init|=
name|FileSystem
operator|.
name|get
argument_list|(
name|outputRoot
operator|.
name|toUri
argument_list|()
argument_list|,
name|destConf
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"outputFs="
operator|+
name|outputFs
operator|.
name|getUri
argument_list|()
operator|.
name|toString
argument_list|()
operator|+
literal|" outputRoot="
operator|+
name|outputRoot
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|boolean
name|skipTmp
init|=
name|conf
operator|.
name|getBoolean
argument_list|(
name|CONF_SKIP_TMP
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|Path
name|snapshotDir
init|=
name|SnapshotDescriptionUtils
operator|.
name|getCompletedSnapshotDir
argument_list|(
name|snapshotName
argument_list|,
name|inputRoot
argument_list|)
decl_stmt|;
name|Path
name|snapshotTmpDir
init|=
name|SnapshotDescriptionUtils
operator|.
name|getWorkingSnapshotDir
argument_list|(
name|targetName
argument_list|,
name|outputRoot
argument_list|)
decl_stmt|;
name|Path
name|outputSnapshotDir
init|=
name|SnapshotDescriptionUtils
operator|.
name|getCompletedSnapshotDir
argument_list|(
name|targetName
argument_list|,
name|outputRoot
argument_list|)
decl_stmt|;
name|Path
name|initialOutputSnapshotDir
init|=
name|skipTmp
condition|?
name|outputSnapshotDir
else|:
name|snapshotTmpDir
decl_stmt|;
comment|// Find the necessary directory which need to change owner and group
name|Path
name|needSetOwnerDir
init|=
name|SnapshotDescriptionUtils
operator|.
name|getSnapshotRootDir
argument_list|(
name|outputRoot
argument_list|)
decl_stmt|;
if|if
condition|(
name|outputFs
operator|.
name|exists
argument_list|(
name|needSetOwnerDir
argument_list|)
condition|)
block|{
if|if
condition|(
name|skipTmp
condition|)
block|{
name|needSetOwnerDir
operator|=
name|outputSnapshotDir
expr_stmt|;
block|}
else|else
block|{
name|needSetOwnerDir
operator|=
name|SnapshotDescriptionUtils
operator|.
name|getWorkingSnapshotDir
argument_list|(
name|outputRoot
argument_list|)
expr_stmt|;
if|if
condition|(
name|outputFs
operator|.
name|exists
argument_list|(
name|needSetOwnerDir
argument_list|)
condition|)
block|{
name|needSetOwnerDir
operator|=
name|snapshotTmpDir
expr_stmt|;
block|}
block|}
block|}
comment|// Check if the snapshot already exists
if|if
condition|(
name|outputFs
operator|.
name|exists
argument_list|(
name|outputSnapshotDir
argument_list|)
condition|)
block|{
if|if
condition|(
name|overwrite
condition|)
block|{
if|if
condition|(
operator|!
name|outputFs
operator|.
name|delete
argument_list|(
name|outputSnapshotDir
argument_list|,
literal|true
argument_list|)
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Unable to remove existing snapshot directory: "
operator|+
name|outputSnapshotDir
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
else|else
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"The snapshot '"
operator|+
name|targetName
operator|+
literal|"' already exists in the destination: "
operator|+
name|outputSnapshotDir
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
if|if
condition|(
operator|!
name|skipTmp
condition|)
block|{
comment|// Check if the snapshot already in-progress
if|if
condition|(
name|outputFs
operator|.
name|exists
argument_list|(
name|snapshotTmpDir
argument_list|)
condition|)
block|{
if|if
condition|(
name|overwrite
condition|)
block|{
if|if
condition|(
operator|!
name|outputFs
operator|.
name|delete
argument_list|(
name|snapshotTmpDir
argument_list|,
literal|true
argument_list|)
condition|)
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Unable to remove existing snapshot tmp directory: "
operator|+
name|snapshotTmpDir
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
else|else
block|{
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"A snapshot with the same name '"
operator|+
name|targetName
operator|+
literal|"' may be in-progress"
argument_list|)
expr_stmt|;
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"Please check "
operator|+
name|snapshotTmpDir
operator|+
literal|". If the snapshot has completed, "
argument_list|)
expr_stmt|;
name|System
operator|.
name|err
operator|.
name|println
argument_list|(
literal|"consider removing "
operator|+
name|snapshotTmpDir
operator|+
literal|" by using the -overwrite option"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
block|}
comment|// Step 1 - Copy fs1:/.snapshot/<snapshot> to  fs2:/.snapshot/.tmp/<snapshot>
comment|// The snapshot references must be copied before the hfiles otherwise the cleaner
comment|// will remove them because they are unreferenced.
name|List
argument_list|<
name|Path
argument_list|>
name|travesedPaths
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|boolean
name|copySucceeded
init|=
literal|false
decl_stmt|;
try|try
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Copy Snapshot Manifest from "
operator|+
name|snapshotDir
operator|+
literal|" to "
operator|+
name|initialOutputSnapshotDir
argument_list|)
expr_stmt|;
name|travesedPaths
operator|=
name|FSUtils
operator|.
name|copyFilesParallel
argument_list|(
name|inputFs
argument_list|,
name|snapshotDir
argument_list|,
name|outputFs
argument_list|,
name|initialOutputSnapshotDir
argument_list|,
name|conf
argument_list|,
name|conf
operator|.
name|getInt
argument_list|(
name|CONF_COPY_MANIFEST_THREADS
argument_list|,
name|DEFAULT_COPY_MANIFEST_THREADS
argument_list|)
argument_list|)
expr_stmt|;
name|copySucceeded
operator|=
literal|true
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ExportSnapshotException
argument_list|(
literal|"Failed to copy the snapshot directory: from="
operator|+
name|snapshotDir
operator|+
literal|" to="
operator|+
name|initialOutputSnapshotDir
argument_list|,
name|e
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|copySucceeded
condition|)
block|{
if|if
condition|(
name|filesUser
operator|!=
literal|null
operator|||
name|filesGroup
operator|!=
literal|null
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
operator|(
name|filesUser
operator|==
literal|null
condition|?
literal|""
else|:
literal|"Change the owner of "
operator|+
name|needSetOwnerDir
operator|+
literal|" to "
operator|+
name|filesUser
operator|)
operator|+
operator|(
name|filesGroup
operator|==
literal|null
condition|?
literal|""
else|:
literal|", Change the group of "
operator|+
name|needSetOwnerDir
operator|+
literal|" to "
operator|+
name|filesGroup
operator|)
argument_list|)
expr_stmt|;
name|setOwnerParallel
argument_list|(
name|outputFs
argument_list|,
name|filesUser
argument_list|,
name|filesGroup
argument_list|,
name|conf
argument_list|,
name|travesedPaths
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|filesMode
operator|>
literal|0
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Change the permission of "
operator|+
name|needSetOwnerDir
operator|+
literal|" to "
operator|+
name|filesMode
argument_list|)
expr_stmt|;
name|setPermissionParallel
argument_list|(
name|outputFs
argument_list|,
operator|(
name|short
operator|)
name|filesMode
argument_list|,
name|travesedPaths
argument_list|,
name|conf
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|// Write a new .snapshotinfo if the target name is different from the source name
if|if
condition|(
operator|!
name|targetName
operator|.
name|equals
argument_list|(
name|snapshotName
argument_list|)
condition|)
block|{
name|SnapshotDescription
name|snapshotDesc
init|=
name|SnapshotDescriptionUtils
operator|.
name|readSnapshotInfo
argument_list|(
name|inputFs
argument_list|,
name|snapshotDir
argument_list|)
operator|.
name|toBuilder
argument_list|()
operator|.
name|setName
argument_list|(
name|targetName
argument_list|)
operator|.
name|build
argument_list|()
decl_stmt|;
name|SnapshotDescriptionUtils
operator|.
name|writeSnapshotInfo
argument_list|(
name|snapshotDesc
argument_list|,
name|initialOutputSnapshotDir
argument_list|,
name|outputFs
argument_list|)
expr_stmt|;
if|if
condition|(
name|filesUser
operator|!=
literal|null
operator|||
name|filesGroup
operator|!=
literal|null
condition|)
block|{
name|outputFs
operator|.
name|setOwner
argument_list|(
operator|new
name|Path
argument_list|(
name|initialOutputSnapshotDir
argument_list|,
name|SnapshotDescriptionUtils
operator|.
name|SNAPSHOTINFO_FILE
argument_list|)
argument_list|,
name|filesUser
argument_list|,
name|filesGroup
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|filesMode
operator|>
literal|0
condition|)
block|{
name|outputFs
operator|.
name|setPermission
argument_list|(
operator|new
name|Path
argument_list|(
name|initialOutputSnapshotDir
argument_list|,
name|SnapshotDescriptionUtils
operator|.
name|SNAPSHOTINFO_FILE
argument_list|)
argument_list|,
operator|new
name|FsPermission
argument_list|(
operator|(
name|short
operator|)
name|filesMode
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Step 2 - Start MR Job to copy files
comment|// The snapshot references must be copied before the files otherwise the files gets removed
comment|// by the HFileArchiver, since they have no references.
try|try
block|{
name|runCopyJob
argument_list|(
name|inputRoot
argument_list|,
name|outputRoot
argument_list|,
name|snapshotName
argument_list|,
name|snapshotDir
argument_list|,
name|verifyChecksum
argument_list|,
name|filesUser
argument_list|,
name|filesGroup
argument_list|,
name|filesMode
argument_list|,
name|mappers
argument_list|,
name|bandwidthMB
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Finalize the Snapshot Export"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|skipTmp
condition|)
block|{
comment|// Step 3 - Rename fs2:/.snapshot/.tmp/<snapshot> fs2:/.snapshot/<snapshot>
if|if
condition|(
operator|!
name|outputFs
operator|.
name|rename
argument_list|(
name|snapshotTmpDir
argument_list|,
name|outputSnapshotDir
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|ExportSnapshotException
argument_list|(
literal|"Unable to rename snapshot directory from="
operator|+
name|snapshotTmpDir
operator|+
literal|" to="
operator|+
name|outputSnapshotDir
argument_list|)
throw|;
block|}
block|}
comment|// Step 4 - Verify snapshot integrity
if|if
condition|(
name|verifyTarget
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Verify snapshot integrity"
argument_list|)
expr_stmt|;
name|verifySnapshot
argument_list|(
name|destConf
argument_list|,
name|outputFs
argument_list|,
name|outputRoot
argument_list|,
name|outputSnapshotDir
argument_list|)
expr_stmt|;
block|}
name|LOG
operator|.
name|info
argument_list|(
literal|"Export Completed: "
operator|+
name|targetName
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Snapshot export failed"
argument_list|,
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|skipTmp
condition|)
block|{
name|outputFs
operator|.
name|delete
argument_list|(
name|snapshotTmpDir
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
name|outputFs
operator|.
name|delete
argument_list|(
name|outputSnapshotDir
argument_list|,
literal|true
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
finally|finally
block|{
name|IOUtils
operator|.
name|closeStream
argument_list|(
name|inputFs
argument_list|)
expr_stmt|;
name|IOUtils
operator|.
name|closeStream
argument_list|(
name|outputFs
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
specifier|protected
name|void
name|printUsage
parameter_list|()
block|{
name|super
operator|.
name|printUsage
argument_list|()
expr_stmt|;
name|System
operator|.
name|out
operator|.
name|println
argument_list|(
literal|"\n"
operator|+
literal|"Examples:\n"
operator|+
literal|"  hbase snapshot export \\\n"
operator|+
literal|"    --snapshot MySnapshot --copy-to hdfs://srv2:8082/hbase \\\n"
operator|+
literal|"    --chuser MyUser --chgroup MyGroup --chmod 700 --mappers 16\n"
operator|+
literal|"\n"
operator|+
literal|"  hbase snapshot export \\\n"
operator|+
literal|"    --snapshot MySnapshot --copy-from hdfs://srv2:8082/hbase \\\n"
operator|+
literal|"    --copy-to hdfs://srv1:50070/hbase"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|protected
name|void
name|addOptions
parameter_list|()
block|{
name|addRequiredOption
argument_list|(
name|Options
operator|.
name|SNAPSHOT
argument_list|)
expr_stmt|;
name|addOption
argument_list|(
name|Options
operator|.
name|COPY_TO
argument_list|)
expr_stmt|;
name|addOption
argument_list|(
name|Options
operator|.
name|COPY_FROM
argument_list|)
expr_stmt|;
name|addOption
argument_list|(
name|Options
operator|.
name|TARGET_NAME
argument_list|)
expr_stmt|;
name|addOption
argument_list|(
name|Options
operator|.
name|NO_CHECKSUM_VERIFY
argument_list|)
expr_stmt|;
name|addOption
argument_list|(
name|Options
operator|.
name|NO_TARGET_VERIFY
argument_list|)
expr_stmt|;
name|addOption
argument_list|(
name|Options
operator|.
name|OVERWRITE
argument_list|)
expr_stmt|;
name|addOption
argument_list|(
name|Options
operator|.
name|CHUSER
argument_list|)
expr_stmt|;
name|addOption
argument_list|(
name|Options
operator|.
name|CHGROUP
argument_list|)
expr_stmt|;
name|addOption
argument_list|(
name|Options
operator|.
name|CHMOD
argument_list|)
expr_stmt|;
name|addOption
argument_list|(
name|Options
operator|.
name|MAPPERS
argument_list|)
expr_stmt|;
name|addOption
argument_list|(
name|Options
operator|.
name|BANDWIDTH
argument_list|)
expr_stmt|;
block|}
specifier|public
specifier|static
name|void
name|main
parameter_list|(
name|String
index|[]
name|args
parameter_list|)
block|{
operator|new
name|ExportSnapshot
argument_list|()
operator|.
name|doStaticMain
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

