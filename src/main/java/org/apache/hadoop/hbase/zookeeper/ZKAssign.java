begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Copyright 2010 The Apache Software Foundation  *  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|zookeeper
package|;
end_package

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|HRegionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|ServerName
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|executor
operator|.
name|RegionTransitionData
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|executor
operator|.
name|EventHandler
operator|.
name|EventType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|zookeeper
operator|.
name|AsyncCallback
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|zookeeper
operator|.
name|KeeperException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|zookeeper
operator|.
name|KeeperException
operator|.
name|Code
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|zookeeper
operator|.
name|KeeperException
operator|.
name|NoNodeException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|zookeeper
operator|.
name|KeeperException
operator|.
name|NodeExistsException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|zookeeper
operator|.
name|data
operator|.
name|Stat
import|;
end_import

begin_comment
comment|/**  * Utility class for doing region assignment in ZooKeeper.  This class extends  * stuff done in {@link ZKUtil} to cover specific assignment operations.  *<p>  * Contains only static methods and constants.  *<p>  * Used by both the Master and RegionServer.  *<p>  * All valid transitions outlined below:  *<p>  *<b>MASTER</b>  *<ol>  *<li>  *     Master creates an unassigned node as OFFLINE.  *     - Cluster startup and table enabling.  *</li>  *<li>  *     Master forces an existing unassigned node to OFFLINE.  *     - RegionServer failure.  *     - Allows transitions from all states to OFFLINE.  *</li>  *<li>  *     Master deletes an unassigned node that was in a OPENED state.  *     - Normal region transitions.  Besides cluster startup, no other deletions  *     of unassigned nodes is allowed.  *</li>  *<li>  *     Master deletes all unassigned nodes regardless of state.  *     - Cluster startup before any assignment happens.  *</li>  *</ol>  *<p>  *<b>REGIONSERVER</b>  *<ol>  *<li>  *     RegionServer creates an unassigned node as CLOSING.  *     - All region closes will do this in response to a CLOSE RPC from Master.  *     - A node can never be transitioned to CLOSING, only created.  *</li>  *<li>  *     RegionServer transitions an unassigned node from CLOSING to CLOSED.  *     - Normal region closes.  CAS operation.  *</li>  *<li>  *     RegionServer transitions an unassigned node from OFFLINE to OPENING.  *     - All region opens will do this in response to an OPEN RPC from the Master.  *     - Normal region opens.  CAS operation.  *</li>  *<li>  *     RegionServer transitions an unassigned node from OPENING to OPENED.  *     - Normal region opens.  CAS operation.  *</li>  *</ol>  */
end_comment

begin_class
specifier|public
class|class
name|ZKAssign
block|{
specifier|private
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|ZKAssign
operator|.
name|class
argument_list|)
decl_stmt|;
comment|/**    * Gets the full path node name for the unassigned node for the specified    * region.    * @param zkw zk reference    * @param regionName region name    * @return full path node name    */
specifier|public
specifier|static
name|String
name|getNodeName
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|String
name|regionName
parameter_list|)
block|{
return|return
name|ZKUtil
operator|.
name|joinZNode
argument_list|(
name|zkw
operator|.
name|assignmentZNode
argument_list|,
name|regionName
argument_list|)
return|;
block|}
comment|/**    * Gets the region name from the full path node name of an unassigned node.    * @param path full zk path    * @return region name    */
specifier|public
specifier|static
name|String
name|getRegionName
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|String
name|path
parameter_list|)
block|{
return|return
name|path
operator|.
name|substring
argument_list|(
name|zkw
operator|.
name|assignmentZNode
operator|.
name|length
argument_list|()
operator|+
literal|1
argument_list|)
return|;
block|}
comment|// Master methods
comment|/**    * Creates a new unassigned node in the OFFLINE state for the specified region.    *    *<p>Does not transition nodes from other states.  If a node already exists    * for this region, a {@link NodeExistsException} will be thrown.    *    *<p>Sets a watcher on the unassigned region node if the method is successful.    *    *<p>This method should only be used during cluster startup and the enabling    * of a table.    *    * @param zkw zk reference    * @param region region to be created as offline    * @param serverName server event originates from    * @throws KeeperException if unexpected zookeeper exception    * @throws KeeperException.NodeExistsException if node already exists    */
specifier|public
specifier|static
name|void
name|createNodeOffline
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|HRegionInfo
name|region
parameter_list|,
name|ServerName
name|serverName
parameter_list|)
throws|throws
name|KeeperException
throws|,
name|KeeperException
operator|.
name|NodeExistsException
block|{
name|createNodeOffline
argument_list|(
name|zkw
argument_list|,
name|region
argument_list|,
name|serverName
argument_list|,
name|EventType
operator|.
name|M_ZK_REGION_OFFLINE
argument_list|)
expr_stmt|;
block|}
specifier|public
specifier|static
name|void
name|createNodeOffline
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|HRegionInfo
name|region
parameter_list|,
name|ServerName
name|serverName
parameter_list|,
specifier|final
name|EventType
name|event
parameter_list|)
throws|throws
name|KeeperException
throws|,
name|KeeperException
operator|.
name|NodeExistsException
block|{
name|LOG
operator|.
name|debug
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Creating unassigned node for "
operator|+
name|region
operator|.
name|getEncodedName
argument_list|()
operator|+
literal|" in OFFLINE state"
argument_list|)
argument_list|)
expr_stmt|;
name|RegionTransitionData
name|data
init|=
operator|new
name|RegionTransitionData
argument_list|(
name|event
argument_list|,
name|region
operator|.
name|getRegionName
argument_list|()
argument_list|,
name|serverName
argument_list|)
decl_stmt|;
synchronized|synchronized
init|(
name|zkw
operator|.
name|getNodes
argument_list|()
init|)
block|{
name|String
name|node
init|=
name|getNodeName
argument_list|(
name|zkw
argument_list|,
name|region
operator|.
name|getEncodedName
argument_list|()
argument_list|)
decl_stmt|;
name|zkw
operator|.
name|getNodes
argument_list|()
operator|.
name|add
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|ZKUtil
operator|.
name|createAndWatch
argument_list|(
name|zkw
argument_list|,
name|node
argument_list|,
name|data
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Creates an unassigned node in the OFFLINE state for the specified region.    *<p>    * Runs asynchronously.  Depends on no pre-existing znode.    *    *<p>Sets a watcher on the unassigned region node.    *    * @param zkw zk reference    * @param region region to be created as offline    * @param serverName server event originates from    * @param cb    * @param ctx    * @throws KeeperException if unexpected zookeeper exception    * @throws KeeperException.NodeExistsException if node already exists    */
specifier|public
specifier|static
name|void
name|asyncCreateNodeOffline
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|HRegionInfo
name|region
parameter_list|,
name|ServerName
name|serverName
parameter_list|,
specifier|final
name|AsyncCallback
operator|.
name|StringCallback
name|cb
parameter_list|,
specifier|final
name|Object
name|ctx
parameter_list|)
throws|throws
name|KeeperException
block|{
name|LOG
operator|.
name|debug
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Async create of unassigned node for "
operator|+
name|region
operator|.
name|getEncodedName
argument_list|()
operator|+
literal|" with OFFLINE state"
argument_list|)
argument_list|)
expr_stmt|;
name|RegionTransitionData
name|data
init|=
operator|new
name|RegionTransitionData
argument_list|(
name|EventType
operator|.
name|M_ZK_REGION_OFFLINE
argument_list|,
name|region
operator|.
name|getRegionName
argument_list|()
argument_list|,
name|serverName
argument_list|)
decl_stmt|;
synchronized|synchronized
init|(
name|zkw
operator|.
name|getNodes
argument_list|()
init|)
block|{
name|String
name|node
init|=
name|getNodeName
argument_list|(
name|zkw
argument_list|,
name|region
operator|.
name|getEncodedName
argument_list|()
argument_list|)
decl_stmt|;
name|zkw
operator|.
name|getNodes
argument_list|()
operator|.
name|add
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|ZKUtil
operator|.
name|asyncCreate
argument_list|(
name|zkw
argument_list|,
name|node
argument_list|,
name|data
operator|.
name|getBytes
argument_list|()
argument_list|,
name|cb
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Forces an existing unassigned node to the OFFLINE state for the specified    * region.    *    *<p>Does not create a new node.  If a node does not already exist for this    * region, a {@link NoNodeException} will be thrown.    *    *<p>Sets a watcher on the unassigned region node if the method is    * successful.    *    *<p>This method should only be used during recovery of regionserver failure.    *    * @param zkw zk reference    * @param region region to be forced as offline    * @param serverName server event originates from    * @throws KeeperException if unexpected zookeeper exception    * @throws KeeperException.NoNodeException if node does not exist    */
specifier|public
specifier|static
name|void
name|forceNodeOffline
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|HRegionInfo
name|region
parameter_list|,
name|ServerName
name|serverName
parameter_list|)
throws|throws
name|KeeperException
throws|,
name|KeeperException
operator|.
name|NoNodeException
block|{
name|LOG
operator|.
name|debug
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Forcing existing unassigned node for "
operator|+
name|region
operator|.
name|getEncodedName
argument_list|()
operator|+
literal|" to OFFLINE state"
argument_list|)
argument_list|)
expr_stmt|;
name|RegionTransitionData
name|data
init|=
operator|new
name|RegionTransitionData
argument_list|(
name|EventType
operator|.
name|M_ZK_REGION_OFFLINE
argument_list|,
name|region
operator|.
name|getRegionName
argument_list|()
argument_list|,
name|serverName
argument_list|)
decl_stmt|;
synchronized|synchronized
init|(
name|zkw
operator|.
name|getNodes
argument_list|()
init|)
block|{
name|String
name|node
init|=
name|getNodeName
argument_list|(
name|zkw
argument_list|,
name|region
operator|.
name|getEncodedName
argument_list|()
argument_list|)
decl_stmt|;
name|zkw
operator|.
name|getNodes
argument_list|()
operator|.
name|add
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|ZKUtil
operator|.
name|setData
argument_list|(
name|zkw
argument_list|,
name|node
argument_list|,
name|data
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Creates or force updates an unassigned node to the OFFLINE state for the    * specified region.    *<p>    * Attempts to create the node but if it exists will force it to transition to    * and OFFLINE state.    *    *<p>Sets a watcher on the unassigned region node if the method is    * successful.    *    *<p>This method should be used when assigning a region.    *    * @param zkw zk reference    * @param region region to be created as offline    * @param serverName server event originates from    * @throws KeeperException if unexpected zookeeper exception    * @throws KeeperException.NodeExistsException if node already exists    */
specifier|public
specifier|static
name|boolean
name|createOrForceNodeOffline
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|HRegionInfo
name|region
parameter_list|,
name|ServerName
name|serverName
parameter_list|)
throws|throws
name|KeeperException
block|{
name|LOG
operator|.
name|debug
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Creating (or updating) unassigned node for "
operator|+
name|region
operator|.
name|getEncodedName
argument_list|()
operator|+
literal|" with OFFLINE state"
argument_list|)
argument_list|)
expr_stmt|;
name|RegionTransitionData
name|data
init|=
operator|new
name|RegionTransitionData
argument_list|(
name|EventType
operator|.
name|M_ZK_REGION_OFFLINE
argument_list|,
name|region
operator|.
name|getRegionName
argument_list|()
argument_list|,
name|serverName
argument_list|)
decl_stmt|;
synchronized|synchronized
init|(
name|zkw
operator|.
name|getNodes
argument_list|()
init|)
block|{
name|String
name|node
init|=
name|getNodeName
argument_list|(
name|zkw
argument_list|,
name|region
operator|.
name|getEncodedName
argument_list|()
argument_list|)
decl_stmt|;
name|zkw
operator|.
name|sync
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|zkw
operator|.
name|getNodes
argument_list|()
operator|.
name|add
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|int
name|version
init|=
name|ZKUtil
operator|.
name|checkExists
argument_list|(
name|zkw
argument_list|,
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|version
operator|==
operator|-
literal|1
condition|)
block|{
name|ZKUtil
operator|.
name|createAndWatch
argument_list|(
name|zkw
argument_list|,
name|node
argument_list|,
name|data
operator|.
name|getBytes
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|ZKUtil
operator|.
name|setData
argument_list|(
name|zkw
argument_list|,
name|node
argument_list|,
name|data
operator|.
name|getBytes
argument_list|()
argument_list|,
name|version
argument_list|)
condition|)
block|{
return|return
literal|false
return|;
block|}
else|else
block|{
comment|// We successfully forced to OFFLINE, reset watch and handle if
comment|// the state changed in between our set and the watch
name|RegionTransitionData
name|curData
init|=
name|ZKAssign
operator|.
name|getData
argument_list|(
name|zkw
argument_list|,
name|region
operator|.
name|getEncodedName
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|curData
operator|.
name|getEventType
argument_list|()
operator|!=
name|data
operator|.
name|getEventType
argument_list|()
condition|)
block|{
comment|// state changed, need to process
return|return
literal|false
return|;
block|}
block|}
block|}
block|}
return|return
literal|true
return|;
block|}
comment|/**    * Deletes an existing unassigned node that is in the OPENED state for the    * specified region.    *    *<p>If a node does not already exist for this region, a    * {@link NoNodeException} will be thrown.    *    *<p>No watcher is set whether this succeeds or not.    *    *<p>Returns false if the node was not in the proper state but did exist.    *    *<p>This method is used during normal region transitions when a region    * finishes successfully opening.  This is the Master acknowledging completion    * of the specified regions transition.    *    * @param zkw zk reference    * @param regionName opened region to be deleted from zk    * @throws KeeperException if unexpected zookeeper exception    * @throws KeeperException.NoNodeException if node does not exist    */
specifier|public
specifier|static
name|boolean
name|deleteOpenedNode
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|String
name|regionName
parameter_list|)
throws|throws
name|KeeperException
throws|,
name|KeeperException
operator|.
name|NoNodeException
block|{
return|return
name|deleteNode
argument_list|(
name|zkw
argument_list|,
name|regionName
argument_list|,
name|EventType
operator|.
name|RS_ZK_REGION_OPENED
argument_list|)
return|;
block|}
comment|/**    * Deletes an existing unassigned node that is in the OFFLINE state for the    * specified region.    *    *<p>If a node does not already exist for this region, a    * {@link NoNodeException} will be thrown.    *    *<p>No watcher is set whether this succeeds or not.    *    *<p>Returns false if the node was not in the proper state but did exist.    *    *<p>This method is used during master failover when the regions on an RS    * that has died are all set to OFFLINE before being processed.    *    * @param zkw zk reference    * @param regionName closed region to be deleted from zk    * @throws KeeperException if unexpected zookeeper exception    * @throws KeeperException.NoNodeException if node does not exist    */
specifier|public
specifier|static
name|boolean
name|deleteOfflineNode
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|String
name|regionName
parameter_list|)
throws|throws
name|KeeperException
throws|,
name|KeeperException
operator|.
name|NoNodeException
block|{
return|return
name|deleteNode
argument_list|(
name|zkw
argument_list|,
name|regionName
argument_list|,
name|EventType
operator|.
name|M_ZK_REGION_OFFLINE
argument_list|)
return|;
block|}
comment|/**    * Deletes an existing unassigned node that is in the CLOSED state for the    * specified region.    *    *<p>If a node does not already exist for this region, a    * {@link NoNodeException} will be thrown.    *    *<p>No watcher is set whether this succeeds or not.    *    *<p>Returns false if the node was not in the proper state but did exist.    *    *<p>This method is used during table disables when a region finishes    * successfully closing.  This is the Master acknowledging completion    * of the specified regions transition to being closed.    *    * @param zkw zk reference    * @param regionName closed region to be deleted from zk    * @throws KeeperException if unexpected zookeeper exception    * @throws KeeperException.NoNodeException if node does not exist    */
specifier|public
specifier|static
name|boolean
name|deleteClosedNode
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|String
name|regionName
parameter_list|)
throws|throws
name|KeeperException
throws|,
name|KeeperException
operator|.
name|NoNodeException
block|{
return|return
name|deleteNode
argument_list|(
name|zkw
argument_list|,
name|regionName
argument_list|,
name|EventType
operator|.
name|RS_ZK_REGION_CLOSED
argument_list|)
return|;
block|}
comment|/**    * Deletes an existing unassigned node that is in the CLOSING state for the    * specified region.    *    *<p>If a node does not already exist for this region, a    * {@link NoNodeException} will be thrown.    *    *<p>No watcher is set whether this succeeds or not.    *    *<p>Returns false if the node was not in the proper state but did exist.    *    *<p>This method is used during table disables when a region finishes    * successfully closing.  This is the Master acknowledging completion    * of the specified regions transition to being closed.    *    * @param zkw zk reference    * @param region closing region to be deleted from zk    * @throws KeeperException if unexpected zookeeper exception    * @throws KeeperException.NoNodeException if node does not exist    */
specifier|public
specifier|static
name|boolean
name|deleteClosingNode
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|HRegionInfo
name|region
parameter_list|)
throws|throws
name|KeeperException
throws|,
name|KeeperException
operator|.
name|NoNodeException
block|{
name|String
name|regionName
init|=
name|region
operator|.
name|getEncodedName
argument_list|()
decl_stmt|;
return|return
name|deleteNode
argument_list|(
name|zkw
argument_list|,
name|regionName
argument_list|,
name|EventType
operator|.
name|RS_ZK_REGION_CLOSING
argument_list|)
return|;
block|}
comment|/**    * Deletes an existing unassigned node that is in the specified state for the    * specified region.    *    *<p>If a node does not already exist for this region, a    * {@link NoNodeException} will be thrown.    *    *<p>No watcher is set whether this succeeds or not.    *    *<p>Returns false if the node was not in the proper state but did exist.    *    *<p>This method is used during table disables when a region finishes    * successfully closing.  This is the Master acknowledging completion    * of the specified regions transition to being closed.    *    * @param zkw zk reference    * @param regionName region to be deleted from zk    * @param expectedState state region must be in for delete to complete    * @throws KeeperException if unexpected zookeeper exception    * @throws KeeperException.NoNodeException if node does not exist    */
specifier|public
specifier|static
name|boolean
name|deleteNode
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|String
name|regionName
parameter_list|,
name|EventType
name|expectedState
parameter_list|)
throws|throws
name|KeeperException
throws|,
name|KeeperException
operator|.
name|NoNodeException
block|{
name|LOG
operator|.
name|debug
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Deleting existing unassigned "
operator|+
literal|"node for "
operator|+
name|regionName
operator|+
literal|" that is in expected state "
operator|+
name|expectedState
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|node
init|=
name|getNodeName
argument_list|(
name|zkw
argument_list|,
name|regionName
argument_list|)
decl_stmt|;
name|zkw
operator|.
name|sync
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|Stat
name|stat
init|=
operator|new
name|Stat
argument_list|()
decl_stmt|;
name|byte
index|[]
name|bytes
init|=
name|ZKUtil
operator|.
name|getDataNoWatch
argument_list|(
name|zkw
argument_list|,
name|node
argument_list|,
name|stat
argument_list|)
decl_stmt|;
if|if
condition|(
name|bytes
operator|==
literal|null
condition|)
block|{
comment|// If it came back null, node does not exist.
throw|throw
name|KeeperException
operator|.
name|create
argument_list|(
name|Code
operator|.
name|NONODE
argument_list|)
throw|;
block|}
name|RegionTransitionData
name|data
init|=
name|RegionTransitionData
operator|.
name|fromBytes
argument_list|(
name|bytes
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|data
operator|.
name|getEventType
argument_list|()
operator|.
name|equals
argument_list|(
name|expectedState
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Attempting to delete unassigned "
operator|+
literal|"node in "
operator|+
name|expectedState
operator|+
literal|" state but node is in "
operator|+
name|data
operator|.
name|getEventType
argument_list|()
operator|+
literal|" state"
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
synchronized|synchronized
init|(
name|zkw
operator|.
name|getNodes
argument_list|()
init|)
block|{
comment|// TODO: Does this go here or only if we successfully delete node?
name|zkw
operator|.
name|getNodes
argument_list|()
operator|.
name|remove
argument_list|(
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ZKUtil
operator|.
name|deleteNode
argument_list|(
name|zkw
argument_list|,
name|node
argument_list|,
name|stat
operator|.
name|getVersion
argument_list|()
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Attempting to delete "
operator|+
literal|"unassigned node in "
operator|+
name|expectedState
operator|+
literal|" state but after verifying state, we got a version mismatch"
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|false
return|;
block|}
name|LOG
operator|.
name|debug
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Successfully deleted unassigned node for region "
operator|+
name|regionName
operator|+
literal|" in expected state "
operator|+
name|expectedState
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|true
return|;
block|}
block|}
comment|/**    * Deletes all unassigned nodes regardless of their state.    *    *<p>No watchers are set.    *    *<p>This method is used by the Master during cluster startup to clear out    * any existing state from other cluster runs.    *    * @param zkw zk reference    * @throws KeeperException if unexpected zookeeper exception    */
specifier|public
specifier|static
name|void
name|deleteAllNodes
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|)
throws|throws
name|KeeperException
block|{
name|LOG
operator|.
name|debug
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Deleting any existing unassigned nodes"
argument_list|)
argument_list|)
expr_stmt|;
name|ZKUtil
operator|.
name|deleteChildrenRecursively
argument_list|(
name|zkw
argument_list|,
name|zkw
operator|.
name|assignmentZNode
argument_list|)
expr_stmt|;
block|}
comment|// RegionServer methods
comment|/**    * Creates a new unassigned node in the CLOSING state for the specified    * region.    *    *<p>Does not transition nodes from any states.  If a node already exists    * for this region, a {@link NodeExistsException} will be thrown.    *    *<p>If creation is successful, returns the version number of the CLOSING    * node created.    *    *<p>Does not set any watches.    *    *<p>This method should only be used by a RegionServer when initiating a    * close of a region after receiving a CLOSE RPC from the Master.    *    * @param zkw zk reference    * @param region region to be created as closing    * @param serverName server event originates from    * @return version of node after transition, -1 if unsuccessful transition    * @throws KeeperException if unexpected zookeeper exception    * @throws KeeperException.NodeExistsException if node already exists    */
specifier|public
specifier|static
name|int
name|createNodeClosing
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|HRegionInfo
name|region
parameter_list|,
name|ServerName
name|serverName
parameter_list|)
throws|throws
name|KeeperException
throws|,
name|KeeperException
operator|.
name|NodeExistsException
block|{
name|LOG
operator|.
name|debug
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Creating unassigned node for "
operator|+
name|region
operator|.
name|getEncodedName
argument_list|()
operator|+
literal|" in a CLOSING state"
argument_list|)
argument_list|)
expr_stmt|;
name|RegionTransitionData
name|data
init|=
operator|new
name|RegionTransitionData
argument_list|(
name|EventType
operator|.
name|RS_ZK_REGION_CLOSING
argument_list|,
name|region
operator|.
name|getRegionName
argument_list|()
argument_list|,
name|serverName
argument_list|)
decl_stmt|;
synchronized|synchronized
init|(
name|zkw
operator|.
name|getNodes
argument_list|()
init|)
block|{
name|String
name|node
init|=
name|getNodeName
argument_list|(
name|zkw
argument_list|,
name|region
operator|.
name|getEncodedName
argument_list|()
argument_list|)
decl_stmt|;
name|zkw
operator|.
name|getNodes
argument_list|()
operator|.
name|add
argument_list|(
name|node
argument_list|)
expr_stmt|;
return|return
name|ZKUtil
operator|.
name|createAndWatch
argument_list|(
name|zkw
argument_list|,
name|node
argument_list|,
name|data
operator|.
name|getBytes
argument_list|()
argument_list|)
return|;
block|}
block|}
comment|/**    * Transitions an existing unassigned node for the specified region which is    * currently in the CLOSING state to be in the CLOSED state.    *    *<p>Does not transition nodes from other states.  If for some reason the    * node could not be transitioned, the method returns -1.  If the transition    * is successful, the version of the node after transition is returned.    *    *<p>This method can fail and return false for three different reasons:    *<ul><li>Unassigned node for this region does not exist</li>    *<li>Unassigned node for this region is not in CLOSING state</li>    *<li>After verifying CLOSING state, update fails because of wrong version    * (someone else already transitioned the node)</li>    *</ul>    *    *<p>Does not set any watches.    *    *<p>This method should only be used by a RegionServer when initiating a    * close of a region after receiving a CLOSE RPC from the Master.    *    * @param zkw zk reference    * @param region region to be transitioned to closed    * @param serverName server event originates from    * @return version of node after transition, -1 if unsuccessful transition    * @throws KeeperException if unexpected zookeeper exception    */
specifier|public
specifier|static
name|int
name|transitionNodeClosed
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|HRegionInfo
name|region
parameter_list|,
name|ServerName
name|serverName
parameter_list|,
name|int
name|expectedVersion
parameter_list|)
throws|throws
name|KeeperException
block|{
return|return
name|transitionNode
argument_list|(
name|zkw
argument_list|,
name|region
argument_list|,
name|serverName
argument_list|,
name|EventType
operator|.
name|RS_ZK_REGION_CLOSING
argument_list|,
name|EventType
operator|.
name|RS_ZK_REGION_CLOSED
argument_list|,
name|expectedVersion
argument_list|)
return|;
block|}
comment|/**    * Transitions an existing unassigned node for the specified region which is    * currently in the OFFLINE state to be in the OPENING state.    *    *<p>Does not transition nodes from other states.  If for some reason the    * node could not be transitioned, the method returns -1.  If the transition    * is successful, the version of the node written as OPENING is returned.    *    *<p>This method can fail and return -1 for three different reasons:    *<ul><li>Unassigned node for this region does not exist</li>    *<li>Unassigned node for this region is not in OFFLINE state</li>    *<li>After verifying OFFLINE state, update fails because of wrong version    * (someone else already transitioned the node)</li>    *</ul>    *    *<p>Does not set any watches.    *    *<p>This method should only be used by a RegionServer when initiating an    * open of a region after receiving an OPEN RPC from the Master.    *    * @param zkw zk reference    * @param region region to be transitioned to opening    * @param serverName server event originates from    * @return version of node after transition, -1 if unsuccessful transition    * @throws KeeperException if unexpected zookeeper exception    */
specifier|public
specifier|static
name|int
name|transitionNodeOpening
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|HRegionInfo
name|region
parameter_list|,
name|ServerName
name|serverName
parameter_list|)
throws|throws
name|KeeperException
block|{
return|return
name|transitionNodeOpening
argument_list|(
name|zkw
argument_list|,
name|region
argument_list|,
name|serverName
argument_list|,
name|EventType
operator|.
name|M_ZK_REGION_OFFLINE
argument_list|)
return|;
block|}
specifier|public
specifier|static
name|int
name|transitionNodeOpening
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|HRegionInfo
name|region
parameter_list|,
name|ServerName
name|serverName
parameter_list|,
specifier|final
name|EventType
name|beginState
parameter_list|)
throws|throws
name|KeeperException
block|{
return|return
name|transitionNode
argument_list|(
name|zkw
argument_list|,
name|region
argument_list|,
name|serverName
argument_list|,
name|beginState
argument_list|,
name|EventType
operator|.
name|RS_ZK_REGION_OPENING
argument_list|,
operator|-
literal|1
argument_list|)
return|;
block|}
comment|/**    * Retransitions an existing unassigned node for the specified region which is    * currently in the OPENING state to be in the OPENING state.    *    *<p>Does not transition nodes from other states.  If for some reason the    * node could not be transitioned, the method returns -1.  If the transition    * is successful, the version of the node rewritten as OPENING is returned.    *    *<p>This method can fail and return -1 for three different reasons:    *<ul><li>Unassigned node for this region does not exist</li>    *<li>Unassigned node for this region is not in OPENING state</li>    *<li>After verifying OPENING state, update fails because of wrong version    * (someone else already transitioned the node)</li>    *</ul>    *    *<p>Does not set any watches.    *    *<p>This method should only be used by a RegionServer when initiating an    * open of a region after receiving an OPEN RPC from the Master.    *    * @param zkw zk reference    * @param region region to be transitioned to opening    * @param serverName server event originates from    * @return version of node after transition, -1 if unsuccessful transition    * @throws KeeperException if unexpected zookeeper exception    */
specifier|public
specifier|static
name|int
name|retransitionNodeOpening
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|HRegionInfo
name|region
parameter_list|,
name|ServerName
name|serverName
parameter_list|,
name|int
name|expectedVersion
parameter_list|)
throws|throws
name|KeeperException
block|{
return|return
name|transitionNode
argument_list|(
name|zkw
argument_list|,
name|region
argument_list|,
name|serverName
argument_list|,
name|EventType
operator|.
name|RS_ZK_REGION_OPENING
argument_list|,
name|EventType
operator|.
name|RS_ZK_REGION_OPENING
argument_list|,
name|expectedVersion
argument_list|)
return|;
block|}
comment|/**    * Transitions an existing unassigned node for the specified region which is    * currently in the OPENING state to be in the OPENED state.    *    *<p>Does not transition nodes from other states.  If for some reason the    * node could not be transitioned, the method returns -1.  If the transition    * is successful, the version of the node after transition is returned.    *    *<p>This method can fail and return false for three different reasons:    *<ul><li>Unassigned node for this region does not exist</li>    *<li>Unassigned node for this region is not in OPENING state</li>    *<li>After verifying OPENING state, update fails because of wrong version    * (this should never actually happen since an RS only does this transition    * following a transition to OPENING.  if two RS are conflicting, one would    * fail the original transition to OPENING and not this transition)</li>    *</ul>    *    *<p>Does not set any watches.    *    *<p>This method should only be used by a RegionServer when completing the    * open of a region.    *    * @param zkw zk reference    * @param region region to be transitioned to opened    * @param serverName server event originates from    * @return version of node after transition, -1 if unsuccessful transition    * @throws KeeperException if unexpected zookeeper exception    */
specifier|public
specifier|static
name|int
name|transitionNodeOpened
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|HRegionInfo
name|region
parameter_list|,
name|ServerName
name|serverName
parameter_list|,
name|int
name|expectedVersion
parameter_list|)
throws|throws
name|KeeperException
block|{
return|return
name|transitionNode
argument_list|(
name|zkw
argument_list|,
name|region
argument_list|,
name|serverName
argument_list|,
name|EventType
operator|.
name|RS_ZK_REGION_OPENING
argument_list|,
name|EventType
operator|.
name|RS_ZK_REGION_OPENED
argument_list|,
name|expectedVersion
argument_list|)
return|;
block|}
comment|/**    * Method that actually performs unassigned node transitions.    *    *<p>Attempts to transition the unassigned node for the specified region    * from the expected state to the state in the specified transition data.    *    *<p>Method first reads existing data and verifies it is in the expected    * state.  If the node does not exist or the node is not in the expected    * state, the method returns -1.  If the transition is successful, the    * version number of the node following the transition is returned.    *    *<p>If the read state is what is expected, it attempts to write the new    * state and data into the node.  When doing this, it includes the expected    * version (determined when the existing state was verified) to ensure that    * only one transition is successful.  If there is a version mismatch, the    * method returns -1.    *    *<p>If the write is successful, no watch is set and the method returns true.    *    * @param zkw zk reference    * @param region region to be transitioned to opened    * @param serverName server event originates from    * @param endState state to transition node to if all checks pass    * @param beginState state the node must currently be in to do transition    * @param expectedVersion expected version of data before modification, or -1    * @return version of node after transition, -1 if unsuccessful transition    * @throws KeeperException if unexpected zookeeper exception    */
specifier|public
specifier|static
name|int
name|transitionNode
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|HRegionInfo
name|region
parameter_list|,
name|ServerName
name|serverName
parameter_list|,
name|EventType
name|beginState
parameter_list|,
name|EventType
name|endState
parameter_list|,
name|int
name|expectedVersion
parameter_list|)
throws|throws
name|KeeperException
block|{
return|return
name|transitionNode
argument_list|(
name|zkw
argument_list|,
name|region
argument_list|,
name|serverName
argument_list|,
name|beginState
argument_list|,
name|endState
argument_list|,
name|expectedVersion
argument_list|,
literal|null
argument_list|)
return|;
block|}
specifier|public
specifier|static
name|int
name|transitionNode
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|HRegionInfo
name|region
parameter_list|,
name|ServerName
name|serverName
parameter_list|,
name|EventType
name|beginState
parameter_list|,
name|EventType
name|endState
parameter_list|,
name|int
name|expectedVersion
parameter_list|,
specifier|final
name|byte
index|[]
name|payload
parameter_list|)
throws|throws
name|KeeperException
block|{
name|String
name|encoded
init|=
name|region
operator|.
name|getEncodedName
argument_list|()
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Attempting to transition node "
operator|+
name|HRegionInfo
operator|.
name|prettyPrint
argument_list|(
name|encoded
argument_list|)
operator|+
literal|" from "
operator|+
name|beginState
operator|.
name|toString
argument_list|()
operator|+
literal|" to "
operator|+
name|endState
operator|.
name|toString
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|String
name|node
init|=
name|getNodeName
argument_list|(
name|zkw
argument_list|,
name|encoded
argument_list|)
decl_stmt|;
name|zkw
operator|.
name|sync
argument_list|(
name|node
argument_list|)
expr_stmt|;
comment|// Read existing data of the node
name|Stat
name|stat
init|=
operator|new
name|Stat
argument_list|()
decl_stmt|;
name|byte
index|[]
name|existingBytes
init|=
name|ZKUtil
operator|.
name|getDataNoWatch
argument_list|(
name|zkw
argument_list|,
name|node
argument_list|,
name|stat
argument_list|)
decl_stmt|;
if|if
condition|(
name|existingBytes
operator|==
literal|null
condition|)
block|{
comment|// Node no longer exists.  Return -1. It means unsuccessful transition.
return|return
operator|-
literal|1
return|;
block|}
name|RegionTransitionData
name|existingData
init|=
name|RegionTransitionData
operator|.
name|fromBytes
argument_list|(
name|existingBytes
argument_list|)
decl_stmt|;
comment|// Verify it is the expected version
if|if
condition|(
name|expectedVersion
operator|!=
operator|-
literal|1
operator|&&
name|stat
operator|.
name|getVersion
argument_list|()
operator|!=
name|expectedVersion
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Attempt to transition the "
operator|+
literal|"unassigned node for "
operator|+
name|encoded
operator|+
literal|" from "
operator|+
name|beginState
operator|+
literal|" to "
operator|+
name|endState
operator|+
literal|" failed, "
operator|+
literal|"the node existed but was version "
operator|+
name|stat
operator|.
name|getVersion
argument_list|()
operator|+
literal|" not the expected version "
operator|+
name|expectedVersion
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|// Verify it is in expected state
if|if
condition|(
operator|!
name|existingData
operator|.
name|getEventType
argument_list|()
operator|.
name|equals
argument_list|(
name|beginState
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Attempt to transition the "
operator|+
literal|"unassigned node for "
operator|+
name|encoded
operator|+
literal|" from "
operator|+
name|beginState
operator|+
literal|" to "
operator|+
name|endState
operator|+
literal|" failed, "
operator|+
literal|"the node existed but was in the state "
operator|+
name|existingData
operator|.
name|getEventType
argument_list|()
operator|+
literal|" set by the server "
operator|+
name|serverName
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|// Write new data, ensuring data has not changed since we last read it
try|try
block|{
name|RegionTransitionData
name|data
init|=
operator|new
name|RegionTransitionData
argument_list|(
name|endState
argument_list|,
name|region
operator|.
name|getRegionName
argument_list|()
argument_list|,
name|serverName
argument_list|,
name|payload
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|ZKUtil
operator|.
name|setData
argument_list|(
name|zkw
argument_list|,
name|node
argument_list|,
name|data
operator|.
name|getBytes
argument_list|()
argument_list|,
name|stat
operator|.
name|getVersion
argument_list|()
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Attempt to transition the "
operator|+
literal|"unassigned node for "
operator|+
name|encoded
operator|+
literal|" from "
operator|+
name|beginState
operator|+
literal|" to "
operator|+
name|endState
operator|+
literal|" failed, "
operator|+
literal|"the node existed and was in the expected state but then when "
operator|+
literal|"setting data we got a version mismatch"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Successfully transitioned node "
operator|+
name|encoded
operator|+
literal|" from "
operator|+
name|beginState
operator|+
literal|" to "
operator|+
name|endState
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|stat
operator|.
name|getVersion
argument_list|()
operator|+
literal|1
return|;
block|}
catch|catch
parameter_list|(
name|KeeperException
operator|.
name|NoNodeException
name|nne
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
name|zkw
operator|.
name|prefix
argument_list|(
literal|"Attempt to transition the "
operator|+
literal|"unassigned node for "
operator|+
name|encoded
operator|+
literal|" from "
operator|+
name|beginState
operator|+
literal|" to "
operator|+
name|endState
operator|+
literal|" failed, "
operator|+
literal|"the node existed and was in the expected state but then when "
operator|+
literal|"setting data it no longer existed"
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
comment|/**    * Gets the current data in the unassigned node for the specified region name    * or fully-qualified path.    *    *<p>Returns null if the region does not currently have a node.    *    *<p>Sets a watch on the node if the node exists.    *    * @param zkw zk reference    * @param pathOrRegionName fully-specified path or region name    * @return data for the unassigned node    * @throws KeeperException if unexpected zookeeper exception    */
specifier|public
specifier|static
name|RegionTransitionData
name|getData
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|String
name|pathOrRegionName
parameter_list|)
throws|throws
name|KeeperException
block|{
name|String
name|node
init|=
name|pathOrRegionName
operator|.
name|startsWith
argument_list|(
literal|"/"
argument_list|)
condition|?
name|pathOrRegionName
else|:
name|getNodeName
argument_list|(
name|zkw
argument_list|,
name|pathOrRegionName
argument_list|)
decl_stmt|;
name|byte
index|[]
name|data
init|=
name|ZKUtil
operator|.
name|getDataAndWatch
argument_list|(
name|zkw
argument_list|,
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|data
operator|==
literal|null
condition|)
block|{
return|return
literal|null
return|;
block|}
return|return
name|RegionTransitionData
operator|.
name|fromBytes
argument_list|(
name|data
argument_list|)
return|;
block|}
comment|/**    * Gets the current data in the unassigned node for the specified region name    * or fully-qualified path.    *    *<p>Returns null if the region does not currently have a node.    *    *<p>Does not set a watch.    *    * @param zkw zk reference    * @param pathOrRegionName fully-specified path or region name    * @param stat object to store node info into on getData call    * @return data for the unassigned node or null if node does not exist    * @throws KeeperException if unexpected zookeeper exception    */
specifier|public
specifier|static
name|RegionTransitionData
name|getDataNoWatch
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|String
name|pathOrRegionName
parameter_list|,
name|Stat
name|stat
parameter_list|)
throws|throws
name|KeeperException
block|{
name|String
name|node
init|=
name|pathOrRegionName
operator|.
name|startsWith
argument_list|(
literal|"/"
argument_list|)
condition|?
name|pathOrRegionName
else|:
name|getNodeName
argument_list|(
name|zkw
argument_list|,
name|pathOrRegionName
argument_list|)
decl_stmt|;
name|byte
index|[]
name|data
init|=
name|ZKUtil
operator|.
name|getDataNoWatch
argument_list|(
name|zkw
argument_list|,
name|node
argument_list|,
name|stat
argument_list|)
decl_stmt|;
if|if
condition|(
name|data
operator|==
literal|null
condition|)
block|{
return|return
literal|null
return|;
block|}
return|return
name|RegionTransitionData
operator|.
name|fromBytes
argument_list|(
name|data
argument_list|)
return|;
block|}
comment|/**    * Delete the assignment node regardless of its current state.    *<p>    * Fail silent even if the node does not exist at all.    * @param watcher    * @param regionInfo    * @throws KeeperException    */
specifier|public
specifier|static
name|void
name|deleteNodeFailSilent
parameter_list|(
name|ZooKeeperWatcher
name|watcher
parameter_list|,
name|HRegionInfo
name|regionInfo
parameter_list|)
throws|throws
name|KeeperException
block|{
name|String
name|node
init|=
name|getNodeName
argument_list|(
name|watcher
argument_list|,
name|regionInfo
operator|.
name|getEncodedName
argument_list|()
argument_list|)
decl_stmt|;
name|ZKUtil
operator|.
name|deleteNodeFailSilent
argument_list|(
name|watcher
argument_list|,
name|node
argument_list|)
expr_stmt|;
block|}
comment|/**    * Blocks until there are no node in regions in transition.    *<p>    * Used in testing only.    * @param zkw zk reference    * @throws KeeperException    * @throws InterruptedException    */
specifier|public
specifier|static
name|void
name|blockUntilNoRIT
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|)
throws|throws
name|KeeperException
throws|,
name|InterruptedException
block|{
while|while
condition|(
name|ZKUtil
operator|.
name|nodeHasChildren
argument_list|(
name|zkw
argument_list|,
name|zkw
operator|.
name|assignmentZNode
argument_list|)
condition|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|znodes
init|=
name|ZKUtil
operator|.
name|listChildrenAndWatchForNewChildren
argument_list|(
name|zkw
argument_list|,
name|zkw
operator|.
name|assignmentZNode
argument_list|)
decl_stmt|;
if|if
condition|(
name|znodes
operator|!=
literal|null
operator|&&
operator|!
name|znodes
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
for|for
control|(
name|String
name|znode
range|:
name|znodes
control|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"ZK RIT -> "
operator|+
name|znode
argument_list|)
expr_stmt|;
block|}
block|}
name|Thread
operator|.
name|sleep
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Blocks until there is at least one node in regions in transition.    *<p>    * Used in testing only.    * @param zkw zk reference    * @throws KeeperException    * @throws InterruptedException    */
specifier|public
specifier|static
name|void
name|blockUntilRIT
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|)
throws|throws
name|KeeperException
throws|,
name|InterruptedException
block|{
while|while
condition|(
operator|!
name|ZKUtil
operator|.
name|nodeHasChildren
argument_list|(
name|zkw
argument_list|,
name|zkw
operator|.
name|assignmentZNode
argument_list|)
condition|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|znodes
init|=
name|ZKUtil
operator|.
name|listChildrenAndWatchForNewChildren
argument_list|(
name|zkw
argument_list|,
name|zkw
operator|.
name|assignmentZNode
argument_list|)
decl_stmt|;
if|if
condition|(
name|znodes
operator|==
literal|null
operator|||
name|znodes
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"No RIT in ZK"
argument_list|)
expr_stmt|;
block|}
name|Thread
operator|.
name|sleep
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Verifies that the specified region is in the specified state in ZooKeeper.    *<p>    * Returns true if region is in transition and in the specified state in    * ZooKeeper.  Returns false if the region does not exist in ZK or is in    * a different state.    *<p>    * Method synchronizes() with ZK so will yield an up-to-date result but is    * a slow read.    * @param zkw    * @param region    * @param expectedState    * @return true if region exists and is in expected state    */
specifier|public
specifier|static
name|boolean
name|verifyRegionState
parameter_list|(
name|ZooKeeperWatcher
name|zkw
parameter_list|,
name|HRegionInfo
name|region
parameter_list|,
name|EventType
name|expectedState
parameter_list|)
throws|throws
name|KeeperException
block|{
name|String
name|encoded
init|=
name|region
operator|.
name|getEncodedName
argument_list|()
decl_stmt|;
name|String
name|node
init|=
name|getNodeName
argument_list|(
name|zkw
argument_list|,
name|encoded
argument_list|)
decl_stmt|;
name|zkw
operator|.
name|sync
argument_list|(
name|node
argument_list|)
expr_stmt|;
comment|// Read existing data of the node
name|byte
index|[]
name|existingBytes
init|=
literal|null
decl_stmt|;
try|try
block|{
name|existingBytes
operator|=
name|ZKUtil
operator|.
name|getDataAndWatch
argument_list|(
name|zkw
argument_list|,
name|node
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|KeeperException
operator|.
name|NoNodeException
name|nne
parameter_list|)
block|{
return|return
literal|false
return|;
block|}
catch|catch
parameter_list|(
name|KeeperException
name|e
parameter_list|)
block|{
throw|throw
name|e
throw|;
block|}
if|if
condition|(
name|existingBytes
operator|==
literal|null
condition|)
return|return
literal|false
return|;
name|RegionTransitionData
name|existingData
init|=
name|RegionTransitionData
operator|.
name|fromBytes
argument_list|(
name|existingBytes
argument_list|)
decl_stmt|;
if|if
condition|(
name|existingData
operator|.
name|getEventType
argument_list|()
operator|==
name|expectedState
condition|)
block|{
return|return
literal|true
return|;
block|}
return|return
literal|false
return|;
block|}
block|}
end_class

end_unit

