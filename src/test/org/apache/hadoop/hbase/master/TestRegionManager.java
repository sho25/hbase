begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|master
package|;
end_package

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|HBaseClusterTestCase
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|HConstants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|HRegionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|HServerAddress
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|HTableDescriptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|HTable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|util
operator|.
name|Bytes
import|;
end_import

begin_class
specifier|public
class|class
name|TestRegionManager
extends|extends
name|HBaseClusterTestCase
block|{
specifier|public
name|void
name|testGetFirstMetaRegionForRegionAfterMetaSplit
parameter_list|()
throws|throws
name|Exception
block|{
name|HTable
name|meta
init|=
operator|new
name|HTable
argument_list|(
name|HConstants
operator|.
name|META_TABLE_NAME
argument_list|)
decl_stmt|;
name|HMaster
name|master
init|=
name|this
operator|.
name|cluster
operator|.
name|getMaster
argument_list|()
decl_stmt|;
name|HServerAddress
name|address
init|=
name|master
operator|.
name|getMasterAddress
argument_list|()
decl_stmt|;
name|HTableDescriptor
name|tableDesc
init|=
operator|new
name|HTableDescriptor
argument_list|(
name|Bytes
operator|.
name|toBytes
argument_list|(
literal|"_MY_TABLE_"
argument_list|)
argument_list|)
decl_stmt|;
name|HTableDescriptor
name|metaTableDesc
init|=
name|meta
operator|.
name|getTableDescriptor
argument_list|()
decl_stmt|;
comment|// master.regionManager.onlineMetaRegions already contains first .META. region at key Bytes.toBytes("")
name|byte
index|[]
name|startKey0
init|=
name|Bytes
operator|.
name|toBytes
argument_list|(
literal|"f"
argument_list|)
decl_stmt|;
name|byte
index|[]
name|endKey0
init|=
name|Bytes
operator|.
name|toBytes
argument_list|(
literal|"h"
argument_list|)
decl_stmt|;
name|HRegionInfo
name|regionInfo0
init|=
operator|new
name|HRegionInfo
argument_list|(
name|tableDesc
argument_list|,
name|startKey0
argument_list|,
name|endKey0
argument_list|)
decl_stmt|;
comment|// 1st .META. region will be something like .META.,,1253625700761
name|HRegionInfo
name|metaRegionInfo0
init|=
operator|new
name|HRegionInfo
argument_list|(
name|metaTableDesc
argument_list|,
name|Bytes
operator|.
name|toBytes
argument_list|(
literal|""
argument_list|)
argument_list|,
name|regionInfo0
operator|.
name|getRegionName
argument_list|()
argument_list|)
decl_stmt|;
name|MetaRegion
name|meta0
init|=
operator|new
name|MetaRegion
argument_list|(
name|address
argument_list|,
name|metaRegionInfo0
argument_list|)
decl_stmt|;
name|byte
index|[]
name|startKey1
init|=
name|Bytes
operator|.
name|toBytes
argument_list|(
literal|"j"
argument_list|)
decl_stmt|;
name|byte
index|[]
name|endKey1
init|=
name|Bytes
operator|.
name|toBytes
argument_list|(
literal|"m"
argument_list|)
decl_stmt|;
name|HRegionInfo
name|regionInfo1
init|=
operator|new
name|HRegionInfo
argument_list|(
name|tableDesc
argument_list|,
name|startKey1
argument_list|,
name|endKey1
argument_list|)
decl_stmt|;
comment|// 2nd .META. region will be something like .META.,_MY_TABLE_,f,1253625700761,1253625700761
name|HRegionInfo
name|metaRegionInfo1
init|=
operator|new
name|HRegionInfo
argument_list|(
name|metaTableDesc
argument_list|,
name|regionInfo0
operator|.
name|getRegionName
argument_list|()
argument_list|,
name|regionInfo1
operator|.
name|getRegionName
argument_list|()
argument_list|)
decl_stmt|;
name|MetaRegion
name|meta1
init|=
operator|new
name|MetaRegion
argument_list|(
name|address
argument_list|,
name|metaRegionInfo1
argument_list|)
decl_stmt|;
comment|// 3rd .META. region will be something like .META.,_MY_TABLE_,j,1253625700761,1253625700761
name|HRegionInfo
name|metaRegionInfo2
init|=
operator|new
name|HRegionInfo
argument_list|(
name|metaTableDesc
argument_list|,
name|regionInfo1
operator|.
name|getRegionName
argument_list|()
argument_list|,
name|Bytes
operator|.
name|toBytes
argument_list|(
literal|""
argument_list|)
argument_list|)
decl_stmt|;
name|MetaRegion
name|meta2
init|=
operator|new
name|MetaRegion
argument_list|(
name|address
argument_list|,
name|metaRegionInfo2
argument_list|)
decl_stmt|;
name|byte
index|[]
name|startKeyX
init|=
name|Bytes
operator|.
name|toBytes
argument_list|(
literal|"h"
argument_list|)
decl_stmt|;
name|byte
index|[]
name|endKeyX
init|=
name|Bytes
operator|.
name|toBytes
argument_list|(
literal|"j"
argument_list|)
decl_stmt|;
name|HRegionInfo
name|regionInfoX
init|=
operator|new
name|HRegionInfo
argument_list|(
name|tableDesc
argument_list|,
name|startKeyX
argument_list|,
name|endKeyX
argument_list|)
decl_stmt|;
name|master
operator|.
name|regionManager
operator|.
name|offlineMetaRegion
argument_list|(
name|startKey0
argument_list|)
expr_stmt|;
name|master
operator|.
name|regionManager
operator|.
name|putMetaRegionOnline
argument_list|(
name|meta0
argument_list|)
expr_stmt|;
name|master
operator|.
name|regionManager
operator|.
name|putMetaRegionOnline
argument_list|(
name|meta1
argument_list|)
expr_stmt|;
name|master
operator|.
name|regionManager
operator|.
name|putMetaRegionOnline
argument_list|(
name|meta2
argument_list|)
expr_stmt|;
comment|//    for (byte[] b : master.regionManager.getOnlineMetaRegions().keySet()) {
comment|//      System.out.println("FROM TEST KEY " + b +"  " +new String(b));
comment|//    }
name|assertEquals
argument_list|(
name|metaRegionInfo1
operator|.
name|getStartKey
argument_list|()
argument_list|,
name|master
operator|.
name|regionManager
operator|.
name|getFirstMetaRegionForRegion
argument_list|(
name|regionInfoX
argument_list|)
operator|.
name|getStartKey
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
name|metaRegionInfo1
operator|.
name|getRegionName
argument_list|()
argument_list|,
name|master
operator|.
name|regionManager
operator|.
name|getFirstMetaRegionForRegion
argument_list|(
name|regionInfoX
argument_list|)
operator|.
name|getRegionName
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

