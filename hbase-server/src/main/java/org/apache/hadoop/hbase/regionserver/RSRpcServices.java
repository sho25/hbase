begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|regionserver
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileNotFoundException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InterruptedIOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|lang
operator|.
name|reflect
operator|.
name|InvocationTargetException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|BindException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|InetSocketAddress
import|;
end_import

begin_import
import|import
name|java
operator|.
name|net
operator|.
name|UnknownHostException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|nio
operator|.
name|ByteBuffer
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Iterator
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
operator|.
name|Entry
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|NavigableMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|TreeSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ConcurrentHashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ConcurrentMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|TimeUnit
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicBoolean
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicLong
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|LongAdder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|lang3
operator|.
name|mutable
operator|.
name|MutableObject
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|ByteBufferExtendedCell
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|CacheEvictionStats
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|CacheEvictionStatsBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|Cell
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|CellScannable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|CellScanner
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|CellUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|CompareOperator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|DoNotRetryIOException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|DroppedSnapshotException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|HBaseIOException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|HConstants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|MultiActionResultTooLarge
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|NotServingRegionException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|PrivateCellUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|RegionTooBusyException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|Server
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|ServerName
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|TableName
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|UnknownScannerException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|Append
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|ConnectionUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|Delete
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|Durability
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|Get
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|Increment
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|Mutation
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|Put
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|RegionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|RegionReplicaUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|Result
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|Row
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|RowMutations
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|Scan
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|TableDescriptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|client
operator|.
name|VersionInfoUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|conf
operator|.
name|ConfigurationObserver
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|exceptions
operator|.
name|FailedSanityCheckException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|exceptions
operator|.
name|OutOfOrderScannerNextException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|exceptions
operator|.
name|ScannerResetException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|filter
operator|.
name|ByteArrayComparable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|ipc
operator|.
name|HBaseRPCErrorHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|ipc
operator|.
name|HBaseRpcController
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|ipc
operator|.
name|PriorityFunction
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|ipc
operator|.
name|QosPriority
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|ipc
operator|.
name|RpcCallContext
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|ipc
operator|.
name|RpcCallback
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|ipc
operator|.
name|RpcServer
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|ipc
operator|.
name|RpcServer
operator|.
name|BlockingServiceAndInterface
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|ipc
operator|.
name|RpcServerFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|ipc
operator|.
name|RpcServerInterface
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|ipc
operator|.
name|ServerNotRunningYetException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|ipc
operator|.
name|ServerRpcController
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|log
operator|.
name|HBaseMarkers
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|master
operator|.
name|MasterRpcServices
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|net
operator|.
name|Address
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|procedure2
operator|.
name|RSProcedureCallable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|quotas
operator|.
name|ActivePolicyEnforcement
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|quotas
operator|.
name|OperationQuota
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|quotas
operator|.
name|QuotaUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|quotas
operator|.
name|RegionServerRpcQuotaManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|quotas
operator|.
name|RegionServerSpaceQuotaManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|quotas
operator|.
name|SpaceQuotaSnapshot
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|quotas
operator|.
name|SpaceViolationPolicyEnforcement
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|regionserver
operator|.
name|HRegion
operator|.
name|RegionScannerImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|regionserver
operator|.
name|Leases
operator|.
name|Lease
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|regionserver
operator|.
name|Leases
operator|.
name|LeaseStillHeldException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|regionserver
operator|.
name|Region
operator|.
name|Operation
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|regionserver
operator|.
name|ScannerContext
operator|.
name|LimitScope
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|regionserver
operator|.
name|compactions
operator|.
name|CompactionLifeCycleTracker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|regionserver
operator|.
name|handler
operator|.
name|OpenMetaHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|regionserver
operator|.
name|handler
operator|.
name|OpenPriorityRegionHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|regionserver
operator|.
name|handler
operator|.
name|OpenRegionHandler
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|security
operator|.
name|Superusers
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|security
operator|.
name|User
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|security
operator|.
name|access
operator|.
name|AccessChecker
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|security
operator|.
name|access
operator|.
name|Permission
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|util
operator|.
name|Bytes
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|util
operator|.
name|CollectionUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|util
operator|.
name|DNS
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|util
operator|.
name|EnvironmentEdgeManager
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|util
operator|.
name|Pair
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|util
operator|.
name|ServerRegionReplicaUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|util
operator|.
name|Strings
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|wal
operator|.
name|WAL
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|wal
operator|.
name|WALEdit
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|wal
operator|.
name|WALKey
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|wal
operator|.
name|WALSplitter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|zookeeper
operator|.
name|ZKWatcher
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|yetus
operator|.
name|audience
operator|.
name|InterfaceAudience
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hbase
operator|.
name|thirdparty
operator|.
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|annotations
operator|.
name|VisibleForTesting
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hbase
operator|.
name|thirdparty
operator|.
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|cache
operator|.
name|Cache
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hbase
operator|.
name|thirdparty
operator|.
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|cache
operator|.
name|CacheBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hbase
operator|.
name|thirdparty
operator|.
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Lists
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hbase
operator|.
name|thirdparty
operator|.
name|com
operator|.
name|google
operator|.
name|protobuf
operator|.
name|ByteString
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hbase
operator|.
name|thirdparty
operator|.
name|com
operator|.
name|google
operator|.
name|protobuf
operator|.
name|Message
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hbase
operator|.
name|thirdparty
operator|.
name|com
operator|.
name|google
operator|.
name|protobuf
operator|.
name|RpcController
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hbase
operator|.
name|thirdparty
operator|.
name|com
operator|.
name|google
operator|.
name|protobuf
operator|.
name|ServiceException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hbase
operator|.
name|thirdparty
operator|.
name|com
operator|.
name|google
operator|.
name|protobuf
operator|.
name|TextFormat
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hbase
operator|.
name|thirdparty
operator|.
name|com
operator|.
name|google
operator|.
name|protobuf
operator|.
name|UnsafeByteOperations
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|ProtobufUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|RequestConverter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|ResponseConverter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|AdminService
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|ClearCompactionQueuesRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|ClearCompactionQueuesResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|ClearRegionBlockCacheRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|ClearRegionBlockCacheResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|CloseRegionRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|CloseRegionResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|CompactRegionRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|CompactRegionResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|ExecuteProceduresRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|ExecuteProceduresResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|FlushRegionRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|FlushRegionResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|GetOnlineRegionRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|GetOnlineRegionResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|GetRegionInfoRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|GetRegionInfoResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|GetRegionLoadRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|GetRegionLoadResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|GetServerInfoRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|GetServerInfoResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|GetStoreFileRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|GetStoreFileResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|OpenRegionRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|OpenRegionRequest
operator|.
name|RegionOpenInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|OpenRegionResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|OpenRegionResponse
operator|.
name|RegionOpeningState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|RemoteProcedureRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|ReplicateWALEntryRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|ReplicateWALEntryResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|RollWALWriterRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|RollWALWriterResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|StopServerRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|StopServerResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|UpdateConfigurationRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|UpdateConfigurationResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|UpdateFavoredNodesRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|UpdateFavoredNodesResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|WALEntry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|WarmupRegionRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|AdminProtos
operator|.
name|WarmupRegionResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|Action
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|BulkLoadHFileRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|BulkLoadHFileRequest
operator|.
name|FamilyPath
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|BulkLoadHFileResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|CleanupBulkLoadRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|CleanupBulkLoadResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|ClientService
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|Condition
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|CoprocessorServiceRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|CoprocessorServiceResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|GetRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|GetResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|MultiRegionLoadStats
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|MultiRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|MultiResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|MutateRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|MutateResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|MutationProto
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|MutationProto
operator|.
name|MutationType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|PrepareBulkLoadRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|PrepareBulkLoadResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|RegionAction
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|RegionActionResult
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|ResultOrException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|ScanRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClientProtos
operator|.
name|ScanResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClusterStatusProtos
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|ClusterStatusProtos
operator|.
name|RegionLoad
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|HBaseProtos
operator|.
name|NameBytesPair
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|HBaseProtos
operator|.
name|NameInt64Pair
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|HBaseProtos
operator|.
name|RegionSpecifier
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|HBaseProtos
operator|.
name|RegionSpecifier
operator|.
name|RegionSpecifierType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|MapReduceProtos
operator|.
name|ScanMetrics
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|QuotaProtos
operator|.
name|GetSpaceQuotaSnapshotsRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|QuotaProtos
operator|.
name|GetSpaceQuotaSnapshotsResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|QuotaProtos
operator|.
name|GetSpaceQuotaSnapshotsResponse
operator|.
name|TableQuotaSnapshot
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|RPCProtos
operator|.
name|RequestHeader
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|WALProtos
operator|.
name|BulkLoadDescriptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|WALProtos
operator|.
name|CompactionDescriptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|WALProtos
operator|.
name|FlushDescriptor
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|WALProtos
operator|.
name|RegionEventDescriptor
import|;
end_import

begin_comment
comment|/**  * Implements the regionserver RPC services.  */
end_comment

begin_class
annotation|@
name|InterfaceAudience
operator|.
name|Private
annotation|@
name|SuppressWarnings
argument_list|(
literal|"deprecation"
argument_list|)
specifier|public
class|class
name|RSRpcServices
implements|implements
name|HBaseRPCErrorHandler
implements|,
name|AdminService
operator|.
name|BlockingInterface
implements|,
name|ClientService
operator|.
name|BlockingInterface
implements|,
name|PriorityFunction
implements|,
name|ConfigurationObserver
block|{
specifier|protected
specifier|static
specifier|final
name|Logger
name|LOG
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|RSRpcServices
operator|.
name|class
argument_list|)
decl_stmt|;
comment|/** RPC scheduler to use for the region server. */
specifier|public
specifier|static
specifier|final
name|String
name|REGION_SERVER_RPC_SCHEDULER_FACTORY_CLASS
init|=
literal|"hbase.region.server.rpc.scheduler.factory.class"
decl_stmt|;
comment|/**    * Minimum allowable time limit delta (in milliseconds) that can be enforced during scans. This    * configuration exists to prevent the scenario where a time limit is specified to be so    * restrictive that the time limit is reached immediately (before any cells are scanned).    */
specifier|private
specifier|static
specifier|final
name|String
name|REGION_SERVER_RPC_MINIMUM_SCAN_TIME_LIMIT_DELTA
init|=
literal|"hbase.region.server.rpc.minimum.scan.time.limit.delta"
decl_stmt|;
comment|/**    * Default value of {@link RSRpcServices#REGION_SERVER_RPC_MINIMUM_SCAN_TIME_LIMIT_DELTA}    */
specifier|private
specifier|static
specifier|final
name|long
name|DEFAULT_REGION_SERVER_RPC_MINIMUM_SCAN_TIME_LIMIT_DELTA
init|=
literal|10
decl_stmt|;
comment|/**    * Number of rows in a batch operation above which a warning will be logged.    */
specifier|static
specifier|final
name|String
name|BATCH_ROWS_THRESHOLD_NAME
init|=
literal|"hbase.rpc.rows.warning.threshold"
decl_stmt|;
comment|/**    * Default value of {@link RSRpcServices#BATCH_ROWS_THRESHOLD_NAME}    */
specifier|static
specifier|final
name|int
name|BATCH_ROWS_THRESHOLD_DEFAULT
init|=
literal|5000
decl_stmt|;
specifier|protected
specifier|static
specifier|final
name|String
name|RESERVOIR_ENABLED_KEY
init|=
literal|"hbase.ipc.server.reservoir.enabled"
decl_stmt|;
comment|// Request counter. (Includes requests that are not serviced by regions.)
comment|// Count only once for requests with multiple actions like multi/caching-scan/replayBatch
specifier|final
name|LongAdder
name|requestCount
init|=
operator|new
name|LongAdder
argument_list|()
decl_stmt|;
comment|// Request counter for rpc get
specifier|final
name|LongAdder
name|rpcGetRequestCount
init|=
operator|new
name|LongAdder
argument_list|()
decl_stmt|;
comment|// Request counter for rpc scan
specifier|final
name|LongAdder
name|rpcScanRequestCount
init|=
operator|new
name|LongAdder
argument_list|()
decl_stmt|;
comment|// Request counter for rpc multi
specifier|final
name|LongAdder
name|rpcMultiRequestCount
init|=
operator|new
name|LongAdder
argument_list|()
decl_stmt|;
comment|// Request counter for rpc mutate
specifier|final
name|LongAdder
name|rpcMutateRequestCount
init|=
operator|new
name|LongAdder
argument_list|()
decl_stmt|;
comment|// Server to handle client requests.
specifier|final
name|RpcServerInterface
name|rpcServer
decl_stmt|;
specifier|final
name|InetSocketAddress
name|isa
decl_stmt|;
specifier|private
specifier|final
name|HRegionServer
name|regionServer
decl_stmt|;
specifier|private
specifier|final
name|long
name|maxScannerResultSize
decl_stmt|;
comment|// The reference to the priority extraction function
specifier|private
specifier|final
name|PriorityFunction
name|priority
decl_stmt|;
specifier|private
name|ScannerIdGenerator
name|scannerIdGenerator
decl_stmt|;
specifier|private
specifier|final
name|ConcurrentMap
argument_list|<
name|String
argument_list|,
name|RegionScannerHolder
argument_list|>
name|scanners
init|=
operator|new
name|ConcurrentHashMap
argument_list|<>
argument_list|()
decl_stmt|;
comment|// Hold the name of a closed scanner for a while. This is used to keep compatible for old clients
comment|// which may send next or close request to a region scanner which has already been exhausted. The
comment|// entries will be removed automatically after scannerLeaseTimeoutPeriod.
specifier|private
specifier|final
name|Cache
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|closedScanners
decl_stmt|;
comment|/**    * The lease timeout period for client scanners (milliseconds).    */
specifier|private
specifier|final
name|int
name|scannerLeaseTimeoutPeriod
decl_stmt|;
comment|/**    * The RPC timeout period (milliseconds)    */
specifier|private
specifier|final
name|int
name|rpcTimeout
decl_stmt|;
comment|/**    * The minimum allowable delta to use for the scan limit    */
specifier|private
specifier|final
name|long
name|minimumScanTimeLimitDelta
decl_stmt|;
comment|/**    * Row size threshold for multi requests above which a warning is logged    */
specifier|private
specifier|final
name|int
name|rowSizeWarnThreshold
decl_stmt|;
specifier|final
name|AtomicBoolean
name|clearCompactionQueues
init|=
operator|new
name|AtomicBoolean
argument_list|(
literal|false
argument_list|)
decl_stmt|;
comment|// We want to vet all accesses at the point of entry itself; limiting scope of access checker
comment|// instance to only this class to prevent its use from spreading deeper into implementation.
comment|// Initialized in start() since AccessChecker needs ZKWatcher which is created by HRegionServer
comment|// after RSRpcServices constructor and before start() is called.
comment|// Initialized only if authorization is enabled, else remains null.
specifier|protected
name|AccessChecker
name|accessChecker
decl_stmt|;
comment|/**    * Services launched in RSRpcServices. By default they are on but you can use the below    * booleans to selectively enable/disable either Admin or Client Service (Rare is the case    * where you would ever turn off one or the other).    */
specifier|public
specifier|static
specifier|final
name|String
name|REGIONSERVER_ADMIN_SERVICE_CONFIG
init|=
literal|"hbase.regionserver.admin.executorService"
decl_stmt|;
specifier|public
specifier|static
specifier|final
name|String
name|REGIONSERVER_CLIENT_SERVICE_CONFIG
init|=
literal|"hbase.regionserver.client.executorService"
decl_stmt|;
comment|/**    * An Rpc callback for closing a RegionScanner.    */
specifier|private
specifier|static
specifier|final
class|class
name|RegionScannerCloseCallBack
implements|implements
name|RpcCallback
block|{
specifier|private
specifier|final
name|RegionScanner
name|scanner
decl_stmt|;
specifier|public
name|RegionScannerCloseCallBack
parameter_list|(
name|RegionScanner
name|scanner
parameter_list|)
block|{
name|this
operator|.
name|scanner
operator|=
name|scanner
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
throws|throws
name|IOException
block|{
name|this
operator|.
name|scanner
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
comment|/**    * An Rpc callback for doing shipped() call on a RegionScanner.    */
specifier|private
class|class
name|RegionScannerShippedCallBack
implements|implements
name|RpcCallback
block|{
specifier|private
specifier|final
name|String
name|scannerName
decl_stmt|;
specifier|private
specifier|final
name|Shipper
name|shipper
decl_stmt|;
specifier|private
specifier|final
name|Lease
name|lease
decl_stmt|;
specifier|public
name|RegionScannerShippedCallBack
parameter_list|(
name|String
name|scannerName
parameter_list|,
name|Shipper
name|shipper
parameter_list|,
name|Lease
name|lease
parameter_list|)
block|{
name|this
operator|.
name|scannerName
operator|=
name|scannerName
expr_stmt|;
name|this
operator|.
name|shipper
operator|=
name|shipper
expr_stmt|;
name|this
operator|.
name|lease
operator|=
name|lease
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
throws|throws
name|IOException
block|{
name|this
operator|.
name|shipper
operator|.
name|shipped
argument_list|()
expr_stmt|;
comment|// We're done. On way out re-add the above removed lease. The lease was temp removed for this
comment|// Rpc call and we are at end of the call now. Time to add it back.
if|if
condition|(
name|scanners
operator|.
name|containsKey
argument_list|(
name|scannerName
argument_list|)
condition|)
block|{
if|if
condition|(
name|lease
operator|!=
literal|null
condition|)
name|regionServer
operator|.
name|leases
operator|.
name|addLease
argument_list|(
name|lease
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**    * An RpcCallBack that creates a list of scanners that needs to perform callBack operation on    * completion of multiGets.    */
specifier|static
class|class
name|RegionScannersCloseCallBack
implements|implements
name|RpcCallback
block|{
specifier|private
specifier|final
name|List
argument_list|<
name|RegionScanner
argument_list|>
name|scanners
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
specifier|public
name|void
name|addScanner
parameter_list|(
name|RegionScanner
name|scanner
parameter_list|)
block|{
name|this
operator|.
name|scanners
operator|.
name|add
argument_list|(
name|scanner
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
for|for
control|(
name|RegionScanner
name|scanner
range|:
name|scanners
control|)
block|{
try|try
block|{
name|scanner
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Exception while closing the scanner "
operator|+
name|scanner
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/**    * Holder class which holds the RegionScanner, nextCallSeq and RpcCallbacks together.    */
specifier|private
specifier|static
specifier|final
class|class
name|RegionScannerHolder
block|{
specifier|private
specifier|final
name|AtomicLong
name|nextCallSeq
init|=
operator|new
name|AtomicLong
argument_list|(
literal|0
argument_list|)
decl_stmt|;
specifier|private
specifier|final
name|String
name|scannerName
decl_stmt|;
specifier|private
specifier|final
name|RegionScanner
name|s
decl_stmt|;
specifier|private
specifier|final
name|HRegion
name|r
decl_stmt|;
specifier|private
specifier|final
name|RpcCallback
name|closeCallBack
decl_stmt|;
specifier|private
specifier|final
name|RpcCallback
name|shippedCallback
decl_stmt|;
specifier|private
name|byte
index|[]
name|rowOfLastPartialResult
decl_stmt|;
specifier|private
name|boolean
name|needCursor
decl_stmt|;
specifier|public
name|RegionScannerHolder
parameter_list|(
name|String
name|scannerName
parameter_list|,
name|RegionScanner
name|s
parameter_list|,
name|HRegion
name|r
parameter_list|,
name|RpcCallback
name|closeCallBack
parameter_list|,
name|RpcCallback
name|shippedCallback
parameter_list|,
name|boolean
name|needCursor
parameter_list|)
block|{
name|this
operator|.
name|scannerName
operator|=
name|scannerName
expr_stmt|;
name|this
operator|.
name|s
operator|=
name|s
expr_stmt|;
name|this
operator|.
name|r
operator|=
name|r
expr_stmt|;
name|this
operator|.
name|closeCallBack
operator|=
name|closeCallBack
expr_stmt|;
name|this
operator|.
name|shippedCallback
operator|=
name|shippedCallback
expr_stmt|;
name|this
operator|.
name|needCursor
operator|=
name|needCursor
expr_stmt|;
block|}
specifier|public
name|long
name|getNextCallSeq
parameter_list|()
block|{
return|return
name|nextCallSeq
operator|.
name|get
argument_list|()
return|;
block|}
specifier|public
name|boolean
name|incNextCallSeq
parameter_list|(
name|long
name|currentSeq
parameter_list|)
block|{
comment|// Use CAS to prevent multiple scan request running on the same scanner.
return|return
name|nextCallSeq
operator|.
name|compareAndSet
argument_list|(
name|currentSeq
argument_list|,
name|currentSeq
operator|+
literal|1
argument_list|)
return|;
block|}
block|}
comment|/**    * Instantiated as a scanner lease. If the lease times out, the scanner is    * closed    */
specifier|private
class|class
name|ScannerListener
implements|implements
name|LeaseListener
block|{
specifier|private
specifier|final
name|String
name|scannerName
decl_stmt|;
name|ScannerListener
parameter_list|(
specifier|final
name|String
name|n
parameter_list|)
block|{
name|this
operator|.
name|scannerName
operator|=
name|n
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|leaseExpired
parameter_list|()
block|{
name|RegionScannerHolder
name|rsh
init|=
name|scanners
operator|.
name|remove
argument_list|(
name|this
operator|.
name|scannerName
argument_list|)
decl_stmt|;
if|if
condition|(
name|rsh
operator|!=
literal|null
condition|)
block|{
name|RegionScanner
name|s
init|=
name|rsh
operator|.
name|s
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Scanner "
operator|+
name|this
operator|.
name|scannerName
operator|+
literal|" lease expired on region "
operator|+
name|s
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getRegionNameAsString
argument_list|()
argument_list|)
expr_stmt|;
name|HRegion
name|region
init|=
literal|null
decl_stmt|;
try|try
block|{
name|region
operator|=
name|regionServer
operator|.
name|getRegion
argument_list|(
name|s
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getRegionName
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|region
operator|!=
literal|null
operator|&&
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|preScannerClose
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Closing scanner for "
operator|+
name|s
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getRegionNameAsString
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
try|try
block|{
name|s
operator|.
name|close
argument_list|()
expr_stmt|;
if|if
condition|(
name|region
operator|!=
literal|null
operator|&&
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|postScannerClose
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Closing scanner for "
operator|+
name|s
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getRegionNameAsString
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Scanner "
operator|+
name|this
operator|.
name|scannerName
operator|+
literal|" lease expired, but no related"
operator|+
literal|" scanner found, hence no chance to close that related scanner!"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|private
specifier|static
name|ResultOrException
name|getResultOrException
parameter_list|(
specifier|final
name|ClientProtos
operator|.
name|Result
name|r
parameter_list|,
specifier|final
name|int
name|index
parameter_list|)
block|{
return|return
name|getResultOrException
argument_list|(
name|ResponseConverter
operator|.
name|buildActionResult
argument_list|(
name|r
argument_list|)
argument_list|,
name|index
argument_list|)
return|;
block|}
specifier|private
specifier|static
name|ResultOrException
name|getResultOrException
parameter_list|(
specifier|final
name|Exception
name|e
parameter_list|,
specifier|final
name|int
name|index
parameter_list|)
block|{
return|return
name|getResultOrException
argument_list|(
name|ResponseConverter
operator|.
name|buildActionResult
argument_list|(
name|e
argument_list|)
argument_list|,
name|index
argument_list|)
return|;
block|}
specifier|private
specifier|static
name|ResultOrException
name|getResultOrException
parameter_list|(
specifier|final
name|ResultOrException
operator|.
name|Builder
name|builder
parameter_list|,
specifier|final
name|int
name|index
parameter_list|)
block|{
return|return
name|builder
operator|.
name|setIndex
argument_list|(
name|index
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
comment|/**    * Checks for the following pre-checks in order:    *<ol>    *<li>RegionServer is running</li>    *<li>If authorization is enabled, then RPC caller has ADMIN permissions</li>    *</ol>    * @param requestName name of rpc request. Used in reporting failures to provide context.    * @throws ServiceException If any of the above listed pre-check fails.    */
specifier|private
name|void
name|rpcPreCheck
parameter_list|(
name|String
name|requestName
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|requirePermission
argument_list|(
name|requestName
argument_list|,
name|Permission
operator|.
name|Action
operator|.
name|ADMIN
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ioe
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ioe
argument_list|)
throw|;
block|}
block|}
comment|/**    * Starts the nonce operation for a mutation, if needed.    * @param mutation Mutation.    * @param nonceGroup Nonce group from the request.    * @returns whether to proceed this mutation.    */
specifier|private
name|boolean
name|startNonceOperation
parameter_list|(
specifier|final
name|MutationProto
name|mutation
parameter_list|,
name|long
name|nonceGroup
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|regionServer
operator|.
name|nonceManager
operator|==
literal|null
operator|||
operator|!
name|mutation
operator|.
name|hasNonce
argument_list|()
condition|)
return|return
literal|true
return|;
name|boolean
name|canProceed
init|=
literal|false
decl_stmt|;
try|try
block|{
name|canProceed
operator|=
name|regionServer
operator|.
name|nonceManager
operator|.
name|startOperation
argument_list|(
name|nonceGroup
argument_list|,
name|mutation
operator|.
name|getNonce
argument_list|()
argument_list|,
name|regionServer
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|ex
parameter_list|)
block|{
throw|throw
operator|new
name|InterruptedIOException
argument_list|(
literal|"Nonce start operation interrupted"
argument_list|)
throw|;
block|}
return|return
name|canProceed
return|;
block|}
comment|/**    * Ends nonce operation for a mutation, if needed.    * @param mutation Mutation.    * @param nonceGroup Nonce group from the request. Always 0 in initial implementation.    * @param success Whether the operation for this nonce has succeeded.    */
specifier|private
name|void
name|endNonceOperation
parameter_list|(
specifier|final
name|MutationProto
name|mutation
parameter_list|,
name|long
name|nonceGroup
parameter_list|,
name|boolean
name|success
parameter_list|)
block|{
if|if
condition|(
name|regionServer
operator|.
name|nonceManager
operator|!=
literal|null
operator|&&
name|mutation
operator|.
name|hasNonce
argument_list|()
condition|)
block|{
name|regionServer
operator|.
name|nonceManager
operator|.
name|endOperation
argument_list|(
name|nonceGroup
argument_list|,
name|mutation
operator|.
name|getNonce
argument_list|()
argument_list|,
name|success
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|boolean
name|isClientCellBlockSupport
parameter_list|(
name|RpcCallContext
name|context
parameter_list|)
block|{
return|return
name|context
operator|!=
literal|null
operator|&&
name|context
operator|.
name|isClientCellBlockSupported
argument_list|()
return|;
block|}
specifier|private
name|void
name|addResult
parameter_list|(
specifier|final
name|MutateResponse
operator|.
name|Builder
name|builder
parameter_list|,
specifier|final
name|Result
name|result
parameter_list|,
specifier|final
name|HBaseRpcController
name|rpcc
parameter_list|,
name|boolean
name|clientCellBlockSupported
parameter_list|)
block|{
if|if
condition|(
name|result
operator|==
literal|null
condition|)
return|return;
if|if
condition|(
name|clientCellBlockSupported
condition|)
block|{
name|builder
operator|.
name|setResult
argument_list|(
name|ProtobufUtil
operator|.
name|toResultNoData
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|rpcc
operator|.
name|setCellScanner
argument_list|(
name|result
operator|.
name|cellScanner
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ClientProtos
operator|.
name|Result
name|pbr
init|=
name|ProtobufUtil
operator|.
name|toResult
argument_list|(
name|result
argument_list|)
decl_stmt|;
name|builder
operator|.
name|setResult
argument_list|(
name|pbr
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|addResults
parameter_list|(
name|ScanResponse
operator|.
name|Builder
name|builder
parameter_list|,
name|List
argument_list|<
name|Result
argument_list|>
name|results
parameter_list|,
name|HBaseRpcController
name|controller
parameter_list|,
name|boolean
name|isDefaultRegion
parameter_list|,
name|boolean
name|clientCellBlockSupported
parameter_list|)
block|{
name|builder
operator|.
name|setStale
argument_list|(
operator|!
name|isDefaultRegion
argument_list|)
expr_stmt|;
if|if
condition|(
name|results
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|clientCellBlockSupported
condition|)
block|{
for|for
control|(
name|Result
name|res
range|:
name|results
control|)
block|{
name|builder
operator|.
name|addCellsPerResult
argument_list|(
name|res
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|addPartialFlagPerResult
argument_list|(
name|res
operator|.
name|mayHaveMoreCellsInRow
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|controller
operator|.
name|setCellScanner
argument_list|(
name|CellUtil
operator|.
name|createCellScanner
argument_list|(
name|results
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|Result
name|res
range|:
name|results
control|)
block|{
name|ClientProtos
operator|.
name|Result
name|pbr
init|=
name|ProtobufUtil
operator|.
name|toResult
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|builder
operator|.
name|addResults
argument_list|(
name|pbr
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**    * Mutate a list of rows atomically.    * @param cellScanner if non-null, the mutation data -- the Cell content.    */
specifier|private
name|boolean
name|checkAndRowMutate
parameter_list|(
specifier|final
name|HRegion
name|region
parameter_list|,
specifier|final
name|List
argument_list|<
name|ClientProtos
operator|.
name|Action
argument_list|>
name|actions
parameter_list|,
specifier|final
name|CellScanner
name|cellScanner
parameter_list|,
name|byte
index|[]
name|row
parameter_list|,
name|byte
index|[]
name|family
parameter_list|,
name|byte
index|[]
name|qualifier
parameter_list|,
name|CompareOperator
name|op
parameter_list|,
name|ByteArrayComparable
name|comparator
parameter_list|,
name|RegionActionResult
operator|.
name|Builder
name|builder
parameter_list|,
name|ActivePolicyEnforcement
name|spaceQuotaEnforcement
parameter_list|)
throws|throws
name|IOException
block|{
name|int
name|countOfCompleteMutation
init|=
literal|0
decl_stmt|;
try|try
block|{
if|if
condition|(
operator|!
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|isMetaRegion
argument_list|()
condition|)
block|{
name|regionServer
operator|.
name|cacheFlusher
operator|.
name|reclaimMemStoreMemory
argument_list|()
expr_stmt|;
block|}
name|RowMutations
name|rm
init|=
literal|null
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|ClientProtos
operator|.
name|ResultOrException
operator|.
name|Builder
name|resultOrExceptionOrBuilder
init|=
name|ClientProtos
operator|.
name|ResultOrException
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
for|for
control|(
name|ClientProtos
operator|.
name|Action
name|action
range|:
name|actions
control|)
block|{
if|if
condition|(
name|action
operator|.
name|hasGet
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|DoNotRetryIOException
argument_list|(
literal|"Atomic put and/or delete only, not a Get="
operator|+
name|action
operator|.
name|getGet
argument_list|()
argument_list|)
throw|;
block|}
name|MutationType
name|type
init|=
name|action
operator|.
name|getMutation
argument_list|()
operator|.
name|getMutateType
argument_list|()
decl_stmt|;
if|if
condition|(
name|rm
operator|==
literal|null
condition|)
block|{
name|rm
operator|=
operator|new
name|RowMutations
argument_list|(
name|action
operator|.
name|getMutation
argument_list|()
operator|.
name|getRow
argument_list|()
operator|.
name|toByteArray
argument_list|()
argument_list|,
name|actions
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|PUT
case|:
name|Put
name|put
init|=
name|ProtobufUtil
operator|.
name|toPut
argument_list|(
name|action
operator|.
name|getMutation
argument_list|()
argument_list|,
name|cellScanner
argument_list|)
decl_stmt|;
operator|++
name|countOfCompleteMutation
expr_stmt|;
name|checkCellSizeLimit
argument_list|(
name|region
argument_list|,
name|put
argument_list|)
expr_stmt|;
name|spaceQuotaEnforcement
operator|.
name|getPolicyEnforcement
argument_list|(
name|region
argument_list|)
operator|.
name|check
argument_list|(
name|put
argument_list|)
expr_stmt|;
name|rm
operator|.
name|add
argument_list|(
name|put
argument_list|)
expr_stmt|;
break|break;
case|case
name|DELETE
case|:
name|Delete
name|del
init|=
name|ProtobufUtil
operator|.
name|toDelete
argument_list|(
name|action
operator|.
name|getMutation
argument_list|()
argument_list|,
name|cellScanner
argument_list|)
decl_stmt|;
operator|++
name|countOfCompleteMutation
expr_stmt|;
name|spaceQuotaEnforcement
operator|.
name|getPolicyEnforcement
argument_list|(
name|region
argument_list|)
operator|.
name|check
argument_list|(
name|del
argument_list|)
expr_stmt|;
name|rm
operator|.
name|add
argument_list|(
name|del
argument_list|)
expr_stmt|;
break|break;
default|default:
throw|throw
operator|new
name|DoNotRetryIOException
argument_list|(
literal|"Atomic put and/or delete only, not "
operator|+
name|type
operator|.
name|name
argument_list|()
argument_list|)
throw|;
block|}
comment|// To unify the response format with doNonAtomicRegionMutation and read through client's
comment|// AsyncProcess we have to add an empty result instance per operation
name|resultOrExceptionOrBuilder
operator|.
name|clear
argument_list|()
expr_stmt|;
name|resultOrExceptionOrBuilder
operator|.
name|setIndex
argument_list|(
name|i
operator|++
argument_list|)
expr_stmt|;
name|builder
operator|.
name|addResultOrException
argument_list|(
name|resultOrExceptionOrBuilder
operator|.
name|build
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|region
operator|.
name|checkAndRowMutate
argument_list|(
name|row
argument_list|,
name|family
argument_list|,
name|qualifier
argument_list|,
name|op
argument_list|,
name|comparator
argument_list|,
name|rm
argument_list|)
return|;
block|}
finally|finally
block|{
comment|// Currently, the checkAndMutate isn't supported by batch so it won't mess up the cell scanner
comment|// even if the malformed cells are not skipped.
for|for
control|(
name|int
name|i
init|=
name|countOfCompleteMutation
init|;
name|i
operator|<
name|actions
operator|.
name|size
argument_list|()
condition|;
operator|++
name|i
control|)
block|{
name|skipCellsForMutation
argument_list|(
name|actions
operator|.
name|get
argument_list|(
name|i
argument_list|)
argument_list|,
name|cellScanner
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**    * Execute an append mutation.    *    * @return result to return to client if default operation should be    * bypassed as indicated by RegionObserver, null otherwise    */
specifier|private
name|Result
name|append
parameter_list|(
specifier|final
name|HRegion
name|region
parameter_list|,
specifier|final
name|OperationQuota
name|quota
parameter_list|,
specifier|final
name|MutationProto
name|mutation
parameter_list|,
specifier|final
name|CellScanner
name|cellScanner
parameter_list|,
name|long
name|nonceGroup
parameter_list|,
name|ActivePolicyEnforcement
name|spaceQuota
parameter_list|)
throws|throws
name|IOException
block|{
name|long
name|before
init|=
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
decl_stmt|;
name|Append
name|append
init|=
name|ProtobufUtil
operator|.
name|toAppend
argument_list|(
name|mutation
argument_list|,
name|cellScanner
argument_list|)
decl_stmt|;
name|checkCellSizeLimit
argument_list|(
name|region
argument_list|,
name|append
argument_list|)
expr_stmt|;
name|spaceQuota
operator|.
name|getPolicyEnforcement
argument_list|(
name|region
argument_list|)
operator|.
name|check
argument_list|(
name|append
argument_list|)
expr_stmt|;
name|quota
operator|.
name|addMutation
argument_list|(
name|append
argument_list|)
expr_stmt|;
name|Result
name|r
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|r
operator|=
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|preAppend
argument_list|(
name|append
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|==
literal|null
condition|)
block|{
name|boolean
name|canProceed
init|=
name|startNonceOperation
argument_list|(
name|mutation
argument_list|,
name|nonceGroup
argument_list|)
decl_stmt|;
name|boolean
name|success
init|=
literal|false
decl_stmt|;
try|try
block|{
name|long
name|nonce
init|=
name|mutation
operator|.
name|hasNonce
argument_list|()
condition|?
name|mutation
operator|.
name|getNonce
argument_list|()
else|:
name|HConstants
operator|.
name|NO_NONCE
decl_stmt|;
if|if
condition|(
name|canProceed
condition|)
block|{
name|r
operator|=
name|region
operator|.
name|append
argument_list|(
name|append
argument_list|,
name|nonceGroup
argument_list|,
name|nonce
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// convert duplicate append to get
name|List
argument_list|<
name|Cell
argument_list|>
name|results
init|=
name|region
operator|.
name|get
argument_list|(
name|ProtobufUtil
operator|.
name|toGet
argument_list|(
name|mutation
argument_list|,
name|cellScanner
argument_list|)
argument_list|,
literal|false
argument_list|,
name|nonceGroup
argument_list|,
name|nonce
argument_list|)
decl_stmt|;
name|r
operator|=
name|Result
operator|.
name|create
argument_list|(
name|results
argument_list|)
expr_stmt|;
block|}
name|success
operator|=
literal|true
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|canProceed
condition|)
block|{
name|endNonceOperation
argument_list|(
name|mutation
argument_list|,
name|nonceGroup
argument_list|,
name|success
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|r
operator|=
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|postAppend
argument_list|(
name|append
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|regionServer
operator|.
name|metricsRegionServer
operator|!=
literal|null
condition|)
block|{
name|regionServer
operator|.
name|metricsRegionServer
operator|.
name|updateAppend
argument_list|(
name|region
operator|.
name|getTableDescriptor
argument_list|()
operator|.
name|getTableName
argument_list|()
argument_list|,
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
operator|-
name|before
argument_list|)
expr_stmt|;
block|}
return|return
name|r
operator|==
literal|null
condition|?
name|Result
operator|.
name|EMPTY_RESULT
else|:
name|r
return|;
block|}
comment|/**    * Execute an increment mutation.    *    * @param region    * @param mutation    * @return the Result    * @throws IOException    */
specifier|private
name|Result
name|increment
parameter_list|(
specifier|final
name|HRegion
name|region
parameter_list|,
specifier|final
name|OperationQuota
name|quota
parameter_list|,
specifier|final
name|MutationProto
name|mutation
parameter_list|,
specifier|final
name|CellScanner
name|cells
parameter_list|,
name|long
name|nonceGroup
parameter_list|,
name|ActivePolicyEnforcement
name|spaceQuota
parameter_list|)
throws|throws
name|IOException
block|{
name|long
name|before
init|=
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
decl_stmt|;
name|Increment
name|increment
init|=
name|ProtobufUtil
operator|.
name|toIncrement
argument_list|(
name|mutation
argument_list|,
name|cells
argument_list|)
decl_stmt|;
name|checkCellSizeLimit
argument_list|(
name|region
argument_list|,
name|increment
argument_list|)
expr_stmt|;
name|spaceQuota
operator|.
name|getPolicyEnforcement
argument_list|(
name|region
argument_list|)
operator|.
name|check
argument_list|(
name|increment
argument_list|)
expr_stmt|;
name|quota
operator|.
name|addMutation
argument_list|(
name|increment
argument_list|)
expr_stmt|;
name|Result
name|r
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|r
operator|=
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|preIncrement
argument_list|(
name|increment
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|==
literal|null
condition|)
block|{
name|boolean
name|canProceed
init|=
name|startNonceOperation
argument_list|(
name|mutation
argument_list|,
name|nonceGroup
argument_list|)
decl_stmt|;
name|boolean
name|success
init|=
literal|false
decl_stmt|;
try|try
block|{
name|long
name|nonce
init|=
name|mutation
operator|.
name|hasNonce
argument_list|()
condition|?
name|mutation
operator|.
name|getNonce
argument_list|()
else|:
name|HConstants
operator|.
name|NO_NONCE
decl_stmt|;
if|if
condition|(
name|canProceed
condition|)
block|{
name|r
operator|=
name|region
operator|.
name|increment
argument_list|(
name|increment
argument_list|,
name|nonceGroup
argument_list|,
name|nonce
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// convert duplicate increment to get
name|List
argument_list|<
name|Cell
argument_list|>
name|results
init|=
name|region
operator|.
name|get
argument_list|(
name|ProtobufUtil
operator|.
name|toGet
argument_list|(
name|mutation
argument_list|,
name|cells
argument_list|)
argument_list|,
literal|false
argument_list|,
name|nonceGroup
argument_list|,
name|nonce
argument_list|)
decl_stmt|;
name|r
operator|=
name|Result
operator|.
name|create
argument_list|(
name|results
argument_list|)
expr_stmt|;
block|}
name|success
operator|=
literal|true
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|canProceed
condition|)
block|{
name|endNonceOperation
argument_list|(
name|mutation
argument_list|,
name|nonceGroup
argument_list|,
name|success
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|r
operator|=
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|postIncrement
argument_list|(
name|increment
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|regionServer
operator|.
name|metricsRegionServer
operator|!=
literal|null
condition|)
block|{
name|regionServer
operator|.
name|metricsRegionServer
operator|.
name|updateIncrement
argument_list|(
name|region
operator|.
name|getTableDescriptor
argument_list|()
operator|.
name|getTableName
argument_list|()
argument_list|,
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
operator|-
name|before
argument_list|)
expr_stmt|;
block|}
return|return
name|r
operator|==
literal|null
condition|?
name|Result
operator|.
name|EMPTY_RESULT
else|:
name|r
return|;
block|}
comment|/**    * Run through the regionMutation<code>rm</code> and per Mutation, do the work, and then when    * done, add an instance of a {@link ResultOrException} that corresponds to each Mutation.    * @param cellsToReturn  Could be null. May be allocated in this method.  This is what this    * method returns as a 'result'.    * @param closeCallBack the callback to be used with multigets    * @param context the current RpcCallContext    * @return Return the<code>cellScanner</code> passed    */
specifier|private
name|List
argument_list|<
name|CellScannable
argument_list|>
name|doNonAtomicRegionMutation
parameter_list|(
specifier|final
name|HRegion
name|region
parameter_list|,
specifier|final
name|OperationQuota
name|quota
parameter_list|,
specifier|final
name|RegionAction
name|actions
parameter_list|,
specifier|final
name|CellScanner
name|cellScanner
parameter_list|,
specifier|final
name|RegionActionResult
operator|.
name|Builder
name|builder
parameter_list|,
name|List
argument_list|<
name|CellScannable
argument_list|>
name|cellsToReturn
parameter_list|,
name|long
name|nonceGroup
parameter_list|,
specifier|final
name|RegionScannersCloseCallBack
name|closeCallBack
parameter_list|,
name|RpcCallContext
name|context
parameter_list|,
name|ActivePolicyEnforcement
name|spaceQuotaEnforcement
parameter_list|)
block|{
comment|// Gather up CONTIGUOUS Puts and Deletes in this mutations List.  Idea is that rather than do
comment|// one at a time, we instead pass them in batch.  Be aware that the corresponding
comment|// ResultOrException instance that matches each Put or Delete is then added down in the
comment|// doNonAtomicBatchOp call.  We should be staying aligned though the Put and Delete are
comment|// deferred/batched
name|List
argument_list|<
name|ClientProtos
operator|.
name|Action
argument_list|>
name|mutations
init|=
literal|null
decl_stmt|;
name|long
name|maxQuotaResultSize
init|=
name|Math
operator|.
name|min
argument_list|(
name|maxScannerResultSize
argument_list|,
name|quota
operator|.
name|getReadAvailable
argument_list|()
argument_list|)
decl_stmt|;
name|IOException
name|sizeIOE
init|=
literal|null
decl_stmt|;
name|Object
name|lastBlock
init|=
literal|null
decl_stmt|;
name|ClientProtos
operator|.
name|ResultOrException
operator|.
name|Builder
name|resultOrExceptionBuilder
init|=
name|ResultOrException
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|boolean
name|hasResultOrException
init|=
literal|false
decl_stmt|;
for|for
control|(
name|ClientProtos
operator|.
name|Action
name|action
range|:
name|actions
operator|.
name|getActionList
argument_list|()
control|)
block|{
name|hasResultOrException
operator|=
literal|false
expr_stmt|;
name|resultOrExceptionBuilder
operator|.
name|clear
argument_list|()
expr_stmt|;
try|try
block|{
name|Result
name|r
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|context
operator|!=
literal|null
operator|&&
name|context
operator|.
name|isRetryImmediatelySupported
argument_list|()
operator|&&
operator|(
name|context
operator|.
name|getResponseCellSize
argument_list|()
operator|>
name|maxQuotaResultSize
operator|||
name|context
operator|.
name|getResponseBlockSize
argument_list|()
operator|+
name|context
operator|.
name|getResponseExceptionSize
argument_list|()
operator|>
name|maxQuotaResultSize
operator|)
condition|)
block|{
comment|// We're storing the exception since the exception and reason string won't
comment|// change after the response size limit is reached.
if|if
condition|(
name|sizeIOE
operator|==
literal|null
condition|)
block|{
comment|// We don't need the stack un-winding do don't throw the exception.
comment|// Throwing will kill the JVM's JIT.
comment|//
comment|// Instead just create the exception and then store it.
name|sizeIOE
operator|=
operator|new
name|MultiActionResultTooLarge
argument_list|(
literal|"Max size exceeded"
operator|+
literal|" CellSize: "
operator|+
name|context
operator|.
name|getResponseCellSize
argument_list|()
operator|+
literal|" BlockSize: "
operator|+
name|context
operator|.
name|getResponseBlockSize
argument_list|()
argument_list|)
expr_stmt|;
comment|// Only report the exception once since there's only one request that
comment|// caused the exception. Otherwise this number will dominate the exceptions count.
name|rpcServer
operator|.
name|getMetrics
argument_list|()
operator|.
name|exception
argument_list|(
name|sizeIOE
argument_list|)
expr_stmt|;
block|}
comment|// Now that there's an exception is known to be created
comment|// use it for the response.
comment|//
comment|// This will create a copy in the builder.
name|NameBytesPair
name|pair
init|=
name|ResponseConverter
operator|.
name|buildException
argument_list|(
name|sizeIOE
argument_list|)
decl_stmt|;
name|resultOrExceptionBuilder
operator|.
name|setException
argument_list|(
name|pair
argument_list|)
expr_stmt|;
name|context
operator|.
name|incrementResponseExceptionSize
argument_list|(
name|pair
operator|.
name|getSerializedSize
argument_list|()
argument_list|)
expr_stmt|;
name|resultOrExceptionBuilder
operator|.
name|setIndex
argument_list|(
name|action
operator|.
name|getIndex
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|addResultOrException
argument_list|(
name|resultOrExceptionBuilder
operator|.
name|build
argument_list|()
argument_list|)
expr_stmt|;
name|skipCellsForMutation
argument_list|(
name|action
argument_list|,
name|cellScanner
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|action
operator|.
name|hasGet
argument_list|()
condition|)
block|{
name|long
name|before
init|=
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
decl_stmt|;
try|try
block|{
name|Get
name|get
init|=
name|ProtobufUtil
operator|.
name|toGet
argument_list|(
name|action
operator|.
name|getGet
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|context
operator|!=
literal|null
condition|)
block|{
name|r
operator|=
name|get
argument_list|(
name|get
argument_list|,
operator|(
name|region
operator|)
argument_list|,
name|closeCallBack
argument_list|,
name|context
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|r
operator|=
name|region
operator|.
name|get
argument_list|(
name|get
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
if|if
condition|(
name|regionServer
operator|.
name|metricsRegionServer
operator|!=
literal|null
condition|)
block|{
name|regionServer
operator|.
name|metricsRegionServer
operator|.
name|updateGet
argument_list|(
name|region
operator|.
name|getTableDescriptor
argument_list|()
operator|.
name|getTableName
argument_list|()
argument_list|,
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
operator|-
name|before
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|action
operator|.
name|hasServiceCall
argument_list|()
condition|)
block|{
name|hasResultOrException
operator|=
literal|true
expr_stmt|;
name|com
operator|.
name|google
operator|.
name|protobuf
operator|.
name|Message
name|result
init|=
name|execServiceOnRegion
argument_list|(
name|region
argument_list|,
name|action
operator|.
name|getServiceCall
argument_list|()
argument_list|)
decl_stmt|;
name|ClientProtos
operator|.
name|CoprocessorServiceResult
operator|.
name|Builder
name|serviceResultBuilder
init|=
name|ClientProtos
operator|.
name|CoprocessorServiceResult
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|resultOrExceptionBuilder
operator|.
name|setServiceResult
argument_list|(
name|serviceResultBuilder
operator|.
name|setValue
argument_list|(
name|serviceResultBuilder
operator|.
name|getValueBuilder
argument_list|()
operator|.
name|setName
argument_list|(
name|result
operator|.
name|getClass
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
comment|// TODO: Copy!!!
operator|.
name|setValue
argument_list|(
name|UnsafeByteOperations
operator|.
name|unsafeWrap
argument_list|(
name|result
operator|.
name|toByteArray
argument_list|()
argument_list|)
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|action
operator|.
name|hasMutation
argument_list|()
condition|)
block|{
name|MutationType
name|type
init|=
name|action
operator|.
name|getMutation
argument_list|()
operator|.
name|getMutateType
argument_list|()
decl_stmt|;
if|if
condition|(
name|type
operator|!=
name|MutationType
operator|.
name|PUT
operator|&&
name|type
operator|!=
name|MutationType
operator|.
name|DELETE
operator|&&
name|mutations
operator|!=
literal|null
operator|&&
operator|!
name|mutations
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
comment|// Flush out any Puts or Deletes already collected.
name|doNonAtomicBatchOp
argument_list|(
name|builder
argument_list|,
name|region
argument_list|,
name|quota
argument_list|,
name|mutations
argument_list|,
name|cellScanner
argument_list|,
name|spaceQuotaEnforcement
argument_list|)
expr_stmt|;
name|mutations
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|APPEND
case|:
name|r
operator|=
name|append
argument_list|(
name|region
argument_list|,
name|quota
argument_list|,
name|action
operator|.
name|getMutation
argument_list|()
argument_list|,
name|cellScanner
argument_list|,
name|nonceGroup
argument_list|,
name|spaceQuotaEnforcement
argument_list|)
expr_stmt|;
break|break;
case|case
name|INCREMENT
case|:
name|r
operator|=
name|increment
argument_list|(
name|region
argument_list|,
name|quota
argument_list|,
name|action
operator|.
name|getMutation
argument_list|()
argument_list|,
name|cellScanner
argument_list|,
name|nonceGroup
argument_list|,
name|spaceQuotaEnforcement
argument_list|)
expr_stmt|;
break|break;
case|case
name|PUT
case|:
case|case
name|DELETE
case|:
comment|// Collect the individual mutations and apply in a batch
if|if
condition|(
name|mutations
operator|==
literal|null
condition|)
block|{
name|mutations
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|actions
operator|.
name|getActionCount
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|mutations
operator|.
name|add
argument_list|(
name|action
argument_list|)
expr_stmt|;
break|break;
default|default:
throw|throw
operator|new
name|DoNotRetryIOException
argument_list|(
literal|"Unsupported mutate type: "
operator|+
name|type
operator|.
name|name
argument_list|()
argument_list|)
throw|;
block|}
block|}
else|else
block|{
throw|throw
operator|new
name|HBaseIOException
argument_list|(
literal|"Unexpected Action type"
argument_list|)
throw|;
block|}
if|if
condition|(
name|r
operator|!=
literal|null
condition|)
block|{
name|ClientProtos
operator|.
name|Result
name|pbResult
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|isClientCellBlockSupport
argument_list|(
name|context
argument_list|)
condition|)
block|{
name|pbResult
operator|=
name|ProtobufUtil
operator|.
name|toResultNoData
argument_list|(
name|r
argument_list|)
expr_stmt|;
comment|//  Hard to guess the size here.  Just make a rough guess.
if|if
condition|(
name|cellsToReturn
operator|==
literal|null
condition|)
block|{
name|cellsToReturn
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
expr_stmt|;
block|}
name|cellsToReturn
operator|.
name|add
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pbResult
operator|=
name|ProtobufUtil
operator|.
name|toResult
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
name|lastBlock
operator|=
name|addSize
argument_list|(
name|context
argument_list|,
name|r
argument_list|,
name|lastBlock
argument_list|)
expr_stmt|;
name|hasResultOrException
operator|=
literal|true
expr_stmt|;
name|resultOrExceptionBuilder
operator|.
name|setResult
argument_list|(
name|pbResult
argument_list|)
expr_stmt|;
block|}
comment|// Could get to here and there was no result and no exception.  Presumes we added
comment|// a Put or Delete to the collecting Mutations List for adding later.  In this
comment|// case the corresponding ResultOrException instance for the Put or Delete will be added
comment|// down in the doNonAtomicBatchOp method call rather than up here.
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
name|rpcServer
operator|.
name|getMetrics
argument_list|()
operator|.
name|exception
argument_list|(
name|ie
argument_list|)
expr_stmt|;
name|hasResultOrException
operator|=
literal|true
expr_stmt|;
name|NameBytesPair
name|pair
init|=
name|ResponseConverter
operator|.
name|buildException
argument_list|(
name|ie
argument_list|)
decl_stmt|;
name|resultOrExceptionBuilder
operator|.
name|setException
argument_list|(
name|pair
argument_list|)
expr_stmt|;
name|context
operator|.
name|incrementResponseExceptionSize
argument_list|(
name|pair
operator|.
name|getSerializedSize
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hasResultOrException
condition|)
block|{
comment|// Propagate index.
name|resultOrExceptionBuilder
operator|.
name|setIndex
argument_list|(
name|action
operator|.
name|getIndex
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|addResultOrException
argument_list|(
name|resultOrExceptionBuilder
operator|.
name|build
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Finish up any outstanding mutations
if|if
condition|(
operator|!
name|CollectionUtils
operator|.
name|isEmpty
argument_list|(
name|mutations
argument_list|)
condition|)
block|{
name|doNonAtomicBatchOp
argument_list|(
name|builder
argument_list|,
name|region
argument_list|,
name|quota
argument_list|,
name|mutations
argument_list|,
name|cellScanner
argument_list|,
name|spaceQuotaEnforcement
argument_list|)
expr_stmt|;
block|}
return|return
name|cellsToReturn
return|;
block|}
specifier|private
name|void
name|checkCellSizeLimit
parameter_list|(
specifier|final
name|HRegion
name|r
parameter_list|,
specifier|final
name|Mutation
name|m
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|r
operator|.
name|maxCellSize
operator|>
literal|0
condition|)
block|{
name|CellScanner
name|cells
init|=
name|m
operator|.
name|cellScanner
argument_list|()
decl_stmt|;
while|while
condition|(
name|cells
operator|.
name|advance
argument_list|()
condition|)
block|{
name|int
name|size
init|=
name|PrivateCellUtil
operator|.
name|estimatedSerializedSizeOf
argument_list|(
name|cells
operator|.
name|current
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|size
operator|>
name|r
operator|.
name|maxCellSize
condition|)
block|{
name|String
name|msg
init|=
literal|"Cell with size "
operator|+
name|size
operator|+
literal|" exceeds limit of "
operator|+
name|r
operator|.
name|maxCellSize
operator|+
literal|" bytes"
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
throw|throw
operator|new
name|DoNotRetryIOException
argument_list|(
name|msg
argument_list|)
throw|;
block|}
block|}
block|}
block|}
specifier|private
name|void
name|doAtomicBatchOp
parameter_list|(
specifier|final
name|RegionActionResult
operator|.
name|Builder
name|builder
parameter_list|,
specifier|final
name|HRegion
name|region
parameter_list|,
specifier|final
name|OperationQuota
name|quota
parameter_list|,
specifier|final
name|List
argument_list|<
name|ClientProtos
operator|.
name|Action
argument_list|>
name|mutations
parameter_list|,
specifier|final
name|CellScanner
name|cells
parameter_list|,
name|ActivePolicyEnforcement
name|spaceQuotaEnforcement
parameter_list|)
throws|throws
name|IOException
block|{
comment|// Just throw the exception. The exception will be caught and then added to region-level
comment|// exception for RegionAction. Leaving the null to action result is ok since the null
comment|// result is viewed as failure by hbase client. And the region-lever exception will be used
comment|// to replaced the null result. see AsyncRequestFutureImpl#receiveMultiAction and
comment|// AsyncBatchRpcRetryingCaller#onComplete for more details.
name|doBatchOp
argument_list|(
name|builder
argument_list|,
name|region
argument_list|,
name|quota
argument_list|,
name|mutations
argument_list|,
name|cells
argument_list|,
name|spaceQuotaEnforcement
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|doNonAtomicBatchOp
parameter_list|(
specifier|final
name|RegionActionResult
operator|.
name|Builder
name|builder
parameter_list|,
specifier|final
name|HRegion
name|region
parameter_list|,
specifier|final
name|OperationQuota
name|quota
parameter_list|,
specifier|final
name|List
argument_list|<
name|ClientProtos
operator|.
name|Action
argument_list|>
name|mutations
parameter_list|,
specifier|final
name|CellScanner
name|cells
parameter_list|,
name|ActivePolicyEnforcement
name|spaceQuotaEnforcement
parameter_list|)
block|{
try|try
block|{
name|doBatchOp
argument_list|(
name|builder
argument_list|,
name|region
argument_list|,
name|quota
argument_list|,
name|mutations
argument_list|,
name|cells
argument_list|,
name|spaceQuotaEnforcement
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
comment|// Set the exception for each action. The mutations in same RegionAction are group to
comment|// different batch and then be processed individually. Hence, we don't set the region-level
comment|// exception here for whole RegionAction.
for|for
control|(
name|Action
name|mutation
range|:
name|mutations
control|)
block|{
name|builder
operator|.
name|addResultOrException
argument_list|(
name|getResultOrException
argument_list|(
name|e
argument_list|,
name|mutation
operator|.
name|getIndex
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**    * Execute a list of Put/Delete mutations.    *    * @param builder    * @param region    * @param mutations    */
specifier|private
name|void
name|doBatchOp
parameter_list|(
specifier|final
name|RegionActionResult
operator|.
name|Builder
name|builder
parameter_list|,
specifier|final
name|HRegion
name|region
parameter_list|,
specifier|final
name|OperationQuota
name|quota
parameter_list|,
specifier|final
name|List
argument_list|<
name|ClientProtos
operator|.
name|Action
argument_list|>
name|mutations
parameter_list|,
specifier|final
name|CellScanner
name|cells
parameter_list|,
name|ActivePolicyEnforcement
name|spaceQuotaEnforcement
parameter_list|,
name|boolean
name|atomic
parameter_list|)
throws|throws
name|IOException
block|{
name|Mutation
index|[]
name|mArray
init|=
operator|new
name|Mutation
index|[
name|mutations
operator|.
name|size
argument_list|()
index|]
decl_stmt|;
name|long
name|before
init|=
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
decl_stmt|;
name|boolean
name|batchContainsPuts
init|=
literal|false
decl_stmt|,
name|batchContainsDelete
init|=
literal|false
decl_stmt|;
try|try
block|{
comment|/** HBASE-17924        * mutationActionMap is a map to map the relation between mutations and actions        * since mutation array may have been reoredered.In order to return the right        * result or exception to the corresponding actions, We need to know which action        * is the mutation belong to. We can't sort ClientProtos.Action array, since they        * are bonded to cellscanners.        */
name|Map
argument_list|<
name|Mutation
argument_list|,
name|ClientProtos
operator|.
name|Action
argument_list|>
name|mutationActionMap
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|()
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
for|for
control|(
name|ClientProtos
operator|.
name|Action
name|action
range|:
name|mutations
control|)
block|{
if|if
condition|(
name|action
operator|.
name|hasGet
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|DoNotRetryIOException
argument_list|(
literal|"Atomic put and/or delete only, not a Get="
operator|+
name|action
operator|.
name|getGet
argument_list|()
argument_list|)
throw|;
block|}
name|MutationProto
name|m
init|=
name|action
operator|.
name|getMutation
argument_list|()
decl_stmt|;
name|Mutation
name|mutation
decl_stmt|;
if|if
condition|(
name|m
operator|.
name|getMutateType
argument_list|()
operator|==
name|MutationType
operator|.
name|PUT
condition|)
block|{
name|mutation
operator|=
name|ProtobufUtil
operator|.
name|toPut
argument_list|(
name|m
argument_list|,
name|cells
argument_list|)
expr_stmt|;
name|batchContainsPuts
operator|=
literal|true
expr_stmt|;
block|}
else|else
block|{
name|mutation
operator|=
name|ProtobufUtil
operator|.
name|toDelete
argument_list|(
name|m
argument_list|,
name|cells
argument_list|)
expr_stmt|;
name|batchContainsDelete
operator|=
literal|true
expr_stmt|;
block|}
name|mutationActionMap
operator|.
name|put
argument_list|(
name|mutation
argument_list|,
name|action
argument_list|)
expr_stmt|;
name|mArray
index|[
name|i
operator|++
index|]
operator|=
name|mutation
expr_stmt|;
name|checkCellSizeLimit
argument_list|(
name|region
argument_list|,
name|mutation
argument_list|)
expr_stmt|;
comment|// Check if a space quota disallows this mutation
name|spaceQuotaEnforcement
operator|.
name|getPolicyEnforcement
argument_list|(
name|region
argument_list|)
operator|.
name|check
argument_list|(
name|mutation
argument_list|)
expr_stmt|;
name|quota
operator|.
name|addMutation
argument_list|(
name|mutation
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|isMetaRegion
argument_list|()
condition|)
block|{
name|regionServer
operator|.
name|cacheFlusher
operator|.
name|reclaimMemStoreMemory
argument_list|()
expr_stmt|;
block|}
comment|// HBASE-17924
comment|// Sort to improve lock efficiency for non-atomic batch of operations. If atomic
comment|// order is preserved as its expected from the client
if|if
condition|(
operator|!
name|atomic
condition|)
block|{
name|Arrays
operator|.
name|sort
argument_list|(
name|mArray
argument_list|,
parameter_list|(
name|v1
parameter_list|,
name|v2
parameter_list|)
lambda|->
name|Row
operator|.
name|COMPARATOR
operator|.
name|compare
argument_list|(
name|v1
argument_list|,
name|v2
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|OperationStatus
index|[]
name|codes
init|=
name|region
operator|.
name|batchMutate
argument_list|(
name|mArray
argument_list|,
name|atomic
argument_list|,
name|HConstants
operator|.
name|NO_NONCE
argument_list|,
name|HConstants
operator|.
name|NO_NONCE
argument_list|)
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|codes
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
name|Mutation
name|currentMutation
init|=
name|mArray
index|[
name|i
index|]
decl_stmt|;
name|ClientProtos
operator|.
name|Action
name|currentAction
init|=
name|mutationActionMap
operator|.
name|get
argument_list|(
name|currentMutation
argument_list|)
decl_stmt|;
name|int
name|index
init|=
name|currentAction
operator|.
name|hasIndex
argument_list|()
operator|||
operator|!
name|atomic
condition|?
name|currentAction
operator|.
name|getIndex
argument_list|()
else|:
name|i
decl_stmt|;
name|Exception
name|e
init|=
literal|null
decl_stmt|;
switch|switch
condition|(
name|codes
index|[
name|i
index|]
operator|.
name|getOperationStatusCode
argument_list|()
condition|)
block|{
case|case
name|BAD_FAMILY
case|:
name|e
operator|=
operator|new
name|NoSuchColumnFamilyException
argument_list|(
name|codes
index|[
name|i
index|]
operator|.
name|getExceptionMsg
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|addResultOrException
argument_list|(
name|getResultOrException
argument_list|(
name|e
argument_list|,
name|index
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SANITY_CHECK_FAILURE
case|:
name|e
operator|=
operator|new
name|FailedSanityCheckException
argument_list|(
name|codes
index|[
name|i
index|]
operator|.
name|getExceptionMsg
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|addResultOrException
argument_list|(
name|getResultOrException
argument_list|(
name|e
argument_list|,
name|index
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|e
operator|=
operator|new
name|DoNotRetryIOException
argument_list|(
name|codes
index|[
name|i
index|]
operator|.
name|getExceptionMsg
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|addResultOrException
argument_list|(
name|getResultOrException
argument_list|(
name|e
argument_list|,
name|index
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|SUCCESS
case|:
name|builder
operator|.
name|addResultOrException
argument_list|(
name|getResultOrException
argument_list|(
name|ClientProtos
operator|.
name|Result
operator|.
name|getDefaultInstance
argument_list|()
argument_list|,
name|index
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|STORE_TOO_BUSY
case|:
name|e
operator|=
operator|new
name|RegionTooBusyException
argument_list|(
name|codes
index|[
name|i
index|]
operator|.
name|getExceptionMsg
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|addResultOrException
argument_list|(
name|getResultOrException
argument_list|(
name|e
argument_list|,
name|index
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
finally|finally
block|{
name|int
name|processedMutationIndex
init|=
literal|0
decl_stmt|;
for|for
control|(
name|Action
name|mutation
range|:
name|mutations
control|)
block|{
comment|// The non-null mArray[i] means the cell scanner has been read.
if|if
condition|(
name|mArray
index|[
name|processedMutationIndex
operator|++
index|]
operator|==
literal|null
condition|)
block|{
name|skipCellsForMutation
argument_list|(
name|mutation
argument_list|,
name|cells
argument_list|)
expr_stmt|;
block|}
block|}
name|updateMutationMetrics
argument_list|(
name|region
argument_list|,
name|before
argument_list|,
name|batchContainsPuts
argument_list|,
name|batchContainsDelete
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|updateMutationMetrics
parameter_list|(
name|HRegion
name|region
parameter_list|,
name|long
name|starttime
parameter_list|,
name|boolean
name|batchContainsPuts
parameter_list|,
name|boolean
name|batchContainsDelete
parameter_list|)
block|{
if|if
condition|(
name|regionServer
operator|.
name|metricsRegionServer
operator|!=
literal|null
condition|)
block|{
name|long
name|after
init|=
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
decl_stmt|;
if|if
condition|(
name|batchContainsPuts
condition|)
block|{
name|regionServer
operator|.
name|metricsRegionServer
operator|.
name|updatePutBatch
argument_list|(
name|region
operator|.
name|getTableDescriptor
argument_list|()
operator|.
name|getTableName
argument_list|()
argument_list|,
name|after
operator|-
name|starttime
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|batchContainsDelete
condition|)
block|{
name|regionServer
operator|.
name|metricsRegionServer
operator|.
name|updateDeleteBatch
argument_list|(
name|region
operator|.
name|getTableDescriptor
argument_list|()
operator|.
name|getTableName
argument_list|()
argument_list|,
name|after
operator|-
name|starttime
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**    * Execute a list of Put/Delete mutations. The function returns OperationStatus instead of    * constructing MultiResponse to save a possible loop if caller doesn't need MultiResponse.    * @param region    * @param mutations    * @param replaySeqId    * @return an array of OperationStatus which internally contains the OperationStatusCode and the    *         exceptionMessage if any    * @throws IOException    */
specifier|private
name|OperationStatus
index|[]
name|doReplayBatchOp
parameter_list|(
specifier|final
name|HRegion
name|region
parameter_list|,
specifier|final
name|List
argument_list|<
name|WALSplitter
operator|.
name|MutationReplay
argument_list|>
name|mutations
parameter_list|,
name|long
name|replaySeqId
parameter_list|)
throws|throws
name|IOException
block|{
name|long
name|before
init|=
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
decl_stmt|;
name|boolean
name|batchContainsPuts
init|=
literal|false
decl_stmt|,
name|batchContainsDelete
init|=
literal|false
decl_stmt|;
try|try
block|{
for|for
control|(
name|Iterator
argument_list|<
name|WALSplitter
operator|.
name|MutationReplay
argument_list|>
name|it
init|=
name|mutations
operator|.
name|iterator
argument_list|()
init|;
name|it
operator|.
name|hasNext
argument_list|()
condition|;
control|)
block|{
name|WALSplitter
operator|.
name|MutationReplay
name|m
init|=
name|it
operator|.
name|next
argument_list|()
decl_stmt|;
if|if
condition|(
name|m
operator|.
name|type
operator|==
name|MutationType
operator|.
name|PUT
condition|)
block|{
name|batchContainsPuts
operator|=
literal|true
expr_stmt|;
block|}
else|else
block|{
name|batchContainsDelete
operator|=
literal|true
expr_stmt|;
block|}
name|NavigableMap
argument_list|<
name|byte
index|[]
argument_list|,
name|List
argument_list|<
name|Cell
argument_list|>
argument_list|>
name|map
init|=
name|m
operator|.
name|mutation
operator|.
name|getFamilyCellMap
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|Cell
argument_list|>
name|metaCells
init|=
name|map
operator|.
name|get
argument_list|(
name|WALEdit
operator|.
name|METAFAMILY
argument_list|)
decl_stmt|;
if|if
condition|(
name|metaCells
operator|!=
literal|null
operator|&&
operator|!
name|metaCells
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
for|for
control|(
name|Cell
name|metaCell
range|:
name|metaCells
control|)
block|{
name|CompactionDescriptor
name|compactionDesc
init|=
name|WALEdit
operator|.
name|getCompaction
argument_list|(
name|metaCell
argument_list|)
decl_stmt|;
name|boolean
name|isDefaultReplica
init|=
name|RegionReplicaUtil
operator|.
name|isDefaultReplica
argument_list|(
name|region
operator|.
name|getRegionInfo
argument_list|()
argument_list|)
decl_stmt|;
name|HRegion
name|hRegion
init|=
name|region
decl_stmt|;
if|if
condition|(
name|compactionDesc
operator|!=
literal|null
condition|)
block|{
comment|// replay the compaction. Remove the files from stores only if we are the primary
comment|// region replica (thus own the files)
name|hRegion
operator|.
name|replayWALCompactionMarker
argument_list|(
name|compactionDesc
argument_list|,
operator|!
name|isDefaultReplica
argument_list|,
name|isDefaultReplica
argument_list|,
name|replaySeqId
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|FlushDescriptor
name|flushDesc
init|=
name|WALEdit
operator|.
name|getFlushDescriptor
argument_list|(
name|metaCell
argument_list|)
decl_stmt|;
if|if
condition|(
name|flushDesc
operator|!=
literal|null
operator|&&
operator|!
name|isDefaultReplica
condition|)
block|{
name|hRegion
operator|.
name|replayWALFlushMarker
argument_list|(
name|flushDesc
argument_list|,
name|replaySeqId
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|RegionEventDescriptor
name|regionEvent
init|=
name|WALEdit
operator|.
name|getRegionEventDescriptor
argument_list|(
name|metaCell
argument_list|)
decl_stmt|;
if|if
condition|(
name|regionEvent
operator|!=
literal|null
operator|&&
operator|!
name|isDefaultReplica
condition|)
block|{
name|hRegion
operator|.
name|replayWALRegionEventMarker
argument_list|(
name|regionEvent
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|BulkLoadDescriptor
name|bulkLoadEvent
init|=
name|WALEdit
operator|.
name|getBulkLoadDescriptor
argument_list|(
name|metaCell
argument_list|)
decl_stmt|;
if|if
condition|(
name|bulkLoadEvent
operator|!=
literal|null
condition|)
block|{
name|hRegion
operator|.
name|replayWALBulkLoadEventMarker
argument_list|(
name|bulkLoadEvent
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|it
operator|.
name|remove
argument_list|()
expr_stmt|;
block|}
block|}
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|isMetaRegion
argument_list|()
condition|)
block|{
name|regionServer
operator|.
name|cacheFlusher
operator|.
name|reclaimMemStoreMemory
argument_list|()
expr_stmt|;
block|}
return|return
name|region
operator|.
name|batchReplay
argument_list|(
name|mutations
operator|.
name|toArray
argument_list|(
operator|new
name|WALSplitter
operator|.
name|MutationReplay
index|[
name|mutations
operator|.
name|size
argument_list|()
index|]
argument_list|)
argument_list|,
name|replaySeqId
argument_list|)
return|;
block|}
finally|finally
block|{
name|updateMutationMetrics
argument_list|(
name|region
argument_list|,
name|before
argument_list|,
name|batchContainsPuts
argument_list|,
name|batchContainsDelete
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|closeAllScanners
parameter_list|()
block|{
comment|// Close any outstanding scanners. Means they'll get an UnknownScanner
comment|// exception next time they come in.
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|RegionScannerHolder
argument_list|>
name|e
range|:
name|scanners
operator|.
name|entrySet
argument_list|()
control|)
block|{
try|try
block|{
name|e
operator|.
name|getValue
argument_list|()
operator|.
name|s
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ioe
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Closing scanner "
operator|+
name|e
operator|.
name|getKey
argument_list|()
argument_list|,
name|ioe
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|// Exposed for testing
interface|interface
name|LogDelegate
block|{
name|void
name|logBatchWarning
parameter_list|(
name|String
name|firstRegionName
parameter_list|,
name|int
name|sum
parameter_list|,
name|int
name|rowSizeWarnThreshold
parameter_list|)
function_decl|;
block|}
specifier|private
specifier|static
name|LogDelegate
name|DEFAULT_LOG_DELEGATE
init|=
operator|new
name|LogDelegate
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|logBatchWarning
parameter_list|(
name|String
name|firstRegionName
parameter_list|,
name|int
name|sum
parameter_list|,
name|int
name|rowSizeWarnThreshold
parameter_list|)
block|{
if|if
condition|(
name|LOG
operator|.
name|isWarnEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Large batch operation detected (greater than "
operator|+
name|rowSizeWarnThreshold
operator|+
literal|") (HBASE-18023)."
operator|+
literal|" Requested Number of Rows: "
operator|+
name|sum
operator|+
literal|" Client: "
operator|+
name|RpcServer
operator|.
name|getRequestUserName
argument_list|()
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
operator|+
literal|"/"
operator|+
name|RpcServer
operator|.
name|getRemoteAddress
argument_list|()
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
operator|+
literal|" first region in multi="
operator|+
name|firstRegionName
argument_list|)
expr_stmt|;
block|}
block|}
block|}
decl_stmt|;
specifier|private
specifier|final
name|LogDelegate
name|ld
decl_stmt|;
specifier|public
name|RSRpcServices
parameter_list|(
name|HRegionServer
name|rs
parameter_list|)
throws|throws
name|IOException
block|{
name|this
argument_list|(
name|rs
argument_list|,
name|DEFAULT_LOG_DELEGATE
argument_list|)
expr_stmt|;
block|}
comment|// Directly invoked only for testing
name|RSRpcServices
parameter_list|(
name|HRegionServer
name|rs
parameter_list|,
name|LogDelegate
name|ld
parameter_list|)
throws|throws
name|IOException
block|{
name|this
operator|.
name|ld
operator|=
name|ld
expr_stmt|;
name|regionServer
operator|=
name|rs
expr_stmt|;
name|rowSizeWarnThreshold
operator|=
name|rs
operator|.
name|conf
operator|.
name|getInt
argument_list|(
name|BATCH_ROWS_THRESHOLD_NAME
argument_list|,
name|BATCH_ROWS_THRESHOLD_DEFAULT
argument_list|)
expr_stmt|;
name|RpcSchedulerFactory
name|rpcSchedulerFactory
decl_stmt|;
try|try
block|{
name|Class
argument_list|<
name|?
argument_list|>
name|cls
init|=
name|rs
operator|.
name|conf
operator|.
name|getClass
argument_list|(
name|REGION_SERVER_RPC_SCHEDULER_FACTORY_CLASS
argument_list|,
name|SimpleRpcSchedulerFactory
operator|.
name|class
argument_list|)
decl_stmt|;
name|rpcSchedulerFactory
operator|=
name|cls
operator|.
name|asSubclass
argument_list|(
name|RpcSchedulerFactory
operator|.
name|class
argument_list|)
operator|.
name|getDeclaredConstructor
argument_list|()
operator|.
name|newInstance
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NoSuchMethodException
decl||
name|InvocationTargetException
decl||
name|InstantiationException
decl||
name|IllegalAccessException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
name|e
argument_list|)
throw|;
block|}
comment|// Server to handle client requests.
name|InetSocketAddress
name|initialIsa
decl_stmt|;
name|InetSocketAddress
name|bindAddress
decl_stmt|;
if|if
condition|(
name|this
operator|instanceof
name|MasterRpcServices
condition|)
block|{
name|String
name|hostname
init|=
name|getHostname
argument_list|(
name|rs
operator|.
name|conf
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|int
name|port
init|=
name|rs
operator|.
name|conf
operator|.
name|getInt
argument_list|(
name|HConstants
operator|.
name|MASTER_PORT
argument_list|,
name|HConstants
operator|.
name|DEFAULT_MASTER_PORT
argument_list|)
decl_stmt|;
comment|// Creation of a HSA will force a resolve.
name|initialIsa
operator|=
operator|new
name|InetSocketAddress
argument_list|(
name|hostname
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|bindAddress
operator|=
operator|new
name|InetSocketAddress
argument_list|(
name|rs
operator|.
name|conf
operator|.
name|get
argument_list|(
literal|"hbase.master.ipc.address"
argument_list|,
name|hostname
argument_list|)
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|String
name|hostname
init|=
name|getHostname
argument_list|(
name|rs
operator|.
name|conf
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|int
name|port
init|=
name|rs
operator|.
name|conf
operator|.
name|getInt
argument_list|(
name|HConstants
operator|.
name|REGIONSERVER_PORT
argument_list|,
name|HConstants
operator|.
name|DEFAULT_REGIONSERVER_PORT
argument_list|)
decl_stmt|;
comment|// Creation of a HSA will force a resolve.
name|initialIsa
operator|=
operator|new
name|InetSocketAddress
argument_list|(
name|hostname
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|bindAddress
operator|=
operator|new
name|InetSocketAddress
argument_list|(
name|rs
operator|.
name|conf
operator|.
name|get
argument_list|(
literal|"hbase.regionserver.ipc.address"
argument_list|,
name|hostname
argument_list|)
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|initialIsa
operator|.
name|getAddress
argument_list|()
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Failed resolve of "
operator|+
name|initialIsa
argument_list|)
throw|;
block|}
name|priority
operator|=
name|createPriority
argument_list|()
expr_stmt|;
comment|// Using Address means we don't get the IP too. Shorten it more even to just the host name
comment|// w/o the domain.
name|String
name|name
init|=
name|rs
operator|.
name|getProcessName
argument_list|()
operator|+
literal|"/"
operator|+
name|Address
operator|.
name|fromParts
argument_list|(
name|initialIsa
operator|.
name|getHostName
argument_list|()
argument_list|,
name|initialIsa
operator|.
name|getPort
argument_list|()
argument_list|)
operator|.
name|toStringWithoutDomain
argument_list|()
decl_stmt|;
comment|// Set how many times to retry talking to another server over Connection.
name|ConnectionUtils
operator|.
name|setServerSideHConnectionRetriesConfig
argument_list|(
name|rs
operator|.
name|conf
argument_list|,
name|name
argument_list|,
name|LOG
argument_list|)
expr_stmt|;
name|rpcServer
operator|=
name|createRpcServer
argument_list|(
name|rs
argument_list|,
name|rs
operator|.
name|conf
argument_list|,
name|rpcSchedulerFactory
argument_list|,
name|bindAddress
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|rpcServer
operator|.
name|setRsRpcServices
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|scannerLeaseTimeoutPeriod
operator|=
name|rs
operator|.
name|conf
operator|.
name|getInt
argument_list|(
name|HConstants
operator|.
name|HBASE_CLIENT_SCANNER_TIMEOUT_PERIOD
argument_list|,
name|HConstants
operator|.
name|DEFAULT_HBASE_CLIENT_SCANNER_TIMEOUT_PERIOD
argument_list|)
expr_stmt|;
name|maxScannerResultSize
operator|=
name|rs
operator|.
name|conf
operator|.
name|getLong
argument_list|(
name|HConstants
operator|.
name|HBASE_SERVER_SCANNER_MAX_RESULT_SIZE_KEY
argument_list|,
name|HConstants
operator|.
name|DEFAULT_HBASE_SERVER_SCANNER_MAX_RESULT_SIZE
argument_list|)
expr_stmt|;
name|rpcTimeout
operator|=
name|rs
operator|.
name|conf
operator|.
name|getInt
argument_list|(
name|HConstants
operator|.
name|HBASE_RPC_TIMEOUT_KEY
argument_list|,
name|HConstants
operator|.
name|DEFAULT_HBASE_RPC_TIMEOUT
argument_list|)
expr_stmt|;
name|minimumScanTimeLimitDelta
operator|=
name|rs
operator|.
name|conf
operator|.
name|getLong
argument_list|(
name|REGION_SERVER_RPC_MINIMUM_SCAN_TIME_LIMIT_DELTA
argument_list|,
name|DEFAULT_REGION_SERVER_RPC_MINIMUM_SCAN_TIME_LIMIT_DELTA
argument_list|)
expr_stmt|;
name|InetSocketAddress
name|address
init|=
name|rpcServer
operator|.
name|getListenerAddress
argument_list|()
decl_stmt|;
if|if
condition|(
name|address
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Listener channel is closed"
argument_list|)
throw|;
block|}
comment|// Set our address, however we need the final port that was given to rpcServer
name|isa
operator|=
operator|new
name|InetSocketAddress
argument_list|(
name|initialIsa
operator|.
name|getHostName
argument_list|()
argument_list|,
name|address
operator|.
name|getPort
argument_list|()
argument_list|)
expr_stmt|;
name|rpcServer
operator|.
name|setErrorHandler
argument_list|(
name|this
argument_list|)
expr_stmt|;
name|rs
operator|.
name|setName
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|closedScanners
operator|=
name|CacheBuilder
operator|.
name|newBuilder
argument_list|()
operator|.
name|expireAfterAccess
argument_list|(
name|scannerLeaseTimeoutPeriod
argument_list|,
name|TimeUnit
operator|.
name|MILLISECONDS
argument_list|)
operator|.
name|build
argument_list|()
expr_stmt|;
block|}
specifier|protected
name|RpcServerInterface
name|createRpcServer
parameter_list|(
name|Server
name|server
parameter_list|,
name|Configuration
name|conf
parameter_list|,
name|RpcSchedulerFactory
name|rpcSchedulerFactory
parameter_list|,
name|InetSocketAddress
name|bindAddress
parameter_list|,
name|String
name|name
parameter_list|)
throws|throws
name|IOException
block|{
name|boolean
name|reservoirEnabled
init|=
name|conf
operator|.
name|getBoolean
argument_list|(
name|RESERVOIR_ENABLED_KEY
argument_list|,
literal|true
argument_list|)
decl_stmt|;
try|try
block|{
return|return
name|RpcServerFactory
operator|.
name|createRpcServer
argument_list|(
name|server
argument_list|,
name|name
argument_list|,
name|getServices
argument_list|()
argument_list|,
name|bindAddress
argument_list|,
comment|// use final bindAddress for this server.
name|conf
argument_list|,
name|rpcSchedulerFactory
operator|.
name|create
argument_list|(
name|conf
argument_list|,
name|this
argument_list|,
name|server
argument_list|)
argument_list|,
name|reservoirEnabled
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|BindException
name|be
parameter_list|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|be
operator|.
name|getMessage
argument_list|()
operator|+
literal|". To switch ports use the '"
operator|+
name|HConstants
operator|.
name|REGIONSERVER_PORT
operator|+
literal|"' configuration property."
argument_list|,
name|be
operator|.
name|getCause
argument_list|()
operator|!=
literal|null
condition|?
name|be
operator|.
name|getCause
argument_list|()
else|:
name|be
argument_list|)
throw|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|void
name|onConfigurationChange
parameter_list|(
name|Configuration
name|newConf
parameter_list|)
block|{
if|if
condition|(
name|rpcServer
operator|instanceof
name|ConfigurationObserver
condition|)
block|{
operator|(
operator|(
name|ConfigurationObserver
operator|)
name|rpcServer
operator|)
operator|.
name|onConfigurationChange
argument_list|(
name|newConf
argument_list|)
expr_stmt|;
block|}
block|}
specifier|protected
name|PriorityFunction
name|createPriority
parameter_list|()
block|{
return|return
operator|new
name|AnnotationReadingPriorityFunction
argument_list|(
name|this
argument_list|)
return|;
block|}
specifier|protected
name|void
name|requirePermission
parameter_list|(
name|String
name|request
parameter_list|,
name|Permission
operator|.
name|Action
name|perm
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|accessChecker
operator|!=
literal|null
condition|)
block|{
name|accessChecker
operator|.
name|requirePermission
argument_list|(
name|RpcServer
operator|.
name|getRequestUser
argument_list|()
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
argument_list|,
name|request
argument_list|,
name|perm
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
specifier|static
name|String
name|getHostname
parameter_list|(
name|Configuration
name|conf
parameter_list|,
name|boolean
name|isMaster
parameter_list|)
throws|throws
name|UnknownHostException
block|{
name|String
name|hostname
init|=
name|conf
operator|.
name|get
argument_list|(
name|isMaster
condition|?
name|HRegionServer
operator|.
name|MASTER_HOSTNAME_KEY
else|:
name|HRegionServer
operator|.
name|RS_HOSTNAME_KEY
argument_list|)
decl_stmt|;
if|if
condition|(
name|hostname
operator|==
literal|null
operator|||
name|hostname
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|String
name|masterOrRS
init|=
name|isMaster
condition|?
literal|"master"
else|:
literal|"regionserver"
decl_stmt|;
return|return
name|Strings
operator|.
name|domainNamePointerToHostName
argument_list|(
name|DNS
operator|.
name|getDefaultHost
argument_list|(
name|conf
operator|.
name|get
argument_list|(
literal|"hbase."
operator|+
name|masterOrRS
operator|+
literal|".dns.interface"
argument_list|,
literal|"default"
argument_list|)
argument_list|,
name|conf
operator|.
name|get
argument_list|(
literal|"hbase."
operator|+
name|masterOrRS
operator|+
literal|".dns.nameserver"
argument_list|,
literal|"default"
argument_list|)
argument_list|)
argument_list|)
return|;
block|}
else|else
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"hostname is configured to be "
operator|+
name|hostname
argument_list|)
expr_stmt|;
return|return
name|hostname
return|;
block|}
block|}
annotation|@
name|VisibleForTesting
specifier|public
name|int
name|getScannersCount
parameter_list|()
block|{
return|return
name|scanners
operator|.
name|size
argument_list|()
return|;
block|}
specifier|public
name|RegionScanner
name|getScanner
parameter_list|(
name|long
name|scannerId
parameter_list|)
block|{
name|String
name|scannerIdString
init|=
name|Long
operator|.
name|toString
argument_list|(
name|scannerId
argument_list|)
decl_stmt|;
name|RegionScannerHolder
name|scannerHolder
init|=
name|scanners
operator|.
name|get
argument_list|(
name|scannerIdString
argument_list|)
decl_stmt|;
if|if
condition|(
name|scannerHolder
operator|!=
literal|null
condition|)
block|{
return|return
name|scannerHolder
operator|.
name|s
return|;
block|}
return|return
literal|null
return|;
block|}
specifier|public
name|String
name|getScanDetailsWithId
parameter_list|(
name|long
name|scannerId
parameter_list|)
block|{
name|RegionScanner
name|scanner
init|=
name|getScanner
argument_list|(
name|scannerId
argument_list|)
decl_stmt|;
if|if
condition|(
name|scanner
operator|==
literal|null
condition|)
block|{
return|return
literal|null
return|;
block|}
name|StringBuilder
name|builder
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|"table: "
argument_list|)
operator|.
name|append
argument_list|(
name|scanner
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getTable
argument_list|()
operator|.
name|getNameAsString
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|append
argument_list|(
literal|" region: "
argument_list|)
operator|.
name|append
argument_list|(
name|scanner
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getRegionNameAsString
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|toString
argument_list|()
return|;
block|}
comment|/**    * Get the vtime associated with the scanner.    * Currently the vtime is the number of "next" calls.    */
name|long
name|getScannerVirtualTime
parameter_list|(
name|long
name|scannerId
parameter_list|)
block|{
name|String
name|scannerIdString
init|=
name|Long
operator|.
name|toString
argument_list|(
name|scannerId
argument_list|)
decl_stmt|;
name|RegionScannerHolder
name|scannerHolder
init|=
name|scanners
operator|.
name|get
argument_list|(
name|scannerIdString
argument_list|)
decl_stmt|;
if|if
condition|(
name|scannerHolder
operator|!=
literal|null
condition|)
block|{
return|return
name|scannerHolder
operator|.
name|getNextCallSeq
argument_list|()
return|;
block|}
return|return
literal|0L
return|;
block|}
comment|/**    * Method to account for the size of retained cells and retained data blocks.    * @return an object that represents the last referenced block from this response.    */
name|Object
name|addSize
parameter_list|(
name|RpcCallContext
name|context
parameter_list|,
name|Result
name|r
parameter_list|,
name|Object
name|lastBlock
parameter_list|)
block|{
if|if
condition|(
name|context
operator|!=
literal|null
operator|&&
name|r
operator|!=
literal|null
operator|&&
operator|!
name|r
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
for|for
control|(
name|Cell
name|c
range|:
name|r
operator|.
name|rawCells
argument_list|()
control|)
block|{
name|context
operator|.
name|incrementResponseCellSize
argument_list|(
name|PrivateCellUtil
operator|.
name|estimatedSerializedSizeOf
argument_list|(
name|c
argument_list|)
argument_list|)
expr_stmt|;
comment|// Since byte buffers can point all kinds of crazy places it's harder to keep track
comment|// of which blocks are kept alive by what byte buffer.
comment|// So we make a guess.
if|if
condition|(
name|c
operator|instanceof
name|ByteBufferExtendedCell
condition|)
block|{
name|ByteBufferExtendedCell
name|bbCell
init|=
operator|(
name|ByteBufferExtendedCell
operator|)
name|c
decl_stmt|;
name|ByteBuffer
name|bb
init|=
name|bbCell
operator|.
name|getValueByteBuffer
argument_list|()
decl_stmt|;
if|if
condition|(
name|bb
operator|!=
name|lastBlock
condition|)
block|{
name|context
operator|.
name|incrementResponseBlockSize
argument_list|(
name|bb
operator|.
name|capacity
argument_list|()
argument_list|)
expr_stmt|;
name|lastBlock
operator|=
name|bb
expr_stmt|;
block|}
block|}
else|else
block|{
comment|// We're using the last block being the same as the current block as
comment|// a proxy for pointing to a new block. This won't be exact.
comment|// If there are multiple gets that bounce back and forth
comment|// Then it's possible that this will over count the size of
comment|// referenced blocks. However it's better to over count and
comment|// use two rpcs than to OOME the regionserver.
name|byte
index|[]
name|valueArray
init|=
name|c
operator|.
name|getValueArray
argument_list|()
decl_stmt|;
if|if
condition|(
name|valueArray
operator|!=
name|lastBlock
condition|)
block|{
name|context
operator|.
name|incrementResponseBlockSize
argument_list|(
name|valueArray
operator|.
name|length
argument_list|)
expr_stmt|;
name|lastBlock
operator|=
name|valueArray
expr_stmt|;
block|}
block|}
block|}
block|}
return|return
name|lastBlock
return|;
block|}
specifier|private
name|RegionScannerHolder
name|addScanner
parameter_list|(
name|String
name|scannerName
parameter_list|,
name|RegionScanner
name|s
parameter_list|,
name|Shipper
name|shipper
parameter_list|,
name|HRegion
name|r
parameter_list|,
name|boolean
name|needCursor
parameter_list|)
throws|throws
name|LeaseStillHeldException
block|{
name|Lease
name|lease
init|=
name|regionServer
operator|.
name|leases
operator|.
name|createLease
argument_list|(
name|scannerName
argument_list|,
name|this
operator|.
name|scannerLeaseTimeoutPeriod
argument_list|,
operator|new
name|ScannerListener
argument_list|(
name|scannerName
argument_list|)
argument_list|)
decl_stmt|;
name|RpcCallback
name|shippedCallback
init|=
operator|new
name|RegionScannerShippedCallBack
argument_list|(
name|scannerName
argument_list|,
name|shipper
argument_list|,
name|lease
argument_list|)
decl_stmt|;
name|RpcCallback
name|closeCallback
decl_stmt|;
if|if
condition|(
name|s
operator|instanceof
name|RpcCallback
condition|)
block|{
name|closeCallback
operator|=
operator|(
name|RpcCallback
operator|)
name|s
expr_stmt|;
block|}
else|else
block|{
name|closeCallback
operator|=
operator|new
name|RegionScannerCloseCallBack
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|RegionScannerHolder
name|rsh
init|=
operator|new
name|RegionScannerHolder
argument_list|(
name|scannerName
argument_list|,
name|s
argument_list|,
name|r
argument_list|,
name|closeCallback
argument_list|,
name|shippedCallback
argument_list|,
name|needCursor
argument_list|)
decl_stmt|;
name|RegionScannerHolder
name|existing
init|=
name|scanners
operator|.
name|putIfAbsent
argument_list|(
name|scannerName
argument_list|,
name|rsh
argument_list|)
decl_stmt|;
assert|assert
name|existing
operator|==
literal|null
operator|:
literal|"scannerId must be unique within regionserver's whole lifecycle! "
operator|+
name|scannerName
assert|;
return|return
name|rsh
return|;
block|}
comment|/**    * Find the HRegion based on a region specifier    *    * @param regionSpecifier the region specifier    * @return the corresponding region    * @throws IOException if the specifier is not null,    *    but failed to find the region    */
annotation|@
name|VisibleForTesting
specifier|public
name|HRegion
name|getRegion
parameter_list|(
specifier|final
name|RegionSpecifier
name|regionSpecifier
parameter_list|)
throws|throws
name|IOException
block|{
return|return
name|regionServer
operator|.
name|getRegion
argument_list|(
name|regionSpecifier
operator|.
name|getValue
argument_list|()
operator|.
name|toByteArray
argument_list|()
argument_list|)
return|;
block|}
comment|/**    * Find the List of HRegions based on a list of region specifiers    *    * @param regionSpecifiers the list of region specifiers    * @return the corresponding list of regions    * @throws IOException if any of the specifiers is not null,    *    but failed to find the region    */
specifier|private
name|List
argument_list|<
name|HRegion
argument_list|>
name|getRegions
parameter_list|(
specifier|final
name|List
argument_list|<
name|RegionSpecifier
argument_list|>
name|regionSpecifiers
parameter_list|,
specifier|final
name|CacheEvictionStatsBuilder
name|stats
parameter_list|)
block|{
name|List
argument_list|<
name|HRegion
argument_list|>
name|regions
init|=
name|Lists
operator|.
name|newArrayListWithCapacity
argument_list|(
name|regionSpecifiers
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|RegionSpecifier
name|regionSpecifier
range|:
name|regionSpecifiers
control|)
block|{
try|try
block|{
name|regions
operator|.
name|add
argument_list|(
name|regionServer
operator|.
name|getRegion
argument_list|(
name|regionSpecifier
operator|.
name|getValue
argument_list|()
operator|.
name|toByteArray
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NotServingRegionException
name|e
parameter_list|)
block|{
name|stats
operator|.
name|addException
argument_list|(
name|regionSpecifier
operator|.
name|getValue
argument_list|()
operator|.
name|toByteArray
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|regions
return|;
block|}
annotation|@
name|VisibleForTesting
specifier|public
name|PriorityFunction
name|getPriority
parameter_list|()
block|{
return|return
name|priority
return|;
block|}
annotation|@
name|VisibleForTesting
specifier|public
name|Configuration
name|getConfiguration
parameter_list|()
block|{
return|return
name|regionServer
operator|.
name|getConfiguration
argument_list|()
return|;
block|}
specifier|private
name|RegionServerRpcQuotaManager
name|getRpcQuotaManager
parameter_list|()
block|{
return|return
name|regionServer
operator|.
name|getRegionServerRpcQuotaManager
argument_list|()
return|;
block|}
specifier|private
name|RegionServerSpaceQuotaManager
name|getSpaceQuotaManager
parameter_list|()
block|{
return|return
name|regionServer
operator|.
name|getRegionServerSpaceQuotaManager
argument_list|()
return|;
block|}
name|void
name|start
parameter_list|(
name|ZKWatcher
name|zkWatcher
parameter_list|)
block|{
if|if
condition|(
name|AccessChecker
operator|.
name|isAuthorizationSupported
argument_list|(
name|getConfiguration
argument_list|()
argument_list|)
condition|)
block|{
name|accessChecker
operator|=
operator|new
name|AccessChecker
argument_list|(
name|getConfiguration
argument_list|()
argument_list|,
name|zkWatcher
argument_list|)
expr_stmt|;
block|}
name|this
operator|.
name|scannerIdGenerator
operator|=
operator|new
name|ScannerIdGenerator
argument_list|(
name|this
operator|.
name|regionServer
operator|.
name|serverName
argument_list|)
expr_stmt|;
name|rpcServer
operator|.
name|start
argument_list|()
expr_stmt|;
block|}
name|void
name|stop
parameter_list|()
block|{
if|if
condition|(
name|accessChecker
operator|!=
literal|null
condition|)
block|{
name|accessChecker
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
name|closeAllScanners
argument_list|()
expr_stmt|;
name|rpcServer
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
comment|/**    * Called to verify that this server is up and running.    */
comment|// TODO : Rename this and HMaster#checkInitialized to isRunning() (or a better name).
specifier|protected
name|void
name|checkOpen
parameter_list|()
throws|throws
name|IOException
block|{
if|if
condition|(
name|regionServer
operator|.
name|isAborted
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|RegionServerAbortedException
argument_list|(
literal|"Server "
operator|+
name|regionServer
operator|.
name|serverName
operator|+
literal|" aborting"
argument_list|)
throw|;
block|}
if|if
condition|(
name|regionServer
operator|.
name|isStopped
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|RegionServerStoppedException
argument_list|(
literal|"Server "
operator|+
name|regionServer
operator|.
name|serverName
operator|+
literal|" stopping"
argument_list|)
throw|;
block|}
if|if
condition|(
operator|!
name|regionServer
operator|.
name|fsOk
condition|)
block|{
throw|throw
operator|new
name|RegionServerStoppedException
argument_list|(
literal|"File system not available"
argument_list|)
throw|;
block|}
if|if
condition|(
operator|!
name|regionServer
operator|.
name|isOnline
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|ServerNotRunningYetException
argument_list|(
literal|"Server "
operator|+
name|regionServer
operator|.
name|serverName
operator|+
literal|" is not running yet"
argument_list|)
throw|;
block|}
block|}
comment|/**    * By default, put up an Admin and a Client Service.    * Set booleans<code>hbase.regionserver.admin.executorService</code> and    *<code>hbase.regionserver.client.executorService</code> if you want to enable/disable services.    * Default is that both are enabled.    * @return immutable list of blocking services and the security info classes that this server    * supports    */
specifier|protected
name|List
argument_list|<
name|BlockingServiceAndInterface
argument_list|>
name|getServices
parameter_list|()
block|{
name|boolean
name|admin
init|=
name|getConfiguration
argument_list|()
operator|.
name|getBoolean
argument_list|(
name|REGIONSERVER_ADMIN_SERVICE_CONFIG
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|boolean
name|client
init|=
name|getConfiguration
argument_list|()
operator|.
name|getBoolean
argument_list|(
name|REGIONSERVER_CLIENT_SERVICE_CONFIG
argument_list|,
literal|true
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|BlockingServiceAndInterface
argument_list|>
name|bssi
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
if|if
condition|(
name|client
condition|)
block|{
name|bssi
operator|.
name|add
argument_list|(
operator|new
name|BlockingServiceAndInterface
argument_list|(
name|ClientService
operator|.
name|newReflectiveBlockingService
argument_list|(
name|this
argument_list|)
argument_list|,
name|ClientService
operator|.
name|BlockingInterface
operator|.
name|class
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|admin
condition|)
block|{
name|bssi
operator|.
name|add
argument_list|(
operator|new
name|BlockingServiceAndInterface
argument_list|(
name|AdminService
operator|.
name|newReflectiveBlockingService
argument_list|(
name|this
argument_list|)
argument_list|,
name|AdminService
operator|.
name|BlockingInterface
operator|.
name|class
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|new
name|org
operator|.
name|apache
operator|.
name|hbase
operator|.
name|thirdparty
operator|.
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|ImmutableList
operator|.
name|Builder
argument_list|<
name|BlockingServiceAndInterface
argument_list|>
argument_list|()
operator|.
name|addAll
argument_list|(
name|bssi
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
specifier|public
name|InetSocketAddress
name|getSocketAddress
parameter_list|()
block|{
return|return
name|isa
return|;
block|}
annotation|@
name|Override
specifier|public
name|int
name|getPriority
parameter_list|(
name|RequestHeader
name|header
parameter_list|,
name|Message
name|param
parameter_list|,
name|User
name|user
parameter_list|)
block|{
return|return
name|priority
operator|.
name|getPriority
argument_list|(
name|header
argument_list|,
name|param
argument_list|,
name|user
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|long
name|getDeadline
parameter_list|(
name|RequestHeader
name|header
parameter_list|,
name|Message
name|param
parameter_list|)
block|{
return|return
name|priority
operator|.
name|getDeadline
argument_list|(
name|header
argument_list|,
name|param
argument_list|)
return|;
block|}
comment|/*    * Check if an OOME and, if so, abort immediately to avoid creating more objects.    *    * @param e    *    * @return True if we OOME'd and are aborting.    */
annotation|@
name|Override
specifier|public
name|boolean
name|checkOOME
parameter_list|(
specifier|final
name|Throwable
name|e
parameter_list|)
block|{
return|return
name|exitIfOOME
argument_list|(
name|e
argument_list|)
return|;
block|}
specifier|public
specifier|static
name|boolean
name|exitIfOOME
parameter_list|(
specifier|final
name|Throwable
name|e
parameter_list|)
block|{
name|boolean
name|stop
init|=
literal|false
decl_stmt|;
try|try
block|{
if|if
condition|(
name|e
operator|instanceof
name|OutOfMemoryError
operator|||
operator|(
name|e
operator|.
name|getCause
argument_list|()
operator|!=
literal|null
operator|&&
name|e
operator|.
name|getCause
argument_list|()
operator|instanceof
name|OutOfMemoryError
operator|)
operator|||
operator|(
name|e
operator|.
name|getMessage
argument_list|()
operator|!=
literal|null
operator|&&
name|e
operator|.
name|getMessage
argument_list|()
operator|.
name|contains
argument_list|(
literal|"java.lang.OutOfMemoryError"
argument_list|)
operator|)
condition|)
block|{
name|stop
operator|=
literal|true
expr_stmt|;
name|LOG
operator|.
name|error
argument_list|(
name|HBaseMarkers
operator|.
name|FATAL
argument_list|,
literal|"Run out of memory; "
operator|+
name|RSRpcServices
operator|.
name|class
operator|.
name|getSimpleName
argument_list|()
operator|+
literal|" will abort itself immediately"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
if|if
condition|(
name|stop
condition|)
block|{
name|Runtime
operator|.
name|getRuntime
argument_list|()
operator|.
name|halt
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|stop
return|;
block|}
comment|/**    * Close a region on the region server.    *    * @param controller the RPC controller    * @param request the request    * @throws ServiceException    */
annotation|@
name|Override
annotation|@
name|QosPriority
argument_list|(
name|priority
operator|=
name|HConstants
operator|.
name|ADMIN_QOS
argument_list|)
specifier|public
name|CloseRegionResponse
name|closeRegion
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|CloseRegionRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
specifier|final
name|ServerName
name|sn
init|=
operator|(
name|request
operator|.
name|hasDestinationServer
argument_list|()
condition|?
name|ProtobufUtil
operator|.
name|toServerName
argument_list|(
name|request
operator|.
name|getDestinationServer
argument_list|()
argument_list|)
else|:
literal|null
operator|)
decl_stmt|;
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
if|if
condition|(
name|request
operator|.
name|hasServerStartCode
argument_list|()
condition|)
block|{
comment|// check that we are the same server that this RPC is intended for.
name|long
name|serverStartCode
init|=
name|request
operator|.
name|getServerStartCode
argument_list|()
decl_stmt|;
if|if
condition|(
name|regionServer
operator|.
name|serverName
operator|.
name|getStartcode
argument_list|()
operator|!=
name|serverStartCode
condition|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
operator|new
name|DoNotRetryIOException
argument_list|(
literal|"This RPC was intended for a "
operator|+
literal|"different server with startCode: "
operator|+
name|serverStartCode
operator|+
literal|", this server is: "
operator|+
name|regionServer
operator|.
name|serverName
argument_list|)
argument_list|)
throw|;
block|}
block|}
specifier|final
name|String
name|encodedRegionName
init|=
name|ProtobufUtil
operator|.
name|getRegionEncodedName
argument_list|(
name|request
operator|.
name|getRegion
argument_list|()
argument_list|)
decl_stmt|;
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
if|if
condition|(
name|sn
operator|==
literal|null
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Close "
operator|+
name|encodedRegionName
operator|+
literal|" without moving"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Close "
operator|+
name|encodedRegionName
operator|+
literal|", moving to "
operator|+
name|sn
argument_list|)
expr_stmt|;
block|}
name|boolean
name|closed
init|=
name|regionServer
operator|.
name|closeRegion
argument_list|(
name|encodedRegionName
argument_list|,
literal|false
argument_list|,
name|sn
argument_list|)
decl_stmt|;
name|CloseRegionResponse
operator|.
name|Builder
name|builder
init|=
name|CloseRegionResponse
operator|.
name|newBuilder
argument_list|()
operator|.
name|setClosed
argument_list|(
name|closed
argument_list|)
decl_stmt|;
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
block|}
comment|/**    * Compact a region on the region server.    *    * @param controller the RPC controller    * @param request the request    * @throws ServiceException    */
annotation|@
name|Override
annotation|@
name|QosPriority
argument_list|(
name|priority
operator|=
name|HConstants
operator|.
name|ADMIN_QOS
argument_list|)
specifier|public
name|CompactRegionResponse
name|compactRegion
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|CompactRegionRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|HRegion
name|region
init|=
name|getRegion
argument_list|(
name|request
operator|.
name|getRegion
argument_list|()
argument_list|)
decl_stmt|;
comment|// Quota support is enabled, the requesting user is not system/super user
comment|// and a quota policy is enforced that disables compactions.
if|if
condition|(
name|QuotaUtil
operator|.
name|isQuotaEnabled
argument_list|(
name|getConfiguration
argument_list|()
argument_list|)
operator|&&
operator|!
name|Superusers
operator|.
name|isSuperUser
argument_list|(
name|RpcServer
operator|.
name|getRequestUser
argument_list|()
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
argument_list|)
operator|&&
name|this
operator|.
name|regionServer
operator|.
name|getRegionServerSpaceQuotaManager
argument_list|()
operator|.
name|areCompactionsDisabled
argument_list|(
name|region
operator|.
name|getTableDescriptor
argument_list|()
operator|.
name|getTableName
argument_list|()
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|DoNotRetryIOException
argument_list|(
literal|"Compactions on this region are "
operator|+
literal|"disabled due to a space quota violation."
argument_list|)
throw|;
block|}
name|region
operator|.
name|startRegionOperation
argument_list|(
name|Operation
operator|.
name|COMPACT_REGION
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Compacting "
operator|+
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getRegionNameAsString
argument_list|()
argument_list|)
expr_stmt|;
name|boolean
name|major
init|=
name|request
operator|.
name|hasMajor
argument_list|()
operator|&&
name|request
operator|.
name|getMajor
argument_list|()
decl_stmt|;
if|if
condition|(
name|request
operator|.
name|hasFamily
argument_list|()
condition|)
block|{
name|byte
index|[]
name|family
init|=
name|request
operator|.
name|getFamily
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|String
name|log
init|=
literal|"User-triggered "
operator|+
operator|(
name|major
condition|?
literal|"major "
else|:
literal|""
operator|)
operator|+
literal|"compaction for region "
operator|+
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getRegionNameAsString
argument_list|()
operator|+
literal|" and family "
operator|+
name|Bytes
operator|.
name|toString
argument_list|(
name|family
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|trace
argument_list|(
name|log
argument_list|)
expr_stmt|;
name|region
operator|.
name|requestCompaction
argument_list|(
name|family
argument_list|,
name|log
argument_list|,
name|Store
operator|.
name|PRIORITY_USER
argument_list|,
name|major
argument_list|,
name|CompactionLifeCycleTracker
operator|.
name|DUMMY
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|String
name|log
init|=
literal|"User-triggered "
operator|+
operator|(
name|major
condition|?
literal|"major "
else|:
literal|""
operator|)
operator|+
literal|"compaction for region "
operator|+
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getRegionNameAsString
argument_list|()
decl_stmt|;
name|LOG
operator|.
name|trace
argument_list|(
name|log
argument_list|)
expr_stmt|;
name|region
operator|.
name|requestCompaction
argument_list|(
name|log
argument_list|,
name|Store
operator|.
name|PRIORITY_USER
argument_list|,
name|major
argument_list|,
name|CompactionLifeCycleTracker
operator|.
name|DUMMY
argument_list|)
expr_stmt|;
block|}
return|return
name|CompactRegionResponse
operator|.
name|newBuilder
argument_list|()
operator|.
name|build
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
block|}
comment|/**    * Flush a region on the region server.    *    * @param controller the RPC controller    * @param request the request    * @throws ServiceException    */
annotation|@
name|Override
annotation|@
name|QosPriority
argument_list|(
name|priority
operator|=
name|HConstants
operator|.
name|ADMIN_QOS
argument_list|)
specifier|public
name|FlushRegionResponse
name|flushRegion
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|FlushRegionRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|HRegion
name|region
init|=
name|getRegion
argument_list|(
name|request
operator|.
name|getRegion
argument_list|()
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Flushing "
operator|+
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getRegionNameAsString
argument_list|()
argument_list|)
expr_stmt|;
name|boolean
name|shouldFlush
init|=
literal|true
decl_stmt|;
if|if
condition|(
name|request
operator|.
name|hasIfOlderThanTs
argument_list|()
condition|)
block|{
name|shouldFlush
operator|=
name|region
operator|.
name|getEarliestFlushTimeForAllStores
argument_list|()
operator|<
name|request
operator|.
name|getIfOlderThanTs
argument_list|()
expr_stmt|;
block|}
name|FlushRegionResponse
operator|.
name|Builder
name|builder
init|=
name|FlushRegionResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
if|if
condition|(
name|shouldFlush
condition|)
block|{
name|boolean
name|writeFlushWalMarker
init|=
name|request
operator|.
name|hasWriteFlushWalMarker
argument_list|()
condition|?
name|request
operator|.
name|getWriteFlushWalMarker
argument_list|()
else|:
literal|false
decl_stmt|;
comment|// Go behind the curtain so we can manage writing of the flush WAL marker
name|HRegion
operator|.
name|FlushResultImpl
name|flushResult
init|=
name|region
operator|.
name|flushcache
argument_list|(
literal|true
argument_list|,
name|writeFlushWalMarker
argument_list|,
name|FlushLifeCycleTracker
operator|.
name|DUMMY
argument_list|)
decl_stmt|;
name|boolean
name|compactionNeeded
init|=
name|flushResult
operator|.
name|isCompactionNeeded
argument_list|()
decl_stmt|;
if|if
condition|(
name|compactionNeeded
condition|)
block|{
name|regionServer
operator|.
name|compactSplitThread
operator|.
name|requestSystemCompaction
argument_list|(
name|region
argument_list|,
literal|"Compaction through user triggered flush"
argument_list|)
expr_stmt|;
block|}
name|builder
operator|.
name|setFlushed
argument_list|(
name|flushResult
operator|.
name|isFlushSucceeded
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|setWroteFlushWalMarker
argument_list|(
name|flushResult
operator|.
name|wroteFlushWalMarker
argument_list|)
expr_stmt|;
block|}
name|builder
operator|.
name|setLastFlushTime
argument_list|(
name|region
operator|.
name|getEarliestFlushTimeForAllStores
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|DroppedSnapshotException
name|ex
parameter_list|)
block|{
comment|// Cache flush can fail in a few places. If it fails in a critical
comment|// section, we get a DroppedSnapshotException and a replay of wal
comment|// is required. Currently the only way to do this is a restart of
comment|// the server.
name|regionServer
operator|.
name|abort
argument_list|(
literal|"Replay of WAL required. Forcing server shutdown"
argument_list|,
name|ex
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ex
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
block|}
annotation|@
name|Override
annotation|@
name|QosPriority
argument_list|(
name|priority
operator|=
name|HConstants
operator|.
name|ADMIN_QOS
argument_list|)
specifier|public
name|GetOnlineRegionResponse
name|getOnlineRegion
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|GetOnlineRegionRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|String
argument_list|,
name|HRegion
argument_list|>
name|onlineRegions
init|=
name|regionServer
operator|.
name|onlineRegions
decl_stmt|;
name|List
argument_list|<
name|RegionInfo
argument_list|>
name|list
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|onlineRegions
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|HRegion
name|region
range|:
name|onlineRegions
operator|.
name|values
argument_list|()
control|)
block|{
name|list
operator|.
name|add
argument_list|(
name|region
operator|.
name|getRegionInfo
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|Collections
operator|.
name|sort
argument_list|(
name|list
argument_list|,
name|RegionInfo
operator|.
name|COMPARATOR
argument_list|)
expr_stmt|;
return|return
name|ResponseConverter
operator|.
name|buildGetOnlineRegionResponse
argument_list|(
name|list
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
block|}
annotation|@
name|Override
annotation|@
name|QosPriority
argument_list|(
name|priority
operator|=
name|HConstants
operator|.
name|ADMIN_QOS
argument_list|)
specifier|public
name|GetRegionInfoResponse
name|getRegionInfo
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|GetRegionInfoRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|HRegion
name|region
init|=
name|getRegion
argument_list|(
name|request
operator|.
name|getRegion
argument_list|()
argument_list|)
decl_stmt|;
name|RegionInfo
name|info
init|=
name|region
operator|.
name|getRegionInfo
argument_list|()
decl_stmt|;
name|byte
index|[]
name|bestSplitRow
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|request
operator|.
name|hasBestSplitRow
argument_list|()
operator|&&
name|request
operator|.
name|getBestSplitRow
argument_list|()
condition|)
block|{
name|HRegion
name|r
init|=
name|region
decl_stmt|;
name|region
operator|.
name|startRegionOperation
argument_list|(
name|Operation
operator|.
name|SPLIT_REGION
argument_list|)
expr_stmt|;
name|r
operator|.
name|forceSplit
argument_list|(
literal|null
argument_list|)
expr_stmt|;
name|bestSplitRow
operator|=
name|r
operator|.
name|checkSplit
argument_list|()
expr_stmt|;
comment|// when all table data are in memstore, bestSplitRow = null
comment|// try to flush region first
if|if
condition|(
name|bestSplitRow
operator|==
literal|null
condition|)
block|{
name|r
operator|.
name|flush
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|bestSplitRow
operator|=
name|r
operator|.
name|checkSplit
argument_list|()
expr_stmt|;
block|}
name|r
operator|.
name|clearSplit
argument_list|()
expr_stmt|;
block|}
name|GetRegionInfoResponse
operator|.
name|Builder
name|builder
init|=
name|GetRegionInfoResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|setRegionInfo
argument_list|(
name|ProtobufUtil
operator|.
name|toRegionInfo
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|.
name|hasCompactionState
argument_list|()
operator|&&
name|request
operator|.
name|getCompactionState
argument_list|()
condition|)
block|{
name|builder
operator|.
name|setCompactionState
argument_list|(
name|ProtobufUtil
operator|.
name|createCompactionState
argument_list|(
name|region
operator|.
name|getCompactionState
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|builder
operator|.
name|setSplittable
argument_list|(
name|region
operator|.
name|isSplittable
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|setMergeable
argument_list|(
name|region
operator|.
name|isMergeable
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|.
name|hasBestSplitRow
argument_list|()
operator|&&
name|request
operator|.
name|getBestSplitRow
argument_list|()
operator|&&
name|bestSplitRow
operator|!=
literal|null
condition|)
block|{
name|builder
operator|.
name|setBestSplitRow
argument_list|(
name|UnsafeByteOperations
operator|.
name|unsafeWrap
argument_list|(
name|bestSplitRow
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
block|}
annotation|@
name|Override
annotation|@
name|QosPriority
argument_list|(
name|priority
operator|=
name|HConstants
operator|.
name|ADMIN_QOS
argument_list|)
specifier|public
name|GetRegionLoadResponse
name|getRegionLoad
parameter_list|(
name|RpcController
name|controller
parameter_list|,
name|GetRegionLoadRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
name|List
argument_list|<
name|HRegion
argument_list|>
name|regions
decl_stmt|;
if|if
condition|(
name|request
operator|.
name|hasTableName
argument_list|()
condition|)
block|{
name|TableName
name|tableName
init|=
name|ProtobufUtil
operator|.
name|toTableName
argument_list|(
name|request
operator|.
name|getTableName
argument_list|()
argument_list|)
decl_stmt|;
name|regions
operator|=
name|regionServer
operator|.
name|getRegions
argument_list|(
name|tableName
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|regions
operator|=
name|regionServer
operator|.
name|getRegions
argument_list|()
expr_stmt|;
block|}
name|List
argument_list|<
name|RegionLoad
argument_list|>
name|rLoads
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|regions
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
name|RegionLoad
operator|.
name|Builder
name|regionLoadBuilder
init|=
name|ClusterStatusProtos
operator|.
name|RegionLoad
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|RegionSpecifier
operator|.
name|Builder
name|regionSpecifier
init|=
name|RegionSpecifier
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
try|try
block|{
for|for
control|(
name|HRegion
name|region
range|:
name|regions
control|)
block|{
name|rLoads
operator|.
name|add
argument_list|(
name|regionServer
operator|.
name|createRegionLoad
argument_list|(
name|region
argument_list|,
name|regionLoadBuilder
argument_list|,
name|regionSpecifier
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|e
argument_list|)
throw|;
block|}
name|GetRegionLoadResponse
operator|.
name|Builder
name|builder
init|=
name|GetRegionLoadResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|addAllRegionLoads
argument_list|(
name|rLoads
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
annotation|@
name|Override
annotation|@
name|QosPriority
argument_list|(
name|priority
operator|=
name|HConstants
operator|.
name|ADMIN_QOS
argument_list|)
specifier|public
name|ClearCompactionQueuesResponse
name|clearCompactionQueues
parameter_list|(
name|RpcController
name|controller
parameter_list|,
name|ClearCompactionQueuesRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Client="
operator|+
name|RpcServer
operator|.
name|getRequestUserName
argument_list|()
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
operator|+
literal|"/"
operator|+
name|RpcServer
operator|.
name|getRemoteAddress
argument_list|()
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
operator|+
literal|" clear compactions queue"
argument_list|)
expr_stmt|;
name|ClearCompactionQueuesResponse
operator|.
name|Builder
name|respBuilder
init|=
name|ClearCompactionQueuesResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
if|if
condition|(
name|clearCompactionQueues
operator|.
name|compareAndSet
argument_list|(
literal|false
argument_list|,
literal|true
argument_list|)
condition|)
block|{
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|regionServer
operator|.
name|getRegionServerCoprocessorHost
argument_list|()
operator|.
name|preClearCompactionQueues
argument_list|()
expr_stmt|;
for|for
control|(
name|String
name|queueName
range|:
name|request
operator|.
name|getQueueNameList
argument_list|()
control|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"clear "
operator|+
name|queueName
operator|+
literal|" compaction queue"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|queueName
condition|)
block|{
case|case
literal|"long"
case|:
name|regionServer
operator|.
name|compactSplitThread
operator|.
name|clearLongCompactionsQueue
argument_list|()
expr_stmt|;
break|break;
case|case
literal|"short"
case|:
name|regionServer
operator|.
name|compactSplitThread
operator|.
name|clearShortCompactionsQueue
argument_list|()
expr_stmt|;
break|break;
default|default:
name|LOG
operator|.
name|warn
argument_list|(
literal|"Unknown queue name "
operator|+
name|queueName
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Unknown queue name "
operator|+
name|queueName
argument_list|)
throw|;
block|}
block|}
name|regionServer
operator|.
name|getRegionServerCoprocessorHost
argument_list|()
operator|.
name|postClearCompactionQueues
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
finally|finally
block|{
name|clearCompactionQueues
operator|.
name|set
argument_list|(
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Clear compactions queue is executing by other admin."
argument_list|)
expr_stmt|;
block|}
return|return
name|respBuilder
operator|.
name|build
argument_list|()
return|;
block|}
comment|/**    * Get some information of the region server.    *    * @param controller the RPC controller    * @param request the request    * @throws ServiceException    */
annotation|@
name|Override
annotation|@
name|QosPriority
argument_list|(
name|priority
operator|=
name|HConstants
operator|.
name|ADMIN_QOS
argument_list|)
specifier|public
name|GetServerInfoResponse
name|getServerInfo
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|GetServerInfoRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|int
name|infoPort
init|=
name|regionServer
operator|.
name|infoServer
operator|!=
literal|null
condition|?
name|regionServer
operator|.
name|infoServer
operator|.
name|getPort
argument_list|()
else|:
operator|-
literal|1
decl_stmt|;
return|return
name|ResponseConverter
operator|.
name|buildGetServerInfoResponse
argument_list|(
name|regionServer
operator|.
name|serverName
argument_list|,
name|infoPort
argument_list|)
return|;
block|}
annotation|@
name|Override
annotation|@
name|QosPriority
argument_list|(
name|priority
operator|=
name|HConstants
operator|.
name|ADMIN_QOS
argument_list|)
specifier|public
name|GetStoreFileResponse
name|getStoreFile
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|GetStoreFileRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|HRegion
name|region
init|=
name|getRegion
argument_list|(
name|request
operator|.
name|getRegion
argument_list|()
argument_list|)
decl_stmt|;
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|Set
argument_list|<
name|byte
index|[]
argument_list|>
name|columnFamilies
decl_stmt|;
if|if
condition|(
name|request
operator|.
name|getFamilyCount
argument_list|()
operator|==
literal|0
condition|)
block|{
name|columnFamilies
operator|=
name|region
operator|.
name|getTableDescriptor
argument_list|()
operator|.
name|getColumnFamilyNames
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|columnFamilies
operator|=
operator|new
name|TreeSet
argument_list|<>
argument_list|(
name|Bytes
operator|.
name|BYTES_RAWCOMPARATOR
argument_list|)
expr_stmt|;
for|for
control|(
name|ByteString
name|cf
range|:
name|request
operator|.
name|getFamilyList
argument_list|()
control|)
block|{
name|columnFamilies
operator|.
name|add
argument_list|(
name|cf
operator|.
name|toByteArray
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
name|int
name|nCF
init|=
name|columnFamilies
operator|.
name|size
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|fileList
init|=
name|region
operator|.
name|getStoreFileList
argument_list|(
name|columnFamilies
operator|.
name|toArray
argument_list|(
operator|new
name|byte
index|[
name|nCF
index|]
index|[]
argument_list|)
argument_list|)
decl_stmt|;
name|GetStoreFileResponse
operator|.
name|Builder
name|builder
init|=
name|GetStoreFileResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|addAllStoreFile
argument_list|(
name|fileList
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
block|}
comment|/**    * Open asynchronously a region or a set of regions on the region server.    *    * The opening is coordinated by ZooKeeper, and this method requires the znode to be created    *  before being called. As a consequence, this method should be called only from the master.    *<p>    * Different manages states for the region are:    *</p><ul>    *<li>region not opened: the region opening will start asynchronously.</li>    *<li>a close is already in progress: this is considered as an error.</li>    *<li>an open is already in progress: this new open request will be ignored. This is important    *  because the Master can do multiple requests if it crashes.</li>    *<li>the region is already opened:  this new open request will be ignored.</li>    *</ul>    *<p>    * Bulk assign: If there are more than 1 region to open, it will be considered as a bulk assign.    * For a single region opening, errors are sent through a ServiceException. For bulk assign,    * errors are put in the response as FAILED_OPENING.    *</p>    * @param controller the RPC controller    * @param request the request    * @throws ServiceException    */
annotation|@
name|Override
annotation|@
name|QosPriority
argument_list|(
name|priority
operator|=
name|HConstants
operator|.
name|ADMIN_QOS
argument_list|)
specifier|public
name|OpenRegionResponse
name|openRegion
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|OpenRegionRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
if|if
condition|(
name|request
operator|.
name|hasServerStartCode
argument_list|()
condition|)
block|{
comment|// check that we are the same server that this RPC is intended for.
name|long
name|serverStartCode
init|=
name|request
operator|.
name|getServerStartCode
argument_list|()
decl_stmt|;
if|if
condition|(
name|regionServer
operator|.
name|serverName
operator|.
name|getStartcode
argument_list|()
operator|!=
name|serverStartCode
condition|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
operator|new
name|DoNotRetryIOException
argument_list|(
literal|"This RPC was intended for a "
operator|+
literal|"different server with startCode: "
operator|+
name|serverStartCode
operator|+
literal|", this server is: "
operator|+
name|regionServer
operator|.
name|serverName
argument_list|)
argument_list|)
throw|;
block|}
block|}
name|OpenRegionResponse
operator|.
name|Builder
name|builder
init|=
name|OpenRegionResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
specifier|final
name|int
name|regionCount
init|=
name|request
operator|.
name|getOpenInfoCount
argument_list|()
decl_stmt|;
specifier|final
name|Map
argument_list|<
name|TableName
argument_list|,
name|TableDescriptor
argument_list|>
name|htds
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|(
name|regionCount
argument_list|)
decl_stmt|;
specifier|final
name|boolean
name|isBulkAssign
init|=
name|regionCount
operator|>
literal|1
decl_stmt|;
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
name|TableName
name|tableName
init|=
literal|null
decl_stmt|;
if|if
condition|(
name|regionCount
operator|==
literal|1
condition|)
block|{
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hbase
operator|.
name|shaded
operator|.
name|protobuf
operator|.
name|generated
operator|.
name|HBaseProtos
operator|.
name|RegionInfo
name|ri
init|=
name|request
operator|.
name|getOpenInfo
argument_list|(
literal|0
argument_list|)
operator|.
name|getRegion
argument_list|()
decl_stmt|;
if|if
condition|(
name|ri
operator|!=
literal|null
condition|)
block|{
name|tableName
operator|=
name|ProtobufUtil
operator|.
name|toTableName
argument_list|(
name|ri
operator|.
name|getTableName
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|TableName
operator|.
name|META_TABLE_NAME
operator|.
name|equals
argument_list|(
name|tableName
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
comment|// We are assigning meta, wait a little for regionserver to finish initialization.
name|int
name|timeout
init|=
name|regionServer
operator|.
name|conf
operator|.
name|getInt
argument_list|(
name|HConstants
operator|.
name|HBASE_RPC_TIMEOUT_KEY
argument_list|,
name|HConstants
operator|.
name|DEFAULT_HBASE_RPC_TIMEOUT
argument_list|)
operator|>>
literal|2
decl_stmt|;
comment|// Quarter of RPC timeout
name|long
name|endTime
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|+
name|timeout
decl_stmt|;
synchronized|synchronized
init|(
name|regionServer
operator|.
name|online
init|)
block|{
try|try
block|{
while|while
condition|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|<=
name|endTime
operator|&&
operator|!
name|regionServer
operator|.
name|isStopped
argument_list|()
operator|&&
operator|!
name|regionServer
operator|.
name|isOnline
argument_list|()
condition|)
block|{
name|regionServer
operator|.
name|online
operator|.
name|wait
argument_list|(
name|regionServer
operator|.
name|msgInterval
argument_list|)
expr_stmt|;
block|}
name|checkOpen
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|t
parameter_list|)
block|{
name|Thread
operator|.
name|currentThread
argument_list|()
operator|.
name|interrupt
argument_list|()
expr_stmt|;
throw|throw
operator|new
name|ServiceException
argument_list|(
name|t
argument_list|)
throw|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
block|}
name|long
name|masterSystemTime
init|=
name|request
operator|.
name|hasMasterSystemTime
argument_list|()
condition|?
name|request
operator|.
name|getMasterSystemTime
argument_list|()
else|:
operator|-
literal|1
decl_stmt|;
for|for
control|(
name|RegionOpenInfo
name|regionOpenInfo
range|:
name|request
operator|.
name|getOpenInfoList
argument_list|()
control|)
block|{
specifier|final
name|RegionInfo
name|region
init|=
name|ProtobufUtil
operator|.
name|toRegionInfo
argument_list|(
name|regionOpenInfo
operator|.
name|getRegion
argument_list|()
argument_list|)
decl_stmt|;
name|TableDescriptor
name|htd
decl_stmt|;
try|try
block|{
name|String
name|encodedName
init|=
name|region
operator|.
name|getEncodedName
argument_list|()
decl_stmt|;
name|byte
index|[]
name|encodedNameBytes
init|=
name|region
operator|.
name|getEncodedNameAsBytes
argument_list|()
decl_stmt|;
specifier|final
name|HRegion
name|onlineRegion
init|=
name|regionServer
operator|.
name|getRegion
argument_list|(
name|encodedName
argument_list|)
decl_stmt|;
if|if
condition|(
name|onlineRegion
operator|!=
literal|null
condition|)
block|{
comment|// The region is already online. This should not happen any more.
name|String
name|error
init|=
literal|"Received OPEN for the region:"
operator|+
name|region
operator|.
name|getRegionNameAsString
argument_list|()
operator|+
literal|", which is already online"
decl_stmt|;
name|LOG
operator|.
name|warn
argument_list|(
name|error
argument_list|)
expr_stmt|;
comment|//regionServer.abort(error);
comment|//throw new IOException(error);
name|builder
operator|.
name|addOpeningState
argument_list|(
name|RegionOpeningState
operator|.
name|OPENED
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|LOG
operator|.
name|info
argument_list|(
literal|"Open "
operator|+
name|region
operator|.
name|getRegionNameAsString
argument_list|()
argument_list|)
expr_stmt|;
specifier|final
name|Boolean
name|previous
init|=
name|regionServer
operator|.
name|regionsInTransitionInRS
operator|.
name|putIfAbsent
argument_list|(
name|encodedNameBytes
argument_list|,
name|Boolean
operator|.
name|TRUE
argument_list|)
decl_stmt|;
if|if
condition|(
name|Boolean
operator|.
name|FALSE
operator|.
name|equals
argument_list|(
name|previous
argument_list|)
condition|)
block|{
if|if
condition|(
name|regionServer
operator|.
name|getRegion
argument_list|(
name|encodedName
argument_list|)
operator|!=
literal|null
condition|)
block|{
comment|// There is a close in progress. This should not happen any more.
name|String
name|error
init|=
literal|"Received OPEN for the region:"
operator|+
name|region
operator|.
name|getRegionNameAsString
argument_list|()
operator|+
literal|", which we are already trying to CLOSE"
decl_stmt|;
name|regionServer
operator|.
name|abort
argument_list|(
name|error
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|IOException
argument_list|(
name|error
argument_list|)
throw|;
block|}
name|regionServer
operator|.
name|regionsInTransitionInRS
operator|.
name|put
argument_list|(
name|encodedNameBytes
argument_list|,
name|Boolean
operator|.
name|TRUE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Boolean
operator|.
name|TRUE
operator|.
name|equals
argument_list|(
name|previous
argument_list|)
condition|)
block|{
comment|// An open is in progress. This is supported, but let's log this.
name|LOG
operator|.
name|info
argument_list|(
literal|"Receiving OPEN for the region:"
operator|+
name|region
operator|.
name|getRegionNameAsString
argument_list|()
operator|+
literal|", which we are already trying to OPEN"
operator|+
literal|" - ignoring this new request for this region."
argument_list|)
expr_stmt|;
block|}
comment|// We are opening this region. If it moves back and forth for whatever reason, we don't
comment|// want to keep returning the stale moved record while we are opening/if we close again.
name|regionServer
operator|.
name|removeFromMovedRegions
argument_list|(
name|region
operator|.
name|getEncodedName
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|previous
operator|==
literal|null
operator|||
operator|!
name|previous
operator|.
name|booleanValue
argument_list|()
condition|)
block|{
name|htd
operator|=
name|htds
operator|.
name|get
argument_list|(
name|region
operator|.
name|getTable
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|htd
operator|==
literal|null
condition|)
block|{
name|htd
operator|=
name|regionServer
operator|.
name|tableDescriptors
operator|.
name|get
argument_list|(
name|region
operator|.
name|getTable
argument_list|()
argument_list|)
expr_stmt|;
name|htds
operator|.
name|put
argument_list|(
name|region
operator|.
name|getTable
argument_list|()
argument_list|,
name|htd
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|htd
operator|==
literal|null
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
literal|"Missing table descriptor for "
operator|+
name|region
operator|.
name|getEncodedName
argument_list|()
argument_list|)
throw|;
block|}
comment|// If there is no action in progress, we can submit a specific handler.
comment|// Need to pass the expected version in the constructor.
if|if
condition|(
name|regionServer
operator|.
name|executorService
operator|==
literal|null
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"No executor executorService; skipping open request"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|region
operator|.
name|isMetaRegion
argument_list|()
condition|)
block|{
name|regionServer
operator|.
name|executorService
operator|.
name|submit
argument_list|(
operator|new
name|OpenMetaHandler
argument_list|(
name|regionServer
argument_list|,
name|regionServer
argument_list|,
name|region
argument_list|,
name|htd
argument_list|,
name|masterSystemTime
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|regionOpenInfo
operator|.
name|getFavoredNodesCount
argument_list|()
operator|>
literal|0
condition|)
block|{
name|regionServer
operator|.
name|updateRegionFavoredNodesMapping
argument_list|(
name|region
operator|.
name|getEncodedName
argument_list|()
argument_list|,
name|regionOpenInfo
operator|.
name|getFavoredNodesList
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|htd
operator|.
name|getPriority
argument_list|()
operator|>=
name|HConstants
operator|.
name|ADMIN_QOS
operator|||
name|region
operator|.
name|getTable
argument_list|()
operator|.
name|isSystemTable
argument_list|()
condition|)
block|{
name|regionServer
operator|.
name|executorService
operator|.
name|submit
argument_list|(
operator|new
name|OpenPriorityRegionHandler
argument_list|(
name|regionServer
argument_list|,
name|regionServer
argument_list|,
name|region
argument_list|,
name|htd
argument_list|,
name|masterSystemTime
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|regionServer
operator|.
name|executorService
operator|.
name|submit
argument_list|(
operator|new
name|OpenRegionHandler
argument_list|(
name|regionServer
argument_list|,
name|regionServer
argument_list|,
name|region
argument_list|,
name|htd
argument_list|,
name|masterSystemTime
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|builder
operator|.
name|addOpeningState
argument_list|(
name|RegionOpeningState
operator|.
name|OPENED
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Failed opening region "
operator|+
name|region
operator|.
name|getRegionNameAsString
argument_list|()
argument_list|,
name|ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|isBulkAssign
condition|)
block|{
name|builder
operator|.
name|addOpeningState
argument_list|(
name|RegionOpeningState
operator|.
name|FAILED_OPENING
argument_list|)
expr_stmt|;
block|}
else|else
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
block|}
block|}
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
comment|/**    *  Wamrmup a region on this server.    *    * This method should only be called by Master. It synchrnously opens the region and    * closes the region bringing the most important pages in cache.    *<p>    *    * @param controller the RPC controller    * @param request the request    * @throws ServiceException    */
annotation|@
name|Override
specifier|public
name|WarmupRegionResponse
name|warmupRegion
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|WarmupRegionRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
specifier|final
name|RegionInfo
name|region
init|=
name|ProtobufUtil
operator|.
name|toRegionInfo
argument_list|(
name|request
operator|.
name|getRegionInfo
argument_list|()
argument_list|)
decl_stmt|;
name|TableDescriptor
name|htd
decl_stmt|;
name|WarmupRegionResponse
name|response
init|=
name|WarmupRegionResponse
operator|.
name|getDefaultInstance
argument_list|()
decl_stmt|;
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|String
name|encodedName
init|=
name|region
operator|.
name|getEncodedName
argument_list|()
decl_stmt|;
name|byte
index|[]
name|encodedNameBytes
init|=
name|region
operator|.
name|getEncodedNameAsBytes
argument_list|()
decl_stmt|;
specifier|final
name|HRegion
name|onlineRegion
init|=
name|regionServer
operator|.
name|getRegion
argument_list|(
name|encodedName
argument_list|)
decl_stmt|;
if|if
condition|(
name|onlineRegion
operator|!=
literal|null
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Region already online. Skipping warming up "
operator|+
name|region
argument_list|)
expr_stmt|;
return|return
name|response
return|;
block|}
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Warming up Region "
operator|+
name|region
operator|.
name|getRegionNameAsString
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|htd
operator|=
name|regionServer
operator|.
name|tableDescriptors
operator|.
name|get
argument_list|(
name|region
operator|.
name|getTable
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|regionServer
operator|.
name|getRegionsInTransitionInRS
argument_list|()
operator|.
name|containsKey
argument_list|(
name|encodedNameBytes
argument_list|)
condition|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Region is in transition. Skipping warmup "
operator|+
name|region
argument_list|)
expr_stmt|;
return|return
name|response
return|;
block|}
name|HRegion
operator|.
name|warmupHRegion
argument_list|(
name|region
argument_list|,
name|htd
argument_list|,
name|regionServer
operator|.
name|getWAL
argument_list|(
name|region
argument_list|)
argument_list|,
name|regionServer
operator|.
name|getConfiguration
argument_list|()
argument_list|,
name|regionServer
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Failed warming up region "
operator|+
name|region
operator|.
name|getRegionNameAsString
argument_list|()
argument_list|,
name|ie
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
return|return
name|response
return|;
block|}
comment|/**    * Replay the given changes when distributedLogReplay WAL edits from a failed RS. The guarantee is    * that the given mutations will be durable on the receiving RS if this method returns without any    * exception.    * @param controller the RPC controller    * @param request the request    * @throws ServiceException    */
annotation|@
name|Override
annotation|@
name|QosPriority
argument_list|(
name|priority
operator|=
name|HConstants
operator|.
name|REPLAY_QOS
argument_list|)
specifier|public
name|ReplicateWALEntryResponse
name|replay
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|ReplicateWALEntryRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
name|long
name|before
init|=
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
decl_stmt|;
name|CellScanner
name|cells
init|=
operator|(
operator|(
name|HBaseRpcController
operator|)
name|controller
operator|)
operator|.
name|cellScanner
argument_list|()
decl_stmt|;
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|List
argument_list|<
name|WALEntry
argument_list|>
name|entries
init|=
name|request
operator|.
name|getEntryList
argument_list|()
decl_stmt|;
if|if
condition|(
name|entries
operator|==
literal|null
operator|||
name|entries
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
comment|// empty input
return|return
name|ReplicateWALEntryResponse
operator|.
name|newBuilder
argument_list|()
operator|.
name|build
argument_list|()
return|;
block|}
name|ByteString
name|regionName
init|=
name|entries
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|getKey
argument_list|()
operator|.
name|getEncodedRegionName
argument_list|()
decl_stmt|;
name|HRegion
name|region
init|=
name|regionServer
operator|.
name|getRegionByEncodedName
argument_list|(
name|regionName
operator|.
name|toStringUtf8
argument_list|()
argument_list|)
decl_stmt|;
name|RegionCoprocessorHost
name|coprocessorHost
init|=
name|ServerRegionReplicaUtil
operator|.
name|isDefaultReplica
argument_list|(
name|region
operator|.
name|getRegionInfo
argument_list|()
argument_list|)
condition|?
name|region
operator|.
name|getCoprocessorHost
argument_list|()
else|:
literal|null
decl_stmt|;
comment|// do not invoke coprocessors if this is a secondary region replica
name|List
argument_list|<
name|Pair
argument_list|<
name|WALKey
argument_list|,
name|WALEdit
argument_list|>
argument_list|>
name|walEntries
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
comment|// Skip adding the edits to WAL if this is a secondary region replica
name|boolean
name|isPrimary
init|=
name|RegionReplicaUtil
operator|.
name|isDefaultReplica
argument_list|(
name|region
operator|.
name|getRegionInfo
argument_list|()
argument_list|)
decl_stmt|;
name|Durability
name|durability
init|=
name|isPrimary
condition|?
name|Durability
operator|.
name|USE_DEFAULT
else|:
name|Durability
operator|.
name|SKIP_WAL
decl_stmt|;
for|for
control|(
name|WALEntry
name|entry
range|:
name|entries
control|)
block|{
if|if
condition|(
operator|!
name|regionName
operator|.
name|equals
argument_list|(
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|getEncodedRegionName
argument_list|()
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|NotServingRegionException
argument_list|(
literal|"Replay request contains entries from multiple "
operator|+
literal|"regions. First region:"
operator|+
name|regionName
operator|.
name|toStringUtf8
argument_list|()
operator|+
literal|" , other region:"
operator|+
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|getEncodedRegionName
argument_list|()
argument_list|)
throw|;
block|}
if|if
condition|(
name|regionServer
operator|.
name|nonceManager
operator|!=
literal|null
operator|&&
name|isPrimary
condition|)
block|{
name|long
name|nonceGroup
init|=
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|hasNonceGroup
argument_list|()
condition|?
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|getNonceGroup
argument_list|()
else|:
name|HConstants
operator|.
name|NO_NONCE
decl_stmt|;
name|long
name|nonce
init|=
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|hasNonce
argument_list|()
condition|?
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|getNonce
argument_list|()
else|:
name|HConstants
operator|.
name|NO_NONCE
decl_stmt|;
name|regionServer
operator|.
name|nonceManager
operator|.
name|reportOperationFromWal
argument_list|(
name|nonceGroup
argument_list|,
name|nonce
argument_list|,
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|getWriteTime
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|Pair
argument_list|<
name|WALKey
argument_list|,
name|WALEdit
argument_list|>
name|walEntry
init|=
operator|(
name|coprocessorHost
operator|==
literal|null
operator|)
condition|?
literal|null
else|:
operator|new
name|Pair
argument_list|<>
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|WALSplitter
operator|.
name|MutationReplay
argument_list|>
name|edits
init|=
name|WALSplitter
operator|.
name|getMutationsFromWALEntry
argument_list|(
name|entry
argument_list|,
name|cells
argument_list|,
name|walEntry
argument_list|,
name|durability
argument_list|)
decl_stmt|;
if|if
condition|(
name|coprocessorHost
operator|!=
literal|null
condition|)
block|{
comment|// Start coprocessor replay here. The coprocessor is for each WALEdit instead of a
comment|// KeyValue.
if|if
condition|(
name|coprocessorHost
operator|.
name|preWALRestore
argument_list|(
name|region
operator|.
name|getRegionInfo
argument_list|()
argument_list|,
name|walEntry
operator|.
name|getFirst
argument_list|()
argument_list|,
name|walEntry
operator|.
name|getSecond
argument_list|()
argument_list|)
condition|)
block|{
comment|// if bypass this log entry, ignore it ...
continue|continue;
block|}
name|walEntries
operator|.
name|add
argument_list|(
name|walEntry
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|edits
operator|!=
literal|null
operator|&&
operator|!
name|edits
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
comment|// HBASE-17924
comment|// sort to improve lock efficiency
name|Collections
operator|.
name|sort
argument_list|(
name|edits
argument_list|,
parameter_list|(
name|v1
parameter_list|,
name|v2
parameter_list|)
lambda|->
name|Row
operator|.
name|COMPARATOR
operator|.
name|compare
argument_list|(
name|v1
operator|.
name|mutation
argument_list|,
name|v2
operator|.
name|mutation
argument_list|)
argument_list|)
expr_stmt|;
name|long
name|replaySeqId
init|=
operator|(
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|hasOrigSequenceNumber
argument_list|()
operator|)
condition|?
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|getOrigSequenceNumber
argument_list|()
else|:
name|entry
operator|.
name|getKey
argument_list|()
operator|.
name|getLogSequenceNumber
argument_list|()
decl_stmt|;
name|OperationStatus
index|[]
name|result
init|=
name|doReplayBatchOp
argument_list|(
name|region
argument_list|,
name|edits
argument_list|,
name|replaySeqId
argument_list|)
decl_stmt|;
comment|// check if it's a partial success
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|result
operator|!=
literal|null
operator|&&
name|i
operator|<
name|result
operator|.
name|length
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|result
index|[
name|i
index|]
operator|!=
name|OperationStatus
operator|.
name|SUCCESS
condition|)
block|{
throw|throw
operator|new
name|IOException
argument_list|(
name|result
index|[
name|i
index|]
operator|.
name|getExceptionMsg
argument_list|()
argument_list|)
throw|;
block|}
block|}
block|}
block|}
comment|//sync wal at the end because ASYNC_WAL is used above
name|WAL
name|wal
init|=
name|region
operator|.
name|getWAL
argument_list|()
decl_stmt|;
if|if
condition|(
name|wal
operator|!=
literal|null
condition|)
block|{
name|wal
operator|.
name|sync
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|coprocessorHost
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|Pair
argument_list|<
name|WALKey
argument_list|,
name|WALEdit
argument_list|>
name|entry
range|:
name|walEntries
control|)
block|{
name|coprocessorHost
operator|.
name|postWALRestore
argument_list|(
name|region
operator|.
name|getRegionInfo
argument_list|()
argument_list|,
name|entry
operator|.
name|getFirst
argument_list|()
argument_list|,
name|entry
operator|.
name|getSecond
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ReplicateWALEntryResponse
operator|.
name|newBuilder
argument_list|()
operator|.
name|build
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|regionServer
operator|.
name|metricsRegionServer
operator|!=
literal|null
condition|)
block|{
name|regionServer
operator|.
name|metricsRegionServer
operator|.
name|updateReplay
argument_list|(
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
operator|-
name|before
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/**    * Replicate WAL entries on the region server.    *    * @param controller the RPC controller    * @param request the request    * @throws ServiceException    */
annotation|@
name|Override
annotation|@
name|QosPriority
argument_list|(
name|priority
operator|=
name|HConstants
operator|.
name|REPLICATION_QOS
argument_list|)
specifier|public
name|ReplicateWALEntryResponse
name|replicateWALEntry
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|ReplicateWALEntryRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
if|if
condition|(
name|regionServer
operator|.
name|replicationSinkHandler
operator|!=
literal|null
condition|)
block|{
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|List
argument_list|<
name|WALEntry
argument_list|>
name|entries
init|=
name|request
operator|.
name|getEntryList
argument_list|()
decl_stmt|;
name|CellScanner
name|cellScanner
init|=
operator|(
operator|(
name|HBaseRpcController
operator|)
name|controller
operator|)
operator|.
name|cellScanner
argument_list|()
decl_stmt|;
name|regionServer
operator|.
name|getRegionServerCoprocessorHost
argument_list|()
operator|.
name|preReplicateLogEntries
argument_list|()
expr_stmt|;
name|regionServer
operator|.
name|replicationSinkHandler
operator|.
name|replicateLogEntries
argument_list|(
name|entries
argument_list|,
name|cellScanner
argument_list|,
name|request
operator|.
name|getReplicationClusterId
argument_list|()
argument_list|,
name|request
operator|.
name|getSourceBaseNamespaceDirPath
argument_list|()
argument_list|,
name|request
operator|.
name|getSourceHFileArchiveDirPath
argument_list|()
argument_list|)
expr_stmt|;
name|regionServer
operator|.
name|getRegionServerCoprocessorHost
argument_list|()
operator|.
name|postReplicateLogEntries
argument_list|()
expr_stmt|;
return|return
name|ReplicateWALEntryResponse
operator|.
name|newBuilder
argument_list|()
operator|.
name|build
argument_list|()
return|;
block|}
else|else
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
literal|"Replication services are not initialized yet"
argument_list|)
throw|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
block|}
comment|/**    * Roll the WAL writer of the region server.    * @param controller the RPC controller    * @param request the request    * @throws ServiceException    */
annotation|@
name|Override
specifier|public
name|RollWALWriterResponse
name|rollWALWriter
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|RollWALWriterRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|regionServer
operator|.
name|getRegionServerCoprocessorHost
argument_list|()
operator|.
name|preRollWALWriterRequest
argument_list|()
expr_stmt|;
name|regionServer
operator|.
name|walRoller
operator|.
name|requestRollAll
argument_list|()
expr_stmt|;
name|regionServer
operator|.
name|getRegionServerCoprocessorHost
argument_list|()
operator|.
name|postRollWALWriterRequest
argument_list|()
expr_stmt|;
name|RollWALWriterResponse
operator|.
name|Builder
name|builder
init|=
name|RollWALWriterResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
block|}
comment|/**    * Stop the region server.    *    * @param controller the RPC controller    * @param request the request    * @throws ServiceException    */
annotation|@
name|Override
annotation|@
name|QosPriority
argument_list|(
name|priority
operator|=
name|HConstants
operator|.
name|ADMIN_QOS
argument_list|)
specifier|public
name|StopServerResponse
name|stopServer
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|StopServerRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|String
name|reason
init|=
name|request
operator|.
name|getReason
argument_list|()
decl_stmt|;
name|regionServer
operator|.
name|stop
argument_list|(
name|reason
argument_list|)
expr_stmt|;
return|return
name|StopServerResponse
operator|.
name|newBuilder
argument_list|()
operator|.
name|build
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|UpdateFavoredNodesResponse
name|updateFavoredNodes
parameter_list|(
name|RpcController
name|controller
parameter_list|,
name|UpdateFavoredNodesRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
name|List
argument_list|<
name|UpdateFavoredNodesRequest
operator|.
name|RegionUpdateInfo
argument_list|>
name|openInfoList
init|=
name|request
operator|.
name|getUpdateInfoList
argument_list|()
decl_stmt|;
name|UpdateFavoredNodesResponse
operator|.
name|Builder
name|respBuilder
init|=
name|UpdateFavoredNodesResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
for|for
control|(
name|UpdateFavoredNodesRequest
operator|.
name|RegionUpdateInfo
name|regionUpdateInfo
range|:
name|openInfoList
control|)
block|{
name|RegionInfo
name|hri
init|=
name|ProtobufUtil
operator|.
name|toRegionInfo
argument_list|(
name|regionUpdateInfo
operator|.
name|getRegion
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|regionUpdateInfo
operator|.
name|getFavoredNodesCount
argument_list|()
operator|>
literal|0
condition|)
block|{
name|regionServer
operator|.
name|updateRegionFavoredNodesMapping
argument_list|(
name|hri
operator|.
name|getEncodedName
argument_list|()
argument_list|,
name|regionUpdateInfo
operator|.
name|getFavoredNodesList
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
name|respBuilder
operator|.
name|setResponse
argument_list|(
name|openInfoList
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|respBuilder
operator|.
name|build
argument_list|()
return|;
block|}
comment|/**    * Atomically bulk load several HFiles into an open region    * @return true if successful, false is failed but recoverably (no action)    * @throws ServiceException if failed unrecoverably    */
annotation|@
name|Override
specifier|public
name|BulkLoadHFileResponse
name|bulkLoadHFile
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|BulkLoadHFileRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
name|long
name|start
init|=
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
decl_stmt|;
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|HRegion
name|region
init|=
name|getRegion
argument_list|(
name|request
operator|.
name|getRegion
argument_list|()
argument_list|)
decl_stmt|;
name|Map
argument_list|<
name|byte
index|[]
argument_list|,
name|List
argument_list|<
name|Path
argument_list|>
argument_list|>
name|map
init|=
literal|null
decl_stmt|;
specifier|final
name|boolean
name|spaceQuotaEnabled
init|=
name|QuotaUtil
operator|.
name|isQuotaEnabled
argument_list|(
name|getConfiguration
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|sizeToBeLoaded
init|=
operator|-
literal|1
decl_stmt|;
comment|// Check to see if this bulk load would exceed the space quota for this table
if|if
condition|(
name|spaceQuotaEnabled
condition|)
block|{
name|ActivePolicyEnforcement
name|activeSpaceQuotas
init|=
name|getSpaceQuotaManager
argument_list|()
operator|.
name|getActiveEnforcements
argument_list|()
decl_stmt|;
name|SpaceViolationPolicyEnforcement
name|enforcement
init|=
name|activeSpaceQuotas
operator|.
name|getPolicyEnforcement
argument_list|(
name|region
argument_list|)
decl_stmt|;
if|if
condition|(
name|enforcement
operator|!=
literal|null
condition|)
block|{
comment|// Bulk loads must still be atomic. We must enact all or none.
name|List
argument_list|<
name|String
argument_list|>
name|filePaths
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|request
operator|.
name|getFamilyPathCount
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|FamilyPath
name|familyPath
range|:
name|request
operator|.
name|getFamilyPathList
argument_list|()
control|)
block|{
name|filePaths
operator|.
name|add
argument_list|(
name|familyPath
operator|.
name|getPath
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// Check if the batch of files exceeds the current quota
name|sizeToBeLoaded
operator|=
name|enforcement
operator|.
name|computeBulkLoadSize
argument_list|(
name|regionServer
operator|.
name|getFileSystem
argument_list|()
argument_list|,
name|filePaths
argument_list|)
expr_stmt|;
block|}
block|}
name|List
argument_list|<
name|Pair
argument_list|<
name|byte
index|[]
argument_list|,
name|String
argument_list|>
argument_list|>
name|familyPaths
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|request
operator|.
name|getFamilyPathCount
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|FamilyPath
name|familyPath
range|:
name|request
operator|.
name|getFamilyPathList
argument_list|()
control|)
block|{
name|familyPaths
operator|.
name|add
argument_list|(
operator|new
name|Pair
argument_list|<>
argument_list|(
name|familyPath
operator|.
name|getFamily
argument_list|()
operator|.
name|toByteArray
argument_list|()
argument_list|,
name|familyPath
operator|.
name|getPath
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|request
operator|.
name|hasBulkToken
argument_list|()
condition|)
block|{
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|preBulkLoadHFile
argument_list|(
name|familyPaths
argument_list|)
expr_stmt|;
block|}
try|try
block|{
name|map
operator|=
name|region
operator|.
name|bulkLoadHFiles
argument_list|(
name|familyPaths
argument_list|,
name|request
operator|.
name|getAssignSeqNum
argument_list|()
argument_list|,
literal|null
argument_list|,
name|request
operator|.
name|getCopyFile
argument_list|()
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|postBulkLoadHFile
argument_list|(
name|familyPaths
argument_list|,
name|map
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|// secure bulk load
name|map
operator|=
name|regionServer
operator|.
name|secureBulkLoadManager
operator|.
name|secureBulkLoadHFiles
argument_list|(
name|region
argument_list|,
name|request
argument_list|)
expr_stmt|;
block|}
name|BulkLoadHFileResponse
operator|.
name|Builder
name|builder
init|=
name|BulkLoadHFileResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|setLoaded
argument_list|(
name|map
operator|!=
literal|null
argument_list|)
expr_stmt|;
if|if
condition|(
name|map
operator|!=
literal|null
condition|)
block|{
comment|// Treat any negative size as a flag to "ignore" updating the region size as that is
comment|// not possible to occur in real life (cannot bulk load a file with negative size)
if|if
condition|(
name|spaceQuotaEnabled
operator|&&
name|sizeToBeLoaded
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|LOG
operator|.
name|isTraceEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|trace
argument_list|(
literal|"Incrementing space use of "
operator|+
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|+
literal|" by "
operator|+
name|sizeToBeLoaded
operator|+
literal|" bytes"
argument_list|)
expr_stmt|;
block|}
comment|// Inform space quotas of the new files for this region
name|getSpaceQuotaManager
argument_list|()
operator|.
name|getRegionSizeStore
argument_list|()
operator|.
name|incrementRegionSize
argument_list|(
name|region
operator|.
name|getRegionInfo
argument_list|()
argument_list|,
name|sizeToBeLoaded
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|regionServer
operator|.
name|metricsRegionServer
operator|!=
literal|null
condition|)
block|{
name|regionServer
operator|.
name|metricsRegionServer
operator|.
name|updateBulkLoad
argument_list|(
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
operator|-
name|start
argument_list|)
expr_stmt|;
block|}
block|}
block|}
annotation|@
name|Override
specifier|public
name|PrepareBulkLoadResponse
name|prepareBulkLoad
parameter_list|(
name|RpcController
name|controller
parameter_list|,
name|PrepareBulkLoadRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|HRegion
name|region
init|=
name|getRegion
argument_list|(
name|request
operator|.
name|getRegion
argument_list|()
argument_list|)
decl_stmt|;
name|String
name|bulkToken
init|=
name|regionServer
operator|.
name|secureBulkLoadManager
operator|.
name|prepareBulkLoad
argument_list|(
name|region
argument_list|,
name|request
argument_list|)
decl_stmt|;
name|PrepareBulkLoadResponse
operator|.
name|Builder
name|builder
init|=
name|PrepareBulkLoadResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|setBulkToken
argument_list|(
name|bulkToken
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|CleanupBulkLoadResponse
name|cleanupBulkLoad
parameter_list|(
name|RpcController
name|controller
parameter_list|,
name|CleanupBulkLoadRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|HRegion
name|region
init|=
name|getRegion
argument_list|(
name|request
operator|.
name|getRegion
argument_list|()
argument_list|)
decl_stmt|;
name|regionServer
operator|.
name|secureBulkLoadManager
operator|.
name|cleanupBulkLoad
argument_list|(
name|region
argument_list|,
name|request
argument_list|)
expr_stmt|;
name|CleanupBulkLoadResponse
name|response
init|=
name|CleanupBulkLoadResponse
operator|.
name|newBuilder
argument_list|()
operator|.
name|build
argument_list|()
decl_stmt|;
return|return
name|response
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|CoprocessorServiceResponse
name|execService
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|CoprocessorServiceRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|HRegion
name|region
init|=
name|getRegion
argument_list|(
name|request
operator|.
name|getRegion
argument_list|()
argument_list|)
decl_stmt|;
name|com
operator|.
name|google
operator|.
name|protobuf
operator|.
name|Message
name|result
init|=
name|execServiceOnRegion
argument_list|(
name|region
argument_list|,
name|request
operator|.
name|getCall
argument_list|()
argument_list|)
decl_stmt|;
name|CoprocessorServiceResponse
operator|.
name|Builder
name|builder
init|=
name|CoprocessorServiceResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|builder
operator|.
name|setRegion
argument_list|(
name|RequestConverter
operator|.
name|buildRegionSpecifier
argument_list|(
name|RegionSpecifierType
operator|.
name|REGION_NAME
argument_list|,
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getRegionName
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
comment|// TODO: COPIES!!!!!!
name|builder
operator|.
name|setValue
argument_list|(
name|builder
operator|.
name|getValueBuilder
argument_list|()
operator|.
name|setName
argument_list|(
name|result
operator|.
name|getClass
argument_list|()
operator|.
name|getName
argument_list|()
argument_list|)
operator|.
name|setValue
argument_list|(
name|org
operator|.
name|apache
operator|.
name|hbase
operator|.
name|thirdparty
operator|.
name|com
operator|.
name|google
operator|.
name|protobuf
operator|.
name|ByteString
operator|.
name|copyFrom
argument_list|(
name|result
operator|.
name|toByteArray
argument_list|()
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
block|}
specifier|private
name|com
operator|.
name|google
operator|.
name|protobuf
operator|.
name|Message
name|execServiceOnRegion
parameter_list|(
name|HRegion
name|region
parameter_list|,
specifier|final
name|ClientProtos
operator|.
name|CoprocessorServiceCall
name|serviceCall
parameter_list|)
throws|throws
name|IOException
block|{
comment|// ignore the passed in controller (from the serialized call)
name|ServerRpcController
name|execController
init|=
operator|new
name|ServerRpcController
argument_list|()
decl_stmt|;
return|return
name|region
operator|.
name|execService
argument_list|(
name|execController
argument_list|,
name|serviceCall
argument_list|)
return|;
block|}
comment|/**    * Get data from a table.    *    * @param controller the RPC controller    * @param request the get request    * @throws ServiceException    */
annotation|@
name|Override
specifier|public
name|GetResponse
name|get
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|GetRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
name|long
name|before
init|=
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
decl_stmt|;
name|OperationQuota
name|quota
init|=
literal|null
decl_stmt|;
name|HRegion
name|region
init|=
literal|null
decl_stmt|;
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|rpcGetRequestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|region
operator|=
name|getRegion
argument_list|(
name|request
operator|.
name|getRegion
argument_list|()
argument_list|)
expr_stmt|;
name|GetResponse
operator|.
name|Builder
name|builder
init|=
name|GetResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|ClientProtos
operator|.
name|Get
name|get
init|=
name|request
operator|.
name|getGet
argument_list|()
decl_stmt|;
name|Boolean
name|existence
init|=
literal|null
decl_stmt|;
name|Result
name|r
init|=
literal|null
decl_stmt|;
name|RpcCallContext
name|context
init|=
name|RpcServer
operator|.
name|getCurrentCall
argument_list|()
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
decl_stmt|;
name|quota
operator|=
name|getRpcQuotaManager
argument_list|()
operator|.
name|checkQuota
argument_list|(
name|region
argument_list|,
name|OperationQuota
operator|.
name|OperationType
operator|.
name|GET
argument_list|)
expr_stmt|;
name|Get
name|clientGet
init|=
name|ProtobufUtil
operator|.
name|toGet
argument_list|(
name|get
argument_list|)
decl_stmt|;
if|if
condition|(
name|get
operator|.
name|getExistenceOnly
argument_list|()
operator|&&
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|existence
operator|=
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|preExists
argument_list|(
name|clientGet
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|existence
operator|==
literal|null
condition|)
block|{
if|if
condition|(
name|context
operator|!=
literal|null
condition|)
block|{
name|r
operator|=
name|get
argument_list|(
name|clientGet
argument_list|,
operator|(
name|region
operator|)
argument_list|,
literal|null
argument_list|,
name|context
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// for test purpose
name|r
operator|=
name|region
operator|.
name|get
argument_list|(
name|clientGet
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|get
operator|.
name|getExistenceOnly
argument_list|()
condition|)
block|{
name|boolean
name|exists
init|=
name|r
operator|.
name|getExists
argument_list|()
decl_stmt|;
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|exists
operator|=
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|postExists
argument_list|(
name|clientGet
argument_list|,
name|exists
argument_list|)
expr_stmt|;
block|}
name|existence
operator|=
name|exists
expr_stmt|;
block|}
block|}
if|if
condition|(
name|existence
operator|!=
literal|null
condition|)
block|{
name|ClientProtos
operator|.
name|Result
name|pbr
init|=
name|ProtobufUtil
operator|.
name|toResult
argument_list|(
name|existence
argument_list|,
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getReplicaId
argument_list|()
operator|!=
literal|0
argument_list|)
decl_stmt|;
name|builder
operator|.
name|setResult
argument_list|(
name|pbr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|r
operator|!=
literal|null
condition|)
block|{
name|ClientProtos
operator|.
name|Result
name|pbr
decl_stmt|;
if|if
condition|(
name|isClientCellBlockSupport
argument_list|(
name|context
argument_list|)
operator|&&
name|controller
operator|instanceof
name|HBaseRpcController
operator|&&
name|VersionInfoUtil
operator|.
name|hasMinimumVersion
argument_list|(
name|context
operator|.
name|getClientVersionInfo
argument_list|()
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|)
condition|)
block|{
name|pbr
operator|=
name|ProtobufUtil
operator|.
name|toResultNoData
argument_list|(
name|r
argument_list|)
expr_stmt|;
operator|(
operator|(
name|HBaseRpcController
operator|)
name|controller
operator|)
operator|.
name|setCellScanner
argument_list|(
name|CellUtil
operator|.
name|createCellScanner
argument_list|(
name|r
operator|.
name|rawCells
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|addSize
argument_list|(
name|context
argument_list|,
name|r
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pbr
operator|=
name|ProtobufUtil
operator|.
name|toResult
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
name|builder
operator|.
name|setResult
argument_list|(
name|pbr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|!=
literal|null
condition|)
block|{
name|quota
operator|.
name|addGetResult
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
finally|finally
block|{
name|MetricsRegionServer
name|mrs
init|=
name|regionServer
operator|.
name|metricsRegionServer
decl_stmt|;
if|if
condition|(
name|mrs
operator|!=
literal|null
condition|)
block|{
name|TableDescriptor
name|td
init|=
name|region
operator|!=
literal|null
condition|?
name|region
operator|.
name|getTableDescriptor
argument_list|()
else|:
literal|null
decl_stmt|;
if|if
condition|(
name|td
operator|!=
literal|null
condition|)
block|{
name|mrs
operator|.
name|updateGet
argument_list|(
name|td
operator|.
name|getTableName
argument_list|()
argument_list|,
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
operator|-
name|before
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|quota
operator|!=
literal|null
condition|)
block|{
name|quota
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
block|}
specifier|private
name|Result
name|get
parameter_list|(
name|Get
name|get
parameter_list|,
name|HRegion
name|region
parameter_list|,
name|RegionScannersCloseCallBack
name|closeCallBack
parameter_list|,
name|RpcCallContext
name|context
parameter_list|)
throws|throws
name|IOException
block|{
name|region
operator|.
name|prepareGet
argument_list|(
name|get
argument_list|)
expr_stmt|;
name|boolean
name|stale
init|=
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getReplicaId
argument_list|()
operator|!=
literal|0
decl_stmt|;
comment|// This method is almost the same as HRegion#get.
name|List
argument_list|<
name|Cell
argument_list|>
name|results
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|long
name|before
init|=
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
decl_stmt|;
comment|// pre-get CP hook
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|preGet
argument_list|(
name|get
argument_list|,
name|results
argument_list|)
condition|)
block|{
name|region
operator|.
name|metricsUpdateForGet
argument_list|(
name|results
argument_list|,
name|before
argument_list|)
expr_stmt|;
return|return
name|Result
operator|.
name|create
argument_list|(
name|results
argument_list|,
name|get
operator|.
name|isCheckExistenceOnly
argument_list|()
condition|?
operator|!
name|results
operator|.
name|isEmpty
argument_list|()
else|:
literal|null
argument_list|,
name|stale
argument_list|)
return|;
block|}
block|}
name|Scan
name|scan
init|=
operator|new
name|Scan
argument_list|(
name|get
argument_list|)
decl_stmt|;
if|if
condition|(
name|scan
operator|.
name|getLoadColumnFamiliesOnDemandValue
argument_list|()
operator|==
literal|null
condition|)
block|{
name|scan
operator|.
name|setLoadColumnFamiliesOnDemand
argument_list|(
name|region
operator|.
name|isLoadingCfsOnDemandDefault
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|RegionScannerImpl
name|scanner
init|=
literal|null
decl_stmt|;
try|try
block|{
name|scanner
operator|=
name|region
operator|.
name|getScanner
argument_list|(
name|scan
argument_list|)
expr_stmt|;
name|scanner
operator|.
name|next
argument_list|(
name|results
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
if|if
condition|(
name|scanner
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|closeCallBack
operator|==
literal|null
condition|)
block|{
comment|// If there is a context then the scanner can be added to the current
comment|// RpcCallContext. The rpc callback will take care of closing the
comment|// scanner, for eg in case
comment|// of get()
name|context
operator|.
name|setCallBack
argument_list|(
name|scanner
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// The call is from multi() where the results from the get() are
comment|// aggregated and then send out to the
comment|// rpc. The rpccall back will close all such scanners created as part
comment|// of multi().
name|closeCallBack
operator|.
name|addScanner
argument_list|(
name|scanner
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|// post-get CP hook
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|postGet
argument_list|(
name|get
argument_list|,
name|results
argument_list|)
expr_stmt|;
block|}
name|region
operator|.
name|metricsUpdateForGet
argument_list|(
name|results
argument_list|,
name|before
argument_list|)
expr_stmt|;
return|return
name|Result
operator|.
name|create
argument_list|(
name|results
argument_list|,
name|get
operator|.
name|isCheckExistenceOnly
argument_list|()
condition|?
operator|!
name|results
operator|.
name|isEmpty
argument_list|()
else|:
literal|null
argument_list|,
name|stale
argument_list|)
return|;
block|}
specifier|private
name|void
name|checkBatchSizeAndLogLargeSize
parameter_list|(
name|MultiRequest
name|request
parameter_list|)
block|{
name|int
name|sum
init|=
literal|0
decl_stmt|;
name|String
name|firstRegionName
init|=
literal|null
decl_stmt|;
for|for
control|(
name|RegionAction
name|regionAction
range|:
name|request
operator|.
name|getRegionActionList
argument_list|()
control|)
block|{
if|if
condition|(
name|sum
operator|==
literal|0
condition|)
block|{
name|firstRegionName
operator|=
name|Bytes
operator|.
name|toStringBinary
argument_list|(
name|regionAction
operator|.
name|getRegion
argument_list|()
operator|.
name|getValue
argument_list|()
operator|.
name|toByteArray
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|sum
operator|+=
name|regionAction
operator|.
name|getActionCount
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|sum
operator|>
name|rowSizeWarnThreshold
condition|)
block|{
name|ld
operator|.
name|logBatchWarning
argument_list|(
name|firstRegionName
argument_list|,
name|sum
argument_list|,
name|rowSizeWarnThreshold
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Execute multiple actions on a table: get, mutate, and/or execCoprocessor    *    * @param rpcc the RPC controller    * @param request the multi request    * @throws ServiceException    */
annotation|@
name|Override
specifier|public
name|MultiResponse
name|multi
parameter_list|(
specifier|final
name|RpcController
name|rpcc
parameter_list|,
specifier|final
name|MultiRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
name|checkBatchSizeAndLogLargeSize
argument_list|(
name|request
argument_list|)
expr_stmt|;
comment|// rpc controller is how we bring in data via the back door;  it is unprotobuf'ed data.
comment|// It is also the conduit via which we pass back data.
name|HBaseRpcController
name|controller
init|=
operator|(
name|HBaseRpcController
operator|)
name|rpcc
decl_stmt|;
name|CellScanner
name|cellScanner
init|=
name|controller
operator|!=
literal|null
condition|?
name|controller
operator|.
name|cellScanner
argument_list|()
else|:
literal|null
decl_stmt|;
if|if
condition|(
name|controller
operator|!=
literal|null
condition|)
block|{
name|controller
operator|.
name|setCellScanner
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
name|long
name|nonceGroup
init|=
name|request
operator|.
name|hasNonceGroup
argument_list|()
condition|?
name|request
operator|.
name|getNonceGroup
argument_list|()
else|:
name|HConstants
operator|.
name|NO_NONCE
decl_stmt|;
comment|// this will contain all the cells that we need to return. It's created later, if needed.
name|List
argument_list|<
name|CellScannable
argument_list|>
name|cellsToReturn
init|=
literal|null
decl_stmt|;
name|MultiResponse
operator|.
name|Builder
name|responseBuilder
init|=
name|MultiResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|RegionActionResult
operator|.
name|Builder
name|regionActionResultBuilder
init|=
name|RegionActionResult
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|Boolean
name|processed
init|=
literal|null
decl_stmt|;
name|RegionScannersCloseCallBack
name|closeCallBack
init|=
literal|null
decl_stmt|;
name|RpcCallContext
name|context
init|=
name|RpcServer
operator|.
name|getCurrentCall
argument_list|()
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
decl_stmt|;
name|this
operator|.
name|rpcMultiRequestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|this
operator|.
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|Map
argument_list|<
name|RegionSpecifier
argument_list|,
name|ClientProtos
operator|.
name|RegionLoadStats
argument_list|>
name|regionStats
init|=
operator|new
name|HashMap
argument_list|<>
argument_list|(
name|request
operator|.
name|getRegionActionCount
argument_list|()
argument_list|)
decl_stmt|;
name|ActivePolicyEnforcement
name|spaceQuotaEnforcement
init|=
name|getSpaceQuotaManager
argument_list|()
operator|.
name|getActiveEnforcements
argument_list|()
decl_stmt|;
for|for
control|(
name|RegionAction
name|regionAction
range|:
name|request
operator|.
name|getRegionActionList
argument_list|()
control|)
block|{
name|OperationQuota
name|quota
decl_stmt|;
name|HRegion
name|region
decl_stmt|;
name|regionActionResultBuilder
operator|.
name|clear
argument_list|()
expr_stmt|;
name|RegionSpecifier
name|regionSpecifier
init|=
name|regionAction
operator|.
name|getRegion
argument_list|()
decl_stmt|;
try|try
block|{
name|region
operator|=
name|getRegion
argument_list|(
name|regionSpecifier
argument_list|)
expr_stmt|;
name|quota
operator|=
name|getRpcQuotaManager
argument_list|()
operator|.
name|checkQuota
argument_list|(
name|region
argument_list|,
name|regionAction
operator|.
name|getActionList
argument_list|()
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|rpcServer
operator|.
name|getMetrics
argument_list|()
operator|.
name|exception
argument_list|(
name|e
argument_list|)
expr_stmt|;
name|regionActionResultBuilder
operator|.
name|setException
argument_list|(
name|ResponseConverter
operator|.
name|buildException
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
name|responseBuilder
operator|.
name|addRegionActionResult
argument_list|(
name|regionActionResultBuilder
operator|.
name|build
argument_list|()
argument_list|)
expr_stmt|;
comment|// All Mutations in this RegionAction not executed as we can not see the Region online here
comment|// in this RS. Will be retried from Client. Skipping all the Cells in CellScanner
comment|// corresponding to these Mutations.
name|skipCellsForMutations
argument_list|(
name|regionAction
operator|.
name|getActionList
argument_list|()
argument_list|,
name|cellScanner
argument_list|)
expr_stmt|;
continue|continue;
comment|// For this region it's a failure.
block|}
if|if
condition|(
name|regionAction
operator|.
name|hasAtomic
argument_list|()
operator|&&
name|regionAction
operator|.
name|getAtomic
argument_list|()
condition|)
block|{
comment|// How does this call happen?  It may need some work to play well w/ the surroundings.
comment|// Need to return an item per Action along w/ Action index.  TODO.
try|try
block|{
if|if
condition|(
name|request
operator|.
name|hasCondition
argument_list|()
condition|)
block|{
name|Condition
name|condition
init|=
name|request
operator|.
name|getCondition
argument_list|()
decl_stmt|;
name|byte
index|[]
name|row
init|=
name|condition
operator|.
name|getRow
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|byte
index|[]
name|family
init|=
name|condition
operator|.
name|getFamily
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|byte
index|[]
name|qualifier
init|=
name|condition
operator|.
name|getQualifier
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|CompareOperator
name|op
init|=
name|CompareOperator
operator|.
name|valueOf
argument_list|(
name|condition
operator|.
name|getCompareType
argument_list|()
operator|.
name|name
argument_list|()
argument_list|)
decl_stmt|;
name|ByteArrayComparable
name|comparator
init|=
name|ProtobufUtil
operator|.
name|toComparator
argument_list|(
name|condition
operator|.
name|getComparator
argument_list|()
argument_list|)
decl_stmt|;
name|processed
operator|=
name|checkAndRowMutate
argument_list|(
name|region
argument_list|,
name|regionAction
operator|.
name|getActionList
argument_list|()
argument_list|,
name|cellScanner
argument_list|,
name|row
argument_list|,
name|family
argument_list|,
name|qualifier
argument_list|,
name|op
argument_list|,
name|comparator
argument_list|,
name|regionActionResultBuilder
argument_list|,
name|spaceQuotaEnforcement
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|doAtomicBatchOp
argument_list|(
name|regionActionResultBuilder
argument_list|,
name|region
argument_list|,
name|quota
argument_list|,
name|regionAction
operator|.
name|getActionList
argument_list|()
argument_list|,
name|cellScanner
argument_list|,
name|spaceQuotaEnforcement
argument_list|)
expr_stmt|;
name|processed
operator|=
name|Boolean
operator|.
name|TRUE
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|rpcServer
operator|.
name|getMetrics
argument_list|()
operator|.
name|exception
argument_list|(
name|e
argument_list|)
expr_stmt|;
comment|// As it's atomic, we may expect it's a global failure.
name|regionActionResultBuilder
operator|.
name|setException
argument_list|(
name|ResponseConverter
operator|.
name|buildException
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|// doNonAtomicRegionMutation manages the exception internally
if|if
condition|(
name|context
operator|!=
literal|null
operator|&&
name|closeCallBack
operator|==
literal|null
condition|)
block|{
comment|// An RpcCallBack that creates a list of scanners that needs to perform callBack
comment|// operation on completion of multiGets.
comment|// Set this only once
name|closeCallBack
operator|=
operator|new
name|RegionScannersCloseCallBack
argument_list|()
expr_stmt|;
name|context
operator|.
name|setCallBack
argument_list|(
name|closeCallBack
argument_list|)
expr_stmt|;
block|}
name|cellsToReturn
operator|=
name|doNonAtomicRegionMutation
argument_list|(
name|region
argument_list|,
name|quota
argument_list|,
name|regionAction
argument_list|,
name|cellScanner
argument_list|,
name|regionActionResultBuilder
argument_list|,
name|cellsToReturn
argument_list|,
name|nonceGroup
argument_list|,
name|closeCallBack
argument_list|,
name|context
argument_list|,
name|spaceQuotaEnforcement
argument_list|)
expr_stmt|;
block|}
name|responseBuilder
operator|.
name|addRegionActionResult
argument_list|(
name|regionActionResultBuilder
operator|.
name|build
argument_list|()
argument_list|)
expr_stmt|;
name|quota
operator|.
name|close
argument_list|()
expr_stmt|;
name|ClientProtos
operator|.
name|RegionLoadStats
name|regionLoadStats
init|=
name|region
operator|.
name|getLoadStatistics
argument_list|()
decl_stmt|;
if|if
condition|(
name|regionLoadStats
operator|!=
literal|null
condition|)
block|{
name|regionStats
operator|.
name|put
argument_list|(
name|regionSpecifier
argument_list|,
name|regionLoadStats
argument_list|)
expr_stmt|;
block|}
block|}
comment|// Load the controller with the Cells to return.
if|if
condition|(
name|cellsToReturn
operator|!=
literal|null
operator|&&
operator|!
name|cellsToReturn
operator|.
name|isEmpty
argument_list|()
operator|&&
name|controller
operator|!=
literal|null
condition|)
block|{
name|controller
operator|.
name|setCellScanner
argument_list|(
name|CellUtil
operator|.
name|createCellScanner
argument_list|(
name|cellsToReturn
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|processed
operator|!=
literal|null
condition|)
block|{
name|responseBuilder
operator|.
name|setProcessed
argument_list|(
name|processed
argument_list|)
expr_stmt|;
block|}
name|MultiRegionLoadStats
operator|.
name|Builder
name|builder
init|=
name|MultiRegionLoadStats
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
for|for
control|(
name|Entry
argument_list|<
name|RegionSpecifier
argument_list|,
name|ClientProtos
operator|.
name|RegionLoadStats
argument_list|>
name|stat
range|:
name|regionStats
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|builder
operator|.
name|addRegion
argument_list|(
name|stat
operator|.
name|getKey
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|addStat
argument_list|(
name|stat
operator|.
name|getValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|responseBuilder
operator|.
name|setRegionStatistics
argument_list|(
name|builder
argument_list|)
expr_stmt|;
return|return
name|responseBuilder
operator|.
name|build
argument_list|()
return|;
block|}
specifier|private
name|void
name|skipCellsForMutations
parameter_list|(
name|List
argument_list|<
name|Action
argument_list|>
name|actions
parameter_list|,
name|CellScanner
name|cellScanner
parameter_list|)
block|{
if|if
condition|(
name|cellScanner
operator|==
literal|null
condition|)
block|{
return|return;
block|}
for|for
control|(
name|Action
name|action
range|:
name|actions
control|)
block|{
name|skipCellsForMutation
argument_list|(
name|action
argument_list|,
name|cellScanner
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|skipCellsForMutation
parameter_list|(
name|Action
name|action
parameter_list|,
name|CellScanner
name|cellScanner
parameter_list|)
block|{
if|if
condition|(
name|cellScanner
operator|==
literal|null
condition|)
block|{
return|return;
block|}
try|try
block|{
if|if
condition|(
name|action
operator|.
name|hasMutation
argument_list|()
condition|)
block|{
name|MutationProto
name|m
init|=
name|action
operator|.
name|getMutation
argument_list|()
decl_stmt|;
if|if
condition|(
name|m
operator|.
name|hasAssociatedCellCount
argument_list|()
condition|)
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|m
operator|.
name|getAssociatedCellCount
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|cellScanner
operator|.
name|advance
argument_list|()
expr_stmt|;
block|}
block|}
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
comment|// No need to handle these Individual Muatation level issue. Any way this entire RegionAction
comment|// marked as failed as we could not see the Region here. At client side the top level
comment|// RegionAction exception will be considered first.
name|LOG
operator|.
name|error
argument_list|(
literal|"Error while skipping Cells in CellScanner for invalid Region Mutations"
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Mutate data in a table.    *    * @param rpcc the RPC controller    * @param request the mutate request    */
annotation|@
name|Override
specifier|public
name|MutateResponse
name|mutate
parameter_list|(
specifier|final
name|RpcController
name|rpcc
parameter_list|,
specifier|final
name|MutateRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
comment|// rpc controller is how we bring in data via the back door;  it is unprotobuf'ed data.
comment|// It is also the conduit via which we pass back data.
name|HBaseRpcController
name|controller
init|=
operator|(
name|HBaseRpcController
operator|)
name|rpcc
decl_stmt|;
name|CellScanner
name|cellScanner
init|=
name|controller
operator|!=
literal|null
condition|?
name|controller
operator|.
name|cellScanner
argument_list|()
else|:
literal|null
decl_stmt|;
name|OperationQuota
name|quota
init|=
literal|null
decl_stmt|;
name|RpcCallContext
name|context
init|=
name|RpcServer
operator|.
name|getCurrentCall
argument_list|()
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
decl_stmt|;
name|ActivePolicyEnforcement
name|spaceQuotaEnforcement
init|=
literal|null
decl_stmt|;
name|MutationType
name|type
init|=
literal|null
decl_stmt|;
name|HRegion
name|region
init|=
literal|null
decl_stmt|;
name|long
name|before
init|=
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
decl_stmt|;
comment|// Clear scanner so we are not holding on to reference across call.
if|if
condition|(
name|controller
operator|!=
literal|null
condition|)
block|{
name|controller
operator|.
name|setCellScanner
argument_list|(
literal|null
argument_list|)
expr_stmt|;
block|}
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|rpcMutateRequestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|region
operator|=
name|getRegion
argument_list|(
name|request
operator|.
name|getRegion
argument_list|()
argument_list|)
expr_stmt|;
name|MutateResponse
operator|.
name|Builder
name|builder
init|=
name|MutateResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|MutationProto
name|mutation
init|=
name|request
operator|.
name|getMutation
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|isMetaRegion
argument_list|()
condition|)
block|{
name|regionServer
operator|.
name|cacheFlusher
operator|.
name|reclaimMemStoreMemory
argument_list|()
expr_stmt|;
block|}
name|long
name|nonceGroup
init|=
name|request
operator|.
name|hasNonceGroup
argument_list|()
condition|?
name|request
operator|.
name|getNonceGroup
argument_list|()
else|:
name|HConstants
operator|.
name|NO_NONCE
decl_stmt|;
name|Result
name|r
init|=
literal|null
decl_stmt|;
name|Boolean
name|processed
init|=
literal|null
decl_stmt|;
name|type
operator|=
name|mutation
operator|.
name|getMutateType
argument_list|()
expr_stmt|;
name|quota
operator|=
name|getRpcQuotaManager
argument_list|()
operator|.
name|checkQuota
argument_list|(
name|region
argument_list|,
name|OperationQuota
operator|.
name|OperationType
operator|.
name|MUTATE
argument_list|)
expr_stmt|;
name|spaceQuotaEnforcement
operator|=
name|getSpaceQuotaManager
argument_list|()
operator|.
name|getActiveEnforcements
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|APPEND
case|:
comment|// TODO: this doesn't actually check anything.
name|r
operator|=
name|append
argument_list|(
name|region
argument_list|,
name|quota
argument_list|,
name|mutation
argument_list|,
name|cellScanner
argument_list|,
name|nonceGroup
argument_list|,
name|spaceQuotaEnforcement
argument_list|)
expr_stmt|;
break|break;
case|case
name|INCREMENT
case|:
comment|// TODO: this doesn't actually check anything.
name|r
operator|=
name|increment
argument_list|(
name|region
argument_list|,
name|quota
argument_list|,
name|mutation
argument_list|,
name|cellScanner
argument_list|,
name|nonceGroup
argument_list|,
name|spaceQuotaEnforcement
argument_list|)
expr_stmt|;
break|break;
case|case
name|PUT
case|:
name|Put
name|put
init|=
name|ProtobufUtil
operator|.
name|toPut
argument_list|(
name|mutation
argument_list|,
name|cellScanner
argument_list|)
decl_stmt|;
name|checkCellSizeLimit
argument_list|(
name|region
argument_list|,
name|put
argument_list|)
expr_stmt|;
comment|// Throws an exception when violated
name|spaceQuotaEnforcement
operator|.
name|getPolicyEnforcement
argument_list|(
name|region
argument_list|)
operator|.
name|check
argument_list|(
name|put
argument_list|)
expr_stmt|;
name|quota
operator|.
name|addMutation
argument_list|(
name|put
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|.
name|hasCondition
argument_list|()
condition|)
block|{
name|Condition
name|condition
init|=
name|request
operator|.
name|getCondition
argument_list|()
decl_stmt|;
name|byte
index|[]
name|row
init|=
name|condition
operator|.
name|getRow
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|byte
index|[]
name|family
init|=
name|condition
operator|.
name|getFamily
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|byte
index|[]
name|qualifier
init|=
name|condition
operator|.
name|getQualifier
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|CompareOperator
name|compareOp
init|=
name|CompareOperator
operator|.
name|valueOf
argument_list|(
name|condition
operator|.
name|getCompareType
argument_list|()
operator|.
name|name
argument_list|()
argument_list|)
decl_stmt|;
name|ByteArrayComparable
name|comparator
init|=
name|ProtobufUtil
operator|.
name|toComparator
argument_list|(
name|condition
operator|.
name|getComparator
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|processed
operator|=
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|preCheckAndPut
argument_list|(
name|row
argument_list|,
name|family
argument_list|,
name|qualifier
argument_list|,
name|compareOp
argument_list|,
name|comparator
argument_list|,
name|put
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|processed
operator|==
literal|null
condition|)
block|{
name|boolean
name|result
init|=
name|region
operator|.
name|checkAndMutate
argument_list|(
name|row
argument_list|,
name|family
argument_list|,
name|qualifier
argument_list|,
name|compareOp
argument_list|,
name|comparator
argument_list|,
name|put
argument_list|,
literal|true
argument_list|)
decl_stmt|;
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|result
operator|=
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|postCheckAndPut
argument_list|(
name|row
argument_list|,
name|family
argument_list|,
name|qualifier
argument_list|,
name|compareOp
argument_list|,
name|comparator
argument_list|,
name|put
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
name|processed
operator|=
name|result
expr_stmt|;
block|}
block|}
else|else
block|{
name|region
operator|.
name|put
argument_list|(
name|put
argument_list|)
expr_stmt|;
name|processed
operator|=
name|Boolean
operator|.
name|TRUE
expr_stmt|;
block|}
break|break;
case|case
name|DELETE
case|:
name|Delete
name|delete
init|=
name|ProtobufUtil
operator|.
name|toDelete
argument_list|(
name|mutation
argument_list|,
name|cellScanner
argument_list|)
decl_stmt|;
name|checkCellSizeLimit
argument_list|(
name|region
argument_list|,
name|delete
argument_list|)
expr_stmt|;
name|spaceQuotaEnforcement
operator|.
name|getPolicyEnforcement
argument_list|(
name|region
argument_list|)
operator|.
name|check
argument_list|(
name|delete
argument_list|)
expr_stmt|;
name|quota
operator|.
name|addMutation
argument_list|(
name|delete
argument_list|)
expr_stmt|;
if|if
condition|(
name|request
operator|.
name|hasCondition
argument_list|()
condition|)
block|{
name|Condition
name|condition
init|=
name|request
operator|.
name|getCondition
argument_list|()
decl_stmt|;
name|byte
index|[]
name|row
init|=
name|condition
operator|.
name|getRow
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|byte
index|[]
name|family
init|=
name|condition
operator|.
name|getFamily
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|byte
index|[]
name|qualifier
init|=
name|condition
operator|.
name|getQualifier
argument_list|()
operator|.
name|toByteArray
argument_list|()
decl_stmt|;
name|CompareOperator
name|op
init|=
name|CompareOperator
operator|.
name|valueOf
argument_list|(
name|condition
operator|.
name|getCompareType
argument_list|()
operator|.
name|name
argument_list|()
argument_list|)
decl_stmt|;
name|ByteArrayComparable
name|comparator
init|=
name|ProtobufUtil
operator|.
name|toComparator
argument_list|(
name|condition
operator|.
name|getComparator
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|processed
operator|=
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|preCheckAndDelete
argument_list|(
name|row
argument_list|,
name|family
argument_list|,
name|qualifier
argument_list|,
name|op
argument_list|,
name|comparator
argument_list|,
name|delete
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|processed
operator|==
literal|null
condition|)
block|{
name|boolean
name|result
init|=
name|region
operator|.
name|checkAndMutate
argument_list|(
name|row
argument_list|,
name|family
argument_list|,
name|qualifier
argument_list|,
name|op
argument_list|,
name|comparator
argument_list|,
name|delete
argument_list|,
literal|true
argument_list|)
decl_stmt|;
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|result
operator|=
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|postCheckAndDelete
argument_list|(
name|row
argument_list|,
name|family
argument_list|,
name|qualifier
argument_list|,
name|op
argument_list|,
name|comparator
argument_list|,
name|delete
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
name|processed
operator|=
name|result
expr_stmt|;
block|}
block|}
else|else
block|{
name|region
operator|.
name|delete
argument_list|(
name|delete
argument_list|)
expr_stmt|;
name|processed
operator|=
name|Boolean
operator|.
name|TRUE
expr_stmt|;
block|}
break|break;
default|default:
throw|throw
operator|new
name|DoNotRetryIOException
argument_list|(
literal|"Unsupported mutate type: "
operator|+
name|type
operator|.
name|name
argument_list|()
argument_list|)
throw|;
block|}
if|if
condition|(
name|processed
operator|!=
literal|null
condition|)
block|{
name|builder
operator|.
name|setProcessed
argument_list|(
name|processed
operator|.
name|booleanValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|boolean
name|clientCellBlockSupported
init|=
name|isClientCellBlockSupport
argument_list|(
name|context
argument_list|)
decl_stmt|;
name|addResult
argument_list|(
name|builder
argument_list|,
name|r
argument_list|,
name|controller
argument_list|,
name|clientCellBlockSupported
argument_list|)
expr_stmt|;
if|if
condition|(
name|clientCellBlockSupported
condition|)
block|{
name|addSize
argument_list|(
name|context
argument_list|,
name|r
argument_list|,
literal|null
argument_list|)
expr_stmt|;
block|}
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ie
parameter_list|)
block|{
name|regionServer
operator|.
name|checkFileSystem
argument_list|()
expr_stmt|;
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ie
argument_list|)
throw|;
block|}
finally|finally
block|{
if|if
condition|(
name|quota
operator|!=
literal|null
condition|)
block|{
name|quota
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
comment|// Update metrics
if|if
condition|(
name|regionServer
operator|.
name|metricsRegionServer
operator|!=
literal|null
operator|&&
name|type
operator|!=
literal|null
condition|)
block|{
name|long
name|after
init|=
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|DELETE
case|:
if|if
condition|(
name|request
operator|.
name|hasCondition
argument_list|()
condition|)
block|{
name|regionServer
operator|.
name|metricsRegionServer
operator|.
name|updateCheckAndDelete
argument_list|(
name|after
operator|-
name|before
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|regionServer
operator|.
name|metricsRegionServer
operator|.
name|updateDelete
argument_list|(
name|region
operator|==
literal|null
condition|?
literal|null
else|:
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getTable
argument_list|()
argument_list|,
name|after
operator|-
name|before
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PUT
case|:
if|if
condition|(
name|request
operator|.
name|hasCondition
argument_list|()
condition|)
block|{
name|regionServer
operator|.
name|metricsRegionServer
operator|.
name|updateCheckAndPut
argument_list|(
name|after
operator|-
name|before
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|regionServer
operator|.
name|metricsRegionServer
operator|.
name|updatePut
argument_list|(
name|region
operator|==
literal|null
condition|?
literal|null
else|:
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getTable
argument_list|()
argument_list|,
name|after
operator|-
name|before
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
block|}
block|}
block|}
comment|// This is used to keep compatible with the old client implementation. Consider remove it if we
comment|// decide to drop the support of the client that still sends close request to a region scanner
comment|// which has already been exhausted.
annotation|@
name|Deprecated
specifier|private
specifier|static
specifier|final
name|IOException
name|SCANNER_ALREADY_CLOSED
init|=
operator|new
name|IOException
argument_list|()
block|{
specifier|private
specifier|static
specifier|final
name|long
name|serialVersionUID
init|=
operator|-
literal|4305297078988180130L
decl_stmt|;
annotation|@
name|Override
specifier|public
specifier|synchronized
name|Throwable
name|fillInStackTrace
parameter_list|()
block|{
return|return
name|this
return|;
block|}
block|}
decl_stmt|;
specifier|private
name|RegionScannerHolder
name|getRegionScanner
parameter_list|(
name|ScanRequest
name|request
parameter_list|)
throws|throws
name|IOException
block|{
name|String
name|scannerName
init|=
name|Long
operator|.
name|toString
argument_list|(
name|request
operator|.
name|getScannerId
argument_list|()
argument_list|)
decl_stmt|;
name|RegionScannerHolder
name|rsh
init|=
name|scanners
operator|.
name|get
argument_list|(
name|scannerName
argument_list|)
decl_stmt|;
if|if
condition|(
name|rsh
operator|==
literal|null
condition|)
block|{
comment|// just ignore the next or close request if scanner does not exists.
if|if
condition|(
name|closedScanners
operator|.
name|getIfPresent
argument_list|(
name|scannerName
argument_list|)
operator|!=
literal|null
condition|)
block|{
throw|throw
name|SCANNER_ALREADY_CLOSED
throw|;
block|}
else|else
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Client tried to access missing scanner "
operator|+
name|scannerName
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|UnknownScannerException
argument_list|(
literal|"Unknown scanner '"
operator|+
name|scannerName
operator|+
literal|"'. This can happen due to any of the following "
operator|+
literal|"reasons: a) Scanner id given is wrong, b) Scanner lease expired because of "
operator|+
literal|"long wait between consecutive client checkins, c) Server may be closing down, "
operator|+
literal|"d) RegionServer restart during upgrade.\nIf the issue is due to reason (b), a "
operator|+
literal|"possible fix would be increasing the value of"
operator|+
literal|"'hbase.client.scanner.timeout.period' configuration."
argument_list|)
throw|;
block|}
block|}
name|RegionInfo
name|hri
init|=
name|rsh
operator|.
name|s
operator|.
name|getRegionInfo
argument_list|()
decl_stmt|;
comment|// Yes, should be the same instance
if|if
condition|(
name|regionServer
operator|.
name|getOnlineRegion
argument_list|(
name|hri
operator|.
name|getRegionName
argument_list|()
argument_list|)
operator|!=
name|rsh
operator|.
name|r
condition|)
block|{
name|String
name|msg
init|=
literal|"Region has changed on the scanner "
operator|+
name|scannerName
operator|+
literal|": regionName="
operator|+
name|hri
operator|.
name|getRegionNameAsString
argument_list|()
operator|+
literal|", scannerRegionName="
operator|+
name|rsh
operator|.
name|r
decl_stmt|;
name|LOG
operator|.
name|warn
argument_list|(
name|msg
operator|+
literal|", closing..."
argument_list|)
expr_stmt|;
name|scanners
operator|.
name|remove
argument_list|(
name|scannerName
argument_list|)
expr_stmt|;
try|try
block|{
name|rsh
operator|.
name|s
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Getting exception closing "
operator|+
name|scannerName
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
try|try
block|{
name|regionServer
operator|.
name|leases
operator|.
name|cancelLease
argument_list|(
name|scannerName
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|LeaseException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Getting exception closing "
operator|+
name|scannerName
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
throw|throw
operator|new
name|NotServingRegionException
argument_list|(
name|msg
argument_list|)
throw|;
block|}
return|return
name|rsh
return|;
block|}
specifier|private
name|RegionScannerHolder
name|newRegionScanner
parameter_list|(
name|ScanRequest
name|request
parameter_list|,
name|ScanResponse
operator|.
name|Builder
name|builder
parameter_list|)
throws|throws
name|IOException
block|{
name|HRegion
name|region
init|=
name|getRegion
argument_list|(
name|request
operator|.
name|getRegion
argument_list|()
argument_list|)
decl_stmt|;
name|ClientProtos
operator|.
name|Scan
name|protoScan
init|=
name|request
operator|.
name|getScan
argument_list|()
decl_stmt|;
name|boolean
name|isLoadingCfsOnDemandSet
init|=
name|protoScan
operator|.
name|hasLoadColumnFamiliesOnDemand
argument_list|()
decl_stmt|;
name|Scan
name|scan
init|=
name|ProtobufUtil
operator|.
name|toScan
argument_list|(
name|protoScan
argument_list|)
decl_stmt|;
comment|// if the request doesn't set this, get the default region setting.
if|if
condition|(
operator|!
name|isLoadingCfsOnDemandSet
condition|)
block|{
name|scan
operator|.
name|setLoadColumnFamiliesOnDemand
argument_list|(
name|region
operator|.
name|isLoadingCfsOnDemandDefault
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|scan
operator|.
name|hasFamilies
argument_list|()
condition|)
block|{
comment|// Adding all families to scanner
for|for
control|(
name|byte
index|[]
name|family
range|:
name|region
operator|.
name|getTableDescriptor
argument_list|()
operator|.
name|getColumnFamilyNames
argument_list|()
control|)
block|{
name|scan
operator|.
name|addFamily
argument_list|(
name|family
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
comment|// preScannerOpen is not allowed to return a RegionScanner. Only post hook can create a
comment|// wrapper for the core created RegionScanner
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|preScannerOpen
argument_list|(
name|scan
argument_list|)
expr_stmt|;
block|}
name|RegionScannerImpl
name|coreScanner
init|=
name|region
operator|.
name|getScanner
argument_list|(
name|scan
argument_list|)
decl_stmt|;
name|Shipper
name|shipper
init|=
name|coreScanner
decl_stmt|;
name|RegionScanner
name|scanner
init|=
name|coreScanner
decl_stmt|;
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|scanner
operator|=
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|postScannerOpen
argument_list|(
name|scan
argument_list|,
name|scanner
argument_list|)
expr_stmt|;
block|}
name|long
name|scannerId
init|=
name|scannerIdGenerator
operator|.
name|generateNewScannerId
argument_list|()
decl_stmt|;
name|builder
operator|.
name|setScannerId
argument_list|(
name|scannerId
argument_list|)
expr_stmt|;
name|builder
operator|.
name|setMvccReadPoint
argument_list|(
name|scanner
operator|.
name|getMvccReadPoint
argument_list|()
argument_list|)
expr_stmt|;
name|builder
operator|.
name|setTtl
argument_list|(
name|scannerLeaseTimeoutPeriod
argument_list|)
expr_stmt|;
name|String
name|scannerName
init|=
name|String
operator|.
name|valueOf
argument_list|(
name|scannerId
argument_list|)
decl_stmt|;
return|return
name|addScanner
argument_list|(
name|scannerName
argument_list|,
name|scanner
argument_list|,
name|shipper
argument_list|,
name|region
argument_list|,
name|scan
operator|.
name|isNeedCursorResult
argument_list|()
argument_list|)
return|;
block|}
specifier|private
name|void
name|checkScanNextCallSeq
parameter_list|(
name|ScanRequest
name|request
parameter_list|,
name|RegionScannerHolder
name|rsh
parameter_list|)
throws|throws
name|OutOfOrderScannerNextException
block|{
comment|// if nextCallSeq does not match throw Exception straight away. This needs to be
comment|// performed even before checking of Lease.
comment|// See HBASE-5974
if|if
condition|(
name|request
operator|.
name|hasNextCallSeq
argument_list|()
condition|)
block|{
name|long
name|callSeq
init|=
name|request
operator|.
name|getNextCallSeq
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|rsh
operator|.
name|incNextCallSeq
argument_list|(
name|callSeq
argument_list|)
condition|)
block|{
throw|throw
operator|new
name|OutOfOrderScannerNextException
argument_list|(
literal|"Expected nextCallSeq: "
operator|+
name|rsh
operator|.
name|getNextCallSeq
argument_list|()
operator|+
literal|" But the nextCallSeq got from client: "
operator|+
name|request
operator|.
name|getNextCallSeq
argument_list|()
operator|+
literal|"; request="
operator|+
name|TextFormat
operator|.
name|shortDebugString
argument_list|(
name|request
argument_list|)
argument_list|)
throw|;
block|}
block|}
block|}
specifier|private
name|void
name|addScannerLeaseBack
parameter_list|(
name|Leases
operator|.
name|Lease
name|lease
parameter_list|)
block|{
try|try
block|{
name|regionServer
operator|.
name|leases
operator|.
name|addLease
argument_list|(
name|lease
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|LeaseStillHeldException
name|e
parameter_list|)
block|{
comment|// should not happen as the scanner id is unique.
throw|throw
operator|new
name|AssertionError
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
specifier|private
name|long
name|getTimeLimit
parameter_list|(
name|HBaseRpcController
name|controller
parameter_list|,
name|boolean
name|allowHeartbeatMessages
parameter_list|)
block|{
comment|// Set the time limit to be half of the more restrictive timeout value (one of the
comment|// timeout values must be positive). In the event that both values are positive, the
comment|// more restrictive of the two is used to calculate the limit.
if|if
condition|(
name|allowHeartbeatMessages
operator|&&
operator|(
name|scannerLeaseTimeoutPeriod
operator|>
literal|0
operator|||
name|rpcTimeout
operator|>
literal|0
operator|)
condition|)
block|{
name|long
name|timeLimitDelta
decl_stmt|;
if|if
condition|(
name|scannerLeaseTimeoutPeriod
operator|>
literal|0
operator|&&
name|rpcTimeout
operator|>
literal|0
condition|)
block|{
name|timeLimitDelta
operator|=
name|Math
operator|.
name|min
argument_list|(
name|scannerLeaseTimeoutPeriod
argument_list|,
name|rpcTimeout
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|timeLimitDelta
operator|=
name|scannerLeaseTimeoutPeriod
operator|>
literal|0
condition|?
name|scannerLeaseTimeoutPeriod
else|:
name|rpcTimeout
expr_stmt|;
block|}
if|if
condition|(
name|controller
operator|!=
literal|null
operator|&&
name|controller
operator|.
name|getCallTimeout
argument_list|()
operator|>
literal|0
condition|)
block|{
name|timeLimitDelta
operator|=
name|Math
operator|.
name|min
argument_list|(
name|timeLimitDelta
argument_list|,
name|controller
operator|.
name|getCallTimeout
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// Use half of whichever timeout value was more restrictive... But don't allow
comment|// the time limit to be less than the allowable minimum (could cause an
comment|// immediatate timeout before scanning any data).
name|timeLimitDelta
operator|=
name|Math
operator|.
name|max
argument_list|(
name|timeLimitDelta
operator|/
literal|2
argument_list|,
name|minimumScanTimeLimitDelta
argument_list|)
expr_stmt|;
comment|// XXX: Can not use EnvironmentEdge here because TestIncrementTimeRange use a
comment|// ManualEnvironmentEdge. Consider using System.nanoTime instead.
return|return
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|+
name|timeLimitDelta
return|;
block|}
comment|// Default value of timeLimit is negative to indicate no timeLimit should be
comment|// enforced.
return|return
operator|-
literal|1L
return|;
block|}
specifier|private
name|void
name|checkLimitOfRows
parameter_list|(
name|int
name|numOfCompleteRows
parameter_list|,
name|int
name|limitOfRows
parameter_list|,
name|boolean
name|moreRows
parameter_list|,
name|ScannerContext
name|scannerContext
parameter_list|,
name|ScanResponse
operator|.
name|Builder
name|builder
parameter_list|)
block|{
if|if
condition|(
name|numOfCompleteRows
operator|>=
name|limitOfRows
condition|)
block|{
if|if
condition|(
name|LOG
operator|.
name|isTraceEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|trace
argument_list|(
literal|"Done scanning, limit of rows reached, moreRows: "
operator|+
name|moreRows
operator|+
literal|" scannerContext: "
operator|+
name|scannerContext
argument_list|)
expr_stmt|;
block|}
name|builder
operator|.
name|setMoreResults
argument_list|(
literal|false
argument_list|)
expr_stmt|;
block|}
block|}
comment|// return whether we have more results in region.
specifier|private
name|void
name|scan
parameter_list|(
name|HBaseRpcController
name|controller
parameter_list|,
name|ScanRequest
name|request
parameter_list|,
name|RegionScannerHolder
name|rsh
parameter_list|,
name|long
name|maxQuotaResultSize
parameter_list|,
name|int
name|maxResults
parameter_list|,
name|int
name|limitOfRows
parameter_list|,
name|List
argument_list|<
name|Result
argument_list|>
name|results
parameter_list|,
name|ScanResponse
operator|.
name|Builder
name|builder
parameter_list|,
name|MutableObject
name|lastBlock
parameter_list|,
name|RpcCallContext
name|context
parameter_list|)
throws|throws
name|IOException
block|{
name|HRegion
name|region
init|=
name|rsh
operator|.
name|r
decl_stmt|;
name|RegionScanner
name|scanner
init|=
name|rsh
operator|.
name|s
decl_stmt|;
name|long
name|maxResultSize
decl_stmt|;
if|if
condition|(
name|scanner
operator|.
name|getMaxResultSize
argument_list|()
operator|>
literal|0
condition|)
block|{
name|maxResultSize
operator|=
name|Math
operator|.
name|min
argument_list|(
name|scanner
operator|.
name|getMaxResultSize
argument_list|()
argument_list|,
name|maxQuotaResultSize
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|maxResultSize
operator|=
name|maxQuotaResultSize
expr_stmt|;
block|}
comment|// This is cells inside a row. Default size is 10 so if many versions or many cfs,
comment|// then we'll resize. Resizings show in profiler. Set it higher than 10. For now
comment|// arbitrary 32. TODO: keep record of general size of results being returned.
name|List
argument_list|<
name|Cell
argument_list|>
name|values
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
literal|32
argument_list|)
decl_stmt|;
name|region
operator|.
name|startRegionOperation
argument_list|(
name|Operation
operator|.
name|SCAN
argument_list|)
expr_stmt|;
try|try
block|{
name|int
name|numOfResults
init|=
literal|0
decl_stmt|;
name|int
name|numOfCompleteRows
init|=
literal|0
decl_stmt|;
name|long
name|before
init|=
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
decl_stmt|;
synchronized|synchronized
init|(
name|scanner
init|)
block|{
name|boolean
name|stale
init|=
operator|(
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getReplicaId
argument_list|()
operator|!=
literal|0
operator|)
decl_stmt|;
name|boolean
name|clientHandlesPartials
init|=
name|request
operator|.
name|hasClientHandlesPartials
argument_list|()
operator|&&
name|request
operator|.
name|getClientHandlesPartials
argument_list|()
decl_stmt|;
name|boolean
name|clientHandlesHeartbeats
init|=
name|request
operator|.
name|hasClientHandlesHeartbeats
argument_list|()
operator|&&
name|request
operator|.
name|getClientHandlesHeartbeats
argument_list|()
decl_stmt|;
comment|// On the server side we must ensure that the correct ordering of partial results is
comment|// returned to the client to allow them to properly reconstruct the partial results.
comment|// If the coprocessor host is adding to the result list, we cannot guarantee the
comment|// correct ordering of partial results and so we prevent partial results from being
comment|// formed.
name|boolean
name|serverGuaranteesOrderOfPartials
init|=
name|results
operator|.
name|isEmpty
argument_list|()
decl_stmt|;
name|boolean
name|allowPartialResults
init|=
name|clientHandlesPartials
operator|&&
name|serverGuaranteesOrderOfPartials
decl_stmt|;
name|boolean
name|moreRows
init|=
literal|false
decl_stmt|;
comment|// Heartbeat messages occur when the processing of the ScanRequest is exceeds a
comment|// certain time threshold on the server. When the time threshold is exceeded, the
comment|// server stops the scan and sends back whatever Results it has accumulated within
comment|// that time period (may be empty). Since heartbeat messages have the potential to
comment|// create partial Results (in the event that the timeout occurs in the middle of a
comment|// row), we must only generate heartbeat messages when the client can handle both
comment|// heartbeats AND partials
name|boolean
name|allowHeartbeatMessages
init|=
name|clientHandlesHeartbeats
operator|&&
name|allowPartialResults
decl_stmt|;
name|long
name|timeLimit
init|=
name|getTimeLimit
argument_list|(
name|controller
argument_list|,
name|allowHeartbeatMessages
argument_list|)
decl_stmt|;
specifier|final
name|LimitScope
name|sizeScope
init|=
name|allowPartialResults
condition|?
name|LimitScope
operator|.
name|BETWEEN_CELLS
else|:
name|LimitScope
operator|.
name|BETWEEN_ROWS
decl_stmt|;
specifier|final
name|LimitScope
name|timeScope
init|=
name|allowHeartbeatMessages
condition|?
name|LimitScope
operator|.
name|BETWEEN_CELLS
else|:
name|LimitScope
operator|.
name|BETWEEN_ROWS
decl_stmt|;
name|boolean
name|trackMetrics
init|=
name|request
operator|.
name|hasTrackScanMetrics
argument_list|()
operator|&&
name|request
operator|.
name|getTrackScanMetrics
argument_list|()
decl_stmt|;
comment|// Configure with limits for this RPC. Set keep progress true since size progress
comment|// towards size limit should be kept between calls to nextRaw
name|ScannerContext
operator|.
name|Builder
name|contextBuilder
init|=
name|ScannerContext
operator|.
name|newBuilder
argument_list|(
literal|true
argument_list|)
decl_stmt|;
comment|// maxResultSize - either we can reach this much size for all cells(being read) data or sum
comment|// of heap size occupied by cells(being read). Cell data means its key and value parts.
name|contextBuilder
operator|.
name|setSizeLimit
argument_list|(
name|sizeScope
argument_list|,
name|maxResultSize
argument_list|,
name|maxResultSize
argument_list|)
expr_stmt|;
name|contextBuilder
operator|.
name|setBatchLimit
argument_list|(
name|scanner
operator|.
name|getBatch
argument_list|()
argument_list|)
expr_stmt|;
name|contextBuilder
operator|.
name|setTimeLimit
argument_list|(
name|timeScope
argument_list|,
name|timeLimit
argument_list|)
expr_stmt|;
name|contextBuilder
operator|.
name|setTrackMetrics
argument_list|(
name|trackMetrics
argument_list|)
expr_stmt|;
name|ScannerContext
name|scannerContext
init|=
name|contextBuilder
operator|.
name|build
argument_list|()
decl_stmt|;
name|boolean
name|limitReached
init|=
literal|false
decl_stmt|;
while|while
condition|(
name|numOfResults
operator|<
name|maxResults
condition|)
block|{
comment|// Reset the batch progress to 0 before every call to RegionScanner#nextRaw. The
comment|// batch limit is a limit on the number of cells per Result. Thus, if progress is
comment|// being tracked (i.e. scannerContext.keepProgress() is true) then we need to
comment|// reset the batch progress between nextRaw invocations since we don't want the
comment|// batch progress from previous calls to affect future calls
name|scannerContext
operator|.
name|setBatchProgress
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|// Collect values to be returned here
name|moreRows
operator|=
name|scanner
operator|.
name|nextRaw
argument_list|(
name|values
argument_list|,
name|scannerContext
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|values
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
if|if
condition|(
name|limitOfRows
operator|>
literal|0
condition|)
block|{
comment|// First we need to check if the last result is partial and we have a row change. If
comment|// so then we need to increase the numOfCompleteRows.
if|if
condition|(
name|results
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
if|if
condition|(
name|rsh
operator|.
name|rowOfLastPartialResult
operator|!=
literal|null
operator|&&
operator|!
name|CellUtil
operator|.
name|matchingRows
argument_list|(
name|values
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|,
name|rsh
operator|.
name|rowOfLastPartialResult
argument_list|)
condition|)
block|{
name|numOfCompleteRows
operator|++
expr_stmt|;
name|checkLimitOfRows
argument_list|(
name|numOfCompleteRows
argument_list|,
name|limitOfRows
argument_list|,
name|moreRows
argument_list|,
name|scannerContext
argument_list|,
name|builder
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|Result
name|lastResult
init|=
name|results
operator|.
name|get
argument_list|(
name|results
operator|.
name|size
argument_list|()
operator|-
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|lastResult
operator|.
name|mayHaveMoreCellsInRow
argument_list|()
operator|&&
operator|!
name|CellUtil
operator|.
name|matchingRows
argument_list|(
name|values
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|,
name|lastResult
operator|.
name|getRow
argument_list|()
argument_list|)
condition|)
block|{
name|numOfCompleteRows
operator|++
expr_stmt|;
name|checkLimitOfRows
argument_list|(
name|numOfCompleteRows
argument_list|,
name|limitOfRows
argument_list|,
name|moreRows
argument_list|,
name|scannerContext
argument_list|,
name|builder
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|builder
operator|.
name|hasMoreResults
argument_list|()
operator|&&
operator|!
name|builder
operator|.
name|getMoreResults
argument_list|()
condition|)
block|{
break|break;
block|}
block|}
name|boolean
name|mayHaveMoreCellsInRow
init|=
name|scannerContext
operator|.
name|mayHaveMoreCellsInRow
argument_list|()
decl_stmt|;
name|Result
name|r
init|=
name|Result
operator|.
name|create
argument_list|(
name|values
argument_list|,
literal|null
argument_list|,
name|stale
argument_list|,
name|mayHaveMoreCellsInRow
argument_list|)
decl_stmt|;
name|lastBlock
operator|.
name|setValue
argument_list|(
name|addSize
argument_list|(
name|context
argument_list|,
name|r
argument_list|,
name|lastBlock
operator|.
name|getValue
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|results
operator|.
name|add
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|numOfResults
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|mayHaveMoreCellsInRow
operator|&&
name|limitOfRows
operator|>
literal|0
condition|)
block|{
name|numOfCompleteRows
operator|++
expr_stmt|;
name|checkLimitOfRows
argument_list|(
name|numOfCompleteRows
argument_list|,
name|limitOfRows
argument_list|,
name|moreRows
argument_list|,
name|scannerContext
argument_list|,
name|builder
argument_list|)
expr_stmt|;
if|if
condition|(
name|builder
operator|.
name|hasMoreResults
argument_list|()
operator|&&
operator|!
name|builder
operator|.
name|getMoreResults
argument_list|()
condition|)
block|{
break|break;
block|}
block|}
block|}
name|boolean
name|sizeLimitReached
init|=
name|scannerContext
operator|.
name|checkSizeLimit
argument_list|(
name|LimitScope
operator|.
name|BETWEEN_ROWS
argument_list|)
decl_stmt|;
name|boolean
name|timeLimitReached
init|=
name|scannerContext
operator|.
name|checkTimeLimit
argument_list|(
name|LimitScope
operator|.
name|BETWEEN_ROWS
argument_list|)
decl_stmt|;
name|boolean
name|resultsLimitReached
init|=
name|numOfResults
operator|>=
name|maxResults
decl_stmt|;
name|limitReached
operator|=
name|sizeLimitReached
operator|||
name|timeLimitReached
operator|||
name|resultsLimitReached
expr_stmt|;
if|if
condition|(
name|limitReached
operator|||
operator|!
name|moreRows
condition|)
block|{
if|if
condition|(
name|LOG
operator|.
name|isTraceEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|trace
argument_list|(
literal|"Done scanning. limitReached: "
operator|+
name|limitReached
operator|+
literal|" moreRows: "
operator|+
name|moreRows
operator|+
literal|" scannerContext: "
operator|+
name|scannerContext
argument_list|)
expr_stmt|;
block|}
comment|// We only want to mark a ScanResponse as a heartbeat message in the event that
comment|// there are more values to be read server side. If there aren't more values,
comment|// marking it as a heartbeat is wasteful because the client will need to issue
comment|// another ScanRequest only to realize that they already have all the values
if|if
condition|(
name|moreRows
condition|)
block|{
comment|// Heartbeat messages occur when the time limit has been reached.
name|builder
operator|.
name|setHeartbeatMessage
argument_list|(
name|timeLimitReached
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeLimitReached
operator|&&
name|rsh
operator|.
name|needCursor
condition|)
block|{
name|Cell
name|cursorCell
init|=
name|scannerContext
operator|.
name|getLastPeekedCell
argument_list|()
decl_stmt|;
if|if
condition|(
name|cursorCell
operator|!=
literal|null
condition|)
block|{
name|builder
operator|.
name|setCursor
argument_list|(
name|ProtobufUtil
operator|.
name|toCursor
argument_list|(
name|cursorCell
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
break|break;
block|}
name|values
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
name|builder
operator|.
name|setMoreResultsInRegion
argument_list|(
name|moreRows
argument_list|)
expr_stmt|;
comment|// Check to see if the client requested that we track metrics server side. If the
comment|// client requested metrics, retrieve the metrics from the scanner context.
if|if
condition|(
name|trackMetrics
condition|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
name|metrics
init|=
name|scannerContext
operator|.
name|getMetrics
argument_list|()
operator|.
name|getMetricsMap
argument_list|()
decl_stmt|;
name|ScanMetrics
operator|.
name|Builder
name|metricBuilder
init|=
name|ScanMetrics
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|NameInt64Pair
operator|.
name|Builder
name|pairBuilder
init|=
name|NameInt64Pair
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
for|for
control|(
name|Entry
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
name|entry
range|:
name|metrics
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|pairBuilder
operator|.
name|setName
argument_list|(
name|entry
operator|.
name|getKey
argument_list|()
argument_list|)
expr_stmt|;
name|pairBuilder
operator|.
name|setValue
argument_list|(
name|entry
operator|.
name|getValue
argument_list|()
argument_list|)
expr_stmt|;
name|metricBuilder
operator|.
name|addMetrics
argument_list|(
name|pairBuilder
operator|.
name|build
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|builder
operator|.
name|setScanMetrics
argument_list|(
name|metricBuilder
operator|.
name|build
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
name|long
name|end
init|=
name|EnvironmentEdgeManager
operator|.
name|currentTime
argument_list|()
decl_stmt|;
name|long
name|responseCellSize
init|=
name|context
operator|!=
literal|null
condition|?
name|context
operator|.
name|getResponseCellSize
argument_list|()
else|:
literal|0
decl_stmt|;
name|region
operator|.
name|getMetrics
argument_list|()
operator|.
name|updateScanTime
argument_list|(
name|end
operator|-
name|before
argument_list|)
expr_stmt|;
if|if
condition|(
name|regionServer
operator|.
name|metricsRegionServer
operator|!=
literal|null
condition|)
block|{
name|regionServer
operator|.
name|metricsRegionServer
operator|.
name|updateScanSize
argument_list|(
name|region
operator|.
name|getTableDescriptor
argument_list|()
operator|.
name|getTableName
argument_list|()
argument_list|,
name|responseCellSize
argument_list|)
expr_stmt|;
name|regionServer
operator|.
name|metricsRegionServer
operator|.
name|updateScanTime
argument_list|(
name|region
operator|.
name|getTableDescriptor
argument_list|()
operator|.
name|getTableName
argument_list|()
argument_list|,
name|end
operator|-
name|before
argument_list|)
expr_stmt|;
block|}
block|}
finally|finally
block|{
name|region
operator|.
name|closeRegionOperation
argument_list|()
expr_stmt|;
block|}
comment|// coprocessor postNext hook
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|postScannerNext
argument_list|(
name|scanner
argument_list|,
name|results
argument_list|,
name|maxResults
argument_list|,
literal|true
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Scan data in a table.    *    * @param controller the RPC controller    * @param request the scan request    * @throws ServiceException    */
annotation|@
name|Override
specifier|public
name|ScanResponse
name|scan
parameter_list|(
specifier|final
name|RpcController
name|controller
parameter_list|,
specifier|final
name|ScanRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
if|if
condition|(
name|controller
operator|!=
literal|null
operator|&&
operator|!
operator|(
name|controller
operator|instanceof
name|HBaseRpcController
operator|)
condition|)
block|{
throw|throw
operator|new
name|UnsupportedOperationException
argument_list|(
literal|"We only do "
operator|+
literal|"HBaseRpcControllers! FIX IF A PROBLEM: "
operator|+
name|controller
argument_list|)
throw|;
block|}
if|if
condition|(
operator|!
name|request
operator|.
name|hasScannerId
argument_list|()
operator|&&
operator|!
name|request
operator|.
name|hasScan
argument_list|()
condition|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
operator|new
name|DoNotRetryIOException
argument_list|(
literal|"Missing required input: scannerId or scan"
argument_list|)
argument_list|)
throw|;
block|}
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
if|if
condition|(
name|request
operator|.
name|hasScannerId
argument_list|()
condition|)
block|{
name|String
name|scannerName
init|=
name|Long
operator|.
name|toString
argument_list|(
name|request
operator|.
name|getScannerId
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Server shutting down and client tried to access missing scanner "
operator|+
name|scannerName
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|regionServer
operator|.
name|leases
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|regionServer
operator|.
name|leases
operator|.
name|cancelLease
argument_list|(
name|scannerName
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|LeaseException
name|le
parameter_list|)
block|{
comment|// No problem, ignore
if|if
condition|(
name|LOG
operator|.
name|isTraceEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|trace
argument_list|(
literal|"Un-able to cancel lease of scanner. It could already be closed."
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
throw|throw
operator|new
name|ServiceException
argument_list|(
name|e
argument_list|)
throw|;
block|}
name|requestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|rpcScanRequestCount
operator|.
name|increment
argument_list|()
expr_stmt|;
name|RegionScannerHolder
name|rsh
decl_stmt|;
name|ScanResponse
operator|.
name|Builder
name|builder
init|=
name|ScanResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
try|try
block|{
if|if
condition|(
name|request
operator|.
name|hasScannerId
argument_list|()
condition|)
block|{
comment|// The downstream projects such as AsyncHBase in OpenTSDB need this value. See HBASE-18000
comment|// for more details.
name|builder
operator|.
name|setScannerId
argument_list|(
name|request
operator|.
name|getScannerId
argument_list|()
argument_list|)
expr_stmt|;
name|rsh
operator|=
name|getRegionScanner
argument_list|(
name|request
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rsh
operator|=
name|newRegionScanner
argument_list|(
name|request
argument_list|,
name|builder
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
if|if
condition|(
name|e
operator|==
name|SCANNER_ALREADY_CLOSED
condition|)
block|{
comment|// Now we will close scanner automatically if there are no more results for this region but
comment|// the old client will still send a close request to us. Just ignore it and return.
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
throw|throw
operator|new
name|ServiceException
argument_list|(
name|e
argument_list|)
throw|;
block|}
name|HRegion
name|region
init|=
name|rsh
operator|.
name|r
decl_stmt|;
name|String
name|scannerName
init|=
name|rsh
operator|.
name|scannerName
decl_stmt|;
name|Leases
operator|.
name|Lease
name|lease
decl_stmt|;
try|try
block|{
comment|// Remove lease while its being processed in server; protects against case
comment|// where processing of request takes> lease expiration time.
name|lease
operator|=
name|regionServer
operator|.
name|leases
operator|.
name|removeLease
argument_list|(
name|scannerName
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|LeaseException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|e
argument_list|)
throw|;
block|}
if|if
condition|(
name|request
operator|.
name|hasRenew
argument_list|()
operator|&&
name|request
operator|.
name|getRenew
argument_list|()
condition|)
block|{
comment|// add back and return
name|addScannerLeaseBack
argument_list|(
name|lease
argument_list|)
expr_stmt|;
try|try
block|{
name|checkScanNextCallSeq
argument_list|(
name|request
argument_list|,
name|rsh
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|OutOfOrderScannerNextException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|e
argument_list|)
throw|;
block|}
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
name|OperationQuota
name|quota
decl_stmt|;
try|try
block|{
name|quota
operator|=
name|getRpcQuotaManager
argument_list|()
operator|.
name|checkQuota
argument_list|(
name|region
argument_list|,
name|OperationQuota
operator|.
name|OperationType
operator|.
name|SCAN
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
name|addScannerLeaseBack
argument_list|(
name|lease
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|ServiceException
argument_list|(
name|e
argument_list|)
throw|;
block|}
try|try
block|{
name|checkScanNextCallSeq
argument_list|(
name|request
argument_list|,
name|rsh
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|OutOfOrderScannerNextException
name|e
parameter_list|)
block|{
name|addScannerLeaseBack
argument_list|(
name|lease
argument_list|)
expr_stmt|;
throw|throw
operator|new
name|ServiceException
argument_list|(
name|e
argument_list|)
throw|;
block|}
comment|// Now we have increased the next call sequence. If we give client an error, the retry will
comment|// never success. So we'd better close the scanner and return a DoNotRetryIOException to client
comment|// and then client will try to open a new scanner.
name|boolean
name|closeScanner
init|=
name|request
operator|.
name|hasCloseScanner
argument_list|()
condition|?
name|request
operator|.
name|getCloseScanner
argument_list|()
else|:
literal|false
decl_stmt|;
name|int
name|rows
decl_stmt|;
comment|// this is scan.getCaching
if|if
condition|(
name|request
operator|.
name|hasNumberOfRows
argument_list|()
condition|)
block|{
name|rows
operator|=
name|request
operator|.
name|getNumberOfRows
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|rows
operator|=
name|closeScanner
condition|?
literal|0
else|:
literal|1
expr_stmt|;
block|}
name|RpcCallContext
name|context
init|=
name|RpcServer
operator|.
name|getCurrentCall
argument_list|()
operator|.
name|orElse
argument_list|(
literal|null
argument_list|)
decl_stmt|;
comment|// now let's do the real scan.
name|long
name|maxQuotaResultSize
init|=
name|Math
operator|.
name|min
argument_list|(
name|maxScannerResultSize
argument_list|,
name|quota
operator|.
name|getReadAvailable
argument_list|()
argument_list|)
decl_stmt|;
name|RegionScanner
name|scanner
init|=
name|rsh
operator|.
name|s
decl_stmt|;
comment|// this is the limit of rows for this scan, if we the number of rows reach this value, we will
comment|// close the scanner.
name|int
name|limitOfRows
decl_stmt|;
if|if
condition|(
name|request
operator|.
name|hasLimitOfRows
argument_list|()
condition|)
block|{
name|limitOfRows
operator|=
name|request
operator|.
name|getLimitOfRows
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|limitOfRows
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|MutableObject
argument_list|<
name|Object
argument_list|>
name|lastBlock
init|=
operator|new
name|MutableObject
argument_list|<>
argument_list|()
decl_stmt|;
name|boolean
name|scannerClosed
init|=
literal|false
decl_stmt|;
try|try
block|{
name|List
argument_list|<
name|Result
argument_list|>
name|results
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
if|if
condition|(
name|rows
operator|>
literal|0
condition|)
block|{
name|boolean
name|done
init|=
literal|false
decl_stmt|;
comment|// Call coprocessor. Get region info from scanner.
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|Boolean
name|bypass
init|=
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|preScannerNext
argument_list|(
name|scanner
argument_list|,
name|results
argument_list|,
name|rows
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|results
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
for|for
control|(
name|Result
name|r
range|:
name|results
control|)
block|{
name|lastBlock
operator|.
name|setValue
argument_list|(
name|addSize
argument_list|(
name|context
argument_list|,
name|r
argument_list|,
name|lastBlock
operator|.
name|getValue
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|bypass
operator|!=
literal|null
operator|&&
name|bypass
operator|.
name|booleanValue
argument_list|()
condition|)
block|{
name|done
operator|=
literal|true
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|done
condition|)
block|{
name|scan
argument_list|(
operator|(
name|HBaseRpcController
operator|)
name|controller
argument_list|,
name|request
argument_list|,
name|rsh
argument_list|,
name|maxQuotaResultSize
argument_list|,
name|rows
argument_list|,
name|limitOfRows
argument_list|,
name|results
argument_list|,
name|builder
argument_list|,
name|lastBlock
argument_list|,
name|context
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|builder
operator|.
name|setMoreResultsInRegion
argument_list|(
operator|!
name|results
operator|.
name|isEmpty
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|// This is a open scanner call with numberOfRow = 0, so set more results in region to true.
name|builder
operator|.
name|setMoreResultsInRegion
argument_list|(
literal|true
argument_list|)
expr_stmt|;
block|}
name|quota
operator|.
name|addScanResult
argument_list|(
name|results
argument_list|)
expr_stmt|;
name|addResults
argument_list|(
name|builder
argument_list|,
name|results
argument_list|,
operator|(
name|HBaseRpcController
operator|)
name|controller
argument_list|,
name|RegionReplicaUtil
operator|.
name|isDefaultReplica
argument_list|(
name|region
operator|.
name|getRegionInfo
argument_list|()
argument_list|)
argument_list|,
name|isClientCellBlockSupport
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|scanner
operator|.
name|isFilterDone
argument_list|()
operator|&&
name|results
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
comment|// If the scanner's filter - if any - is done with the scan
comment|// only set moreResults to false if the results is empty. This is used to keep compatible
comment|// with the old scan implementation where we just ignore the returned results if moreResults
comment|// is false. Can remove the isEmpty check after we get rid of the old implementation.
name|builder
operator|.
name|setMoreResults
argument_list|(
literal|false
argument_list|)
expr_stmt|;
block|}
comment|// Later we may close the scanner depending on this flag so here we need to make sure that we
comment|// have already set this flag.
assert|assert
name|builder
operator|.
name|hasMoreResultsInRegion
argument_list|()
assert|;
comment|// we only set moreResults to false in the above code, so set it to true if we haven't set it
comment|// yet.
if|if
condition|(
operator|!
name|builder
operator|.
name|hasMoreResults
argument_list|()
condition|)
block|{
name|builder
operator|.
name|setMoreResults
argument_list|(
literal|true
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|builder
operator|.
name|getMoreResults
argument_list|()
operator|&&
name|builder
operator|.
name|getMoreResultsInRegion
argument_list|()
operator|&&
operator|!
name|results
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
comment|// Record the last cell of the last result if it is a partial result
comment|// We need this to calculate the complete rows we have returned to client as the
comment|// mayHaveMoreCellsInRow is true does not mean that there will be extra cells for the
comment|// current row. We may filter out all the remaining cells for the current row and just
comment|// return the cells of the nextRow when calling RegionScanner.nextRaw. So here we need to
comment|// check for row change.
name|Result
name|lastResult
init|=
name|results
operator|.
name|get
argument_list|(
name|results
operator|.
name|size
argument_list|()
operator|-
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|lastResult
operator|.
name|mayHaveMoreCellsInRow
argument_list|()
condition|)
block|{
name|rsh
operator|.
name|rowOfLastPartialResult
operator|=
name|lastResult
operator|.
name|getRow
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|rsh
operator|.
name|rowOfLastPartialResult
operator|=
literal|null
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|builder
operator|.
name|getMoreResults
argument_list|()
operator|||
operator|!
name|builder
operator|.
name|getMoreResultsInRegion
argument_list|()
operator|||
name|closeScanner
condition|)
block|{
name|scannerClosed
operator|=
literal|true
expr_stmt|;
name|closeScanner
argument_list|(
name|region
argument_list|,
name|scanner
argument_list|,
name|scannerName
argument_list|,
name|context
argument_list|)
expr_stmt|;
block|}
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
try|try
block|{
comment|// scanner is closed here
name|scannerClosed
operator|=
literal|true
expr_stmt|;
comment|// The scanner state might be left in a dirty state, so we will tell the Client to
comment|// fail this RPC and close the scanner while opening up another one from the start of
comment|// row that the client has last seen.
name|closeScanner
argument_list|(
name|region
argument_list|,
name|scanner
argument_list|,
name|scannerName
argument_list|,
name|context
argument_list|)
expr_stmt|;
comment|// If it is a DoNotRetryIOException already, throw as it is. Unfortunately, DNRIOE is
comment|// used in two different semantics.
comment|// (1) The first is to close the client scanner and bubble up the exception all the way
comment|// to the application. This is preferred when the exception is really un-recoverable
comment|// (like CorruptHFileException, etc). Plain DoNotRetryIOException also falls into this
comment|// bucket usually.
comment|// (2) Second semantics is to close the current region scanner only, but continue the
comment|// client scanner by overriding the exception. This is usually UnknownScannerException,
comment|// OutOfOrderScannerNextException, etc where the region scanner has to be closed, but the
comment|// application-level ClientScanner has to continue without bubbling up the exception to
comment|// the client. See ClientScanner code to see how it deals with these special exceptions.
if|if
condition|(
name|e
operator|instanceof
name|DoNotRetryIOException
condition|)
block|{
throw|throw
name|e
throw|;
block|}
comment|// If it is a FileNotFoundException, wrap as a
comment|// DoNotRetryIOException. This can avoid the retry in ClientScanner.
if|if
condition|(
name|e
operator|instanceof
name|FileNotFoundException
condition|)
block|{
throw|throw
operator|new
name|DoNotRetryIOException
argument_list|(
name|e
argument_list|)
throw|;
block|}
comment|// We closed the scanner already. Instead of throwing the IOException, and client
comment|// retrying with the same scannerId only to get USE on the next RPC, we directly throw
comment|// a special exception to save an RPC.
if|if
condition|(
name|VersionInfoUtil
operator|.
name|hasMinimumVersion
argument_list|(
name|context
operator|.
name|getClientVersionInfo
argument_list|()
argument_list|,
literal|1
argument_list|,
literal|4
argument_list|)
condition|)
block|{
comment|// 1.4.0+ clients know how to handle
throw|throw
operator|new
name|ScannerResetException
argument_list|(
literal|"Scanner is closed on the server-side"
argument_list|,
name|e
argument_list|)
throw|;
block|}
else|else
block|{
comment|// older clients do not know about SRE. Just throw USE, which they will handle
throw|throw
operator|new
name|UnknownScannerException
argument_list|(
literal|"Throwing UnknownScannerException to reset the client"
operator|+
literal|" scanner state for clients older than 1.3."
argument_list|,
name|e
argument_list|)
throw|;
block|}
block|}
catch|catch
parameter_list|(
name|IOException
name|ioe
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|ioe
argument_list|)
throw|;
block|}
block|}
finally|finally
block|{
if|if
condition|(
operator|!
name|scannerClosed
condition|)
block|{
comment|// Adding resets expiration time on lease.
comment|// the closeCallBack will be set in closeScanner so here we only care about shippedCallback
if|if
condition|(
name|context
operator|!=
literal|null
condition|)
block|{
name|context
operator|.
name|setCallBack
argument_list|(
name|rsh
operator|.
name|shippedCallback
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// When context != null, adding back the lease will be done in callback set above.
name|addScannerLeaseBack
argument_list|(
name|lease
argument_list|)
expr_stmt|;
block|}
block|}
name|quota
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
specifier|private
name|void
name|closeScanner
parameter_list|(
name|HRegion
name|region
parameter_list|,
name|RegionScanner
name|scanner
parameter_list|,
name|String
name|scannerName
parameter_list|,
name|RpcCallContext
name|context
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|preScannerClose
argument_list|(
name|scanner
argument_list|)
condition|)
block|{
comment|// bypass the actual close.
return|return;
block|}
block|}
name|RegionScannerHolder
name|rsh
init|=
name|scanners
operator|.
name|remove
argument_list|(
name|scannerName
argument_list|)
decl_stmt|;
if|if
condition|(
name|rsh
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|context
operator|!=
literal|null
condition|)
block|{
name|context
operator|.
name|setCallBack
argument_list|(
name|rsh
operator|.
name|closeCallBack
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rsh
operator|.
name|s
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|region
operator|.
name|getCoprocessorHost
argument_list|()
operator|.
name|postScannerClose
argument_list|(
name|scanner
argument_list|)
expr_stmt|;
block|}
name|closedScanners
operator|.
name|put
argument_list|(
name|scannerName
argument_list|,
name|scannerName
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|CoprocessorServiceResponse
name|execRegionServerService
parameter_list|(
name|RpcController
name|controller
parameter_list|,
name|CoprocessorServiceRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
name|rpcPreCheck
argument_list|(
literal|"execRegionServerService"
argument_list|)
expr_stmt|;
return|return
name|regionServer
operator|.
name|execRegionServerService
argument_list|(
name|controller
argument_list|,
name|request
argument_list|)
return|;
block|}
annotation|@
name|Override
specifier|public
name|UpdateConfigurationResponse
name|updateConfiguration
parameter_list|(
name|RpcController
name|controller
parameter_list|,
name|UpdateConfigurationRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
name|this
operator|.
name|regionServer
operator|.
name|updateConfiguration
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|e
argument_list|)
throw|;
block|}
return|return
name|UpdateConfigurationResponse
operator|.
name|getDefaultInstance
argument_list|()
return|;
block|}
annotation|@
name|Override
specifier|public
name|GetSpaceQuotaSnapshotsResponse
name|getSpaceQuotaSnapshots
parameter_list|(
name|RpcController
name|controller
parameter_list|,
name|GetSpaceQuotaSnapshotsRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
specifier|final
name|RegionServerSpaceQuotaManager
name|manager
init|=
name|regionServer
operator|.
name|getRegionServerSpaceQuotaManager
argument_list|()
decl_stmt|;
specifier|final
name|GetSpaceQuotaSnapshotsResponse
operator|.
name|Builder
name|builder
init|=
name|GetSpaceQuotaSnapshotsResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
if|if
condition|(
name|manager
operator|!=
literal|null
condition|)
block|{
specifier|final
name|Map
argument_list|<
name|TableName
argument_list|,
name|SpaceQuotaSnapshot
argument_list|>
name|snapshots
init|=
name|manager
operator|.
name|copyQuotaSnapshots
argument_list|()
decl_stmt|;
for|for
control|(
name|Entry
argument_list|<
name|TableName
argument_list|,
name|SpaceQuotaSnapshot
argument_list|>
name|snapshot
range|:
name|snapshots
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|builder
operator|.
name|addSnapshots
argument_list|(
name|TableQuotaSnapshot
operator|.
name|newBuilder
argument_list|()
operator|.
name|setTableName
argument_list|(
name|ProtobufUtil
operator|.
name|toProtoTableName
argument_list|(
name|snapshot
operator|.
name|getKey
argument_list|()
argument_list|)
argument_list|)
operator|.
name|setSnapshot
argument_list|(
name|SpaceQuotaSnapshot
operator|.
name|toProtoSnapshot
argument_list|(
name|snapshot
operator|.
name|getValue
argument_list|()
argument_list|)
argument_list|)
operator|.
name|build
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|builder
operator|.
name|build
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
annotation|@
name|Override
specifier|public
name|ClearRegionBlockCacheResponse
name|clearRegionBlockCache
parameter_list|(
name|RpcController
name|controller
parameter_list|,
name|ClearRegionBlockCacheRequest
name|request
parameter_list|)
block|{
name|ClearRegionBlockCacheResponse
operator|.
name|Builder
name|builder
init|=
name|ClearRegionBlockCacheResponse
operator|.
name|newBuilder
argument_list|()
decl_stmt|;
name|CacheEvictionStatsBuilder
name|stats
init|=
name|CacheEvictionStats
operator|.
name|builder
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|HRegion
argument_list|>
name|regions
init|=
name|getRegions
argument_list|(
name|request
operator|.
name|getRegionList
argument_list|()
argument_list|,
name|stats
argument_list|)
decl_stmt|;
for|for
control|(
name|HRegion
name|region
range|:
name|regions
control|)
block|{
try|try
block|{
name|stats
operator|=
name|stats
operator|.
name|append
argument_list|(
name|this
operator|.
name|regionServer
operator|.
name|clearRegionBlockCache
argument_list|(
name|region
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|stats
operator|.
name|addException
argument_list|(
name|region
operator|.
name|getRegionInfo
argument_list|()
operator|.
name|getRegionName
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
block|}
name|stats
operator|.
name|withMaxCacheSize
argument_list|(
name|regionServer
operator|.
name|getCacheConfig
argument_list|()
operator|.
name|getBlockCache
argument_list|()
operator|.
name|getMaxSize
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|builder
operator|.
name|setStats
argument_list|(
name|ProtobufUtil
operator|.
name|toCacheEvictionStats
argument_list|(
name|stats
operator|.
name|build
argument_list|()
argument_list|)
argument_list|)
operator|.
name|build
argument_list|()
return|;
block|}
annotation|@
name|Override
annotation|@
name|QosPriority
argument_list|(
name|priority
operator|=
name|HConstants
operator|.
name|ADMIN_QOS
argument_list|)
specifier|public
name|ExecuteProceduresResponse
name|executeProcedures
parameter_list|(
name|RpcController
name|controller
parameter_list|,
name|ExecuteProceduresRequest
name|request
parameter_list|)
throws|throws
name|ServiceException
block|{
try|try
block|{
name|checkOpen
argument_list|()
expr_stmt|;
name|regionServer
operator|.
name|getRegionServerCoprocessorHost
argument_list|()
operator|.
name|preExecuteProcedures
argument_list|()
expr_stmt|;
if|if
condition|(
name|request
operator|.
name|getOpenRegionCount
argument_list|()
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|OpenRegionRequest
name|req
range|:
name|request
operator|.
name|getOpenRegionList
argument_list|()
control|)
block|{
name|openRegion
argument_list|(
name|controller
argument_list|,
name|req
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|request
operator|.
name|getCloseRegionCount
argument_list|()
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|CloseRegionRequest
name|req
range|:
name|request
operator|.
name|getCloseRegionList
argument_list|()
control|)
block|{
name|closeRegion
argument_list|(
name|controller
argument_list|,
name|req
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|request
operator|.
name|getProcCount
argument_list|()
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|RemoteProcedureRequest
name|req
range|:
name|request
operator|.
name|getProcList
argument_list|()
control|)
block|{
name|RSProcedureCallable
name|callable
decl_stmt|;
try|try
block|{
name|callable
operator|=
name|Class
operator|.
name|forName
argument_list|(
name|req
operator|.
name|getProcClass
argument_list|()
argument_list|)
operator|.
name|asSubclass
argument_list|(
name|RSProcedureCallable
operator|.
name|class
argument_list|)
operator|.
name|getDeclaredConstructor
argument_list|()
operator|.
name|newInstance
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|regionServer
operator|.
name|remoteProcedureComplete
argument_list|(
name|req
operator|.
name|getProcId
argument_list|()
argument_list|,
name|e
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|callable
operator|.
name|init
argument_list|(
name|req
operator|.
name|getProcData
argument_list|()
operator|.
name|toByteArray
argument_list|()
argument_list|,
name|regionServer
argument_list|)
expr_stmt|;
name|regionServer
operator|.
name|executeProcedure
argument_list|(
name|req
operator|.
name|getProcId
argument_list|()
argument_list|,
name|callable
argument_list|)
expr_stmt|;
block|}
block|}
name|regionServer
operator|.
name|getRegionServerCoprocessorHost
argument_list|()
operator|.
name|postExecuteProcedures
argument_list|()
expr_stmt|;
return|return
name|ExecuteProceduresResponse
operator|.
name|getDefaultInstance
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
throw|throw
operator|new
name|ServiceException
argument_list|(
name|e
argument_list|)
throw|;
block|}
block|}
block|}
end_class

end_unit

